<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Moga World</title>
<style>
html,body{margin:0;padding:0;height:100%;background:#0b1020;font-family:Arial,sans-serif;color:#e8e8e8;overflow:hidden;}
#wrap{display:flex;height:100%;}
#game{flex:1;position:relative;background:#0b1020;}
#ui{width:320px;border-left:1px solid rgba(255,255,255,.15);padding:10px;box-sizing:border-box;background:rgba(0,0,0,.5);overflow-y:auto;display:flex;flex-direction:column;gap:8px;}
.card{border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px;background:rgba(255,255,255,.05);}
.row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
button,input,select{border-radius:8px;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);color:#fff;padding:7px 10px;font-size:12px;}
button{cursor:pointer;}
button:hover{background:rgba(255,255,255,.16);}
button:disabled{opacity:.35;cursor:not-allowed;}
input{outline:none;}
#walletBar{background:linear-gradient(90deg,rgba(16,185,129,.12),rgba(96,165,250,.12));border:1px solid rgba(16,185,129,.28);border-radius:10px;padding:8px 10px;font-size:11px;display:flex;align-items:center;justify-content:space-between;gap:6px;}
#walletBar .waddr{font-family:monospace;color:#34d399;font-size:11px;}
#networkBadge{font-size:10px;padding:2px 8px;border-radius:999px;background:rgba(96,165,250,.2);border:1px solid rgba(96,165,250,.3);color:#93c5fd;white-space:nowrap;}
.stat{display:grid;grid-template-columns:1fr auto;gap:3px;font-size:12px;}
.pill{font-size:10px;padding:2px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);}
kbd{padding:1px 4px;border-radius:4px;border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.07);font-size:10px;}
.ebar{height:9px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);overflow:hidden;margin:2px 0;}
.ebar>div{height:100%;width:100%;background:rgba(34,197,94,.8);transition:width .2s;}
#log{height:110px;overflow:auto;font-size:11px;line-height:1.4;padding:7px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(255,255,255,.12);}
#log div{margin:2px 0;word-break:break-word;}
#loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;color:#fbbf24;z-index:100;text-align:center;}
#errOv{position:absolute;left:6px;bottom:6px;z-index:200;background:rgba(0,0,0,.75);border:1px solid rgba(255,100,100,.3);border-radius:8px;padding:8px 10px;max-width:600px;display:none;white-space:pre-wrap;font-size:11px;color:#fecaca;}
#minimap{position:absolute;right:6px;top:6px;width:170px;height:188px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.16);border-radius:10px;z-index:50;padding:7px;box-sizing:border-box;user-select:none;pointer-events:none;}
#minimap .mmtitle{font-size:10px;opacity:.9;display:flex;justify-content:space-between;margin-bottom:5px;}
#minimap canvas{width:100%;height:calc(100% - 34px);border-radius:7px;background:rgba(15,23,42,.35);border:1px solid rgba(255,255,255,.08);image-rendering:pixelated;}
#mmclock{margin-top:5px;font-size:10px;opacity:.82;display:flex;justify-content:space-between;}
#onlineBar{position:absolute;left:6px;top:6px;z-index:51;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.16);border-radius:8px;padding:5px 10px;font-size:11px;pointer-events:none;}
#sleepOv{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(2,6,23,.9);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;}
#sleepOv .zz{font-size:56px;}
#sleepOv .stxt{font-size:18px;color:#fbbf24;margin-top:12px;}
#sleepOv .spct{font-size:13px;color:#94a3b8;margin-top:6px;}
#buildPanel{display:none;}
/* Multiplier game */
#mulGraph{width:100%;height:72px;border-radius:7px;border:1px solid rgba(255,255,255,.12);background:#0f172a;}
.mulnum{font-size:28px;font-weight:bold;text-align:center;padding:5px 0;}
.mg{color:#22c55e;}.mr{color:#ef4444;}.my{color:#fbbf24;}
#mulPList{max-height:80px;overflow-y:auto;font-size:11px;}
.prow{display:flex;justify-content:space-between;padding:2px 3px;border-bottom:1px solid rgba(255,255,255,.05);}
.pc{color:#22c55e;}.pp{color:#fbbf24;}.pl{color:#ef4444;opacity:.6;}
/* item rows in building panels */
.irow{display:flex;justify-content:space-between;align-items:center;padding:6px 7px;border:1px solid rgba(255,255,255,.08);border-radius:7px;margin:4px 0;background:rgba(255,255,255,.03);}
.irow .ileft .iname{font-size:12px;font-weight:bold;}
.irow .ileft .idesc{font-size:10px;color:#94a3b8;}
.ibtn{padding:5px 9px;border-radius:6px;border:none;font-size:11px;cursor:pointer;white-space:nowrap;}
.btn-green{background:linear-gradient(90deg,#059669,#10b981);}
.btn-blue{background:linear-gradient(90deg,#0284c7,#0369a1);}
.btn-purple{background:linear-gradient(90deg,#7c3aed,#6d28d9);}
.btn-red{background:linear-gradient(90deg,#9f1239,#ef4444);}
.btn-yellow{background:rgba(251,191,36,.2);border:1px solid rgba(251,191,36,.3);color:#fbbf24;}
.btn-indigo{background:linear-gradient(90deg,#4338ca,#6366f1);}
.sitem{border:1px solid rgba(255,255,255,.1);border-radius:7px;padding:7px;margin:5px 0;background:rgba(255,255,255,.03);}
.sitem.learned{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);}
.btn-brown{background:linear-gradient(90deg,#78350f,#b45309);color:#fef3c7;}
.btn-teal{background:linear-gradient(90deg,#0f766e,#14b8a6);}
.lock-notice{background:rgba(239,68,68,.13);border:1px solid rgba(239,68,68,.28);border-radius:7px;padding:7px 9px;margin:5px 0;font-size:11px;color:#f87171;text-align:center;}
</style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="loading">Loading Moga World...</div>
    <div id="errOv"></div>
    <div id="onlineBar">ğŸ‘¥ Online: <span id="onlineCnt">0</span>/100</div>
    <div id="minimap">
      <div class="mmtitle"><span id="mmLoc">CITY</span><span id="mmTgt" style="opacity:.8;">â€”</span></div>
      <canvas id="mmC" width="128" height="128"></canvas>
      <div id="mmclock"><span id="tod">Day</span><span id="timeTxt">06:00</span></div>
    </div>
    <div id="sleepOv">
      <div class="zz">ğŸ˜´</div>
      <div class="stxt">Sleeping... zZz</div>
      <div class="spct" id="sleepPct">Energy: 0%</div>
    </div>
  </div>

  <aside id="ui">
    <div id="walletBar">
      <span>ğŸ”—</span>
      <span class="waddr" id="wAddr">Not connected</span>
      <span id="networkBadge">â€”</span>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>Moga World</strong>
        <span class="pill" id="modePill">CITY</span>
      </div>
      <small style="display:block;margin-top:5px;opacity:.7;font-size:10px;">
        Move: <kbd>WASD</kbd>/<kbd>â†‘â†“â†â†’</kbd> Â· Sprint: <kbd>Shift</kbd> Â· Enter/Exit: <strong>Tap/Click</strong>
      </small>
    </div>

    <div class="card stat">
      <div>Coins</div><div id="elCoins">100</div>
      <div>Job</div><div id="elJob">Unemployed</div>
      <div>House Lv</div><div id="elHouse">1</div>
      <div>Energy Max</div><div id="elEMax">100</div>
      <div>Nearest</div><div id="elNear" style="opacity:.7;">â€”</div>
      <div colspan="2" style="grid-column:1/-1;margin-top:4px;">
        <button id="btnInteract" onclick="triggerInteract()" style="width:100%;background:linear-gradient(90deg,#0ea5e9,#2563eb);border:none;padding:7px;border-radius:8px;font-size:12px;font-weight:bold;display:none;">
          ğŸ‘† Tap to Enter / Interact
        </button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;"><strong>Energy</strong><span id="elETxt">100/100</span></div>
      <div class="ebar"><div id="elEBar"></div></div>
    </div>

    <div class="card">
      <strong>Inventory</strong>
      <div id="elSkillBadges" style="margin-top:4px;font-size:11px;color:#22c55e;display:none;"></div>
      <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:4px;">
        <div class="pill">ğŸ <span id="elApple">1</span></div>
        <div class="pill">ğŸ¥¤ <span id="elSoda">0</span></div>
        <div class="pill">ğŸ¥ª <span id="elSand">0</span></div>
        <div class="pill" id="pillFish" style="display:none;">ğŸŸ <span id="elFish">0</span></div>
        <div class="pill" id="pillFruit" style="display:none;">ğŸ‡ <span id="elFruit">0</span></div>
        <div class="pill" id="pillRod" style="display:none;">ğŸ£ Rod âœ“</div>
        <div class="pill" id="pillBait" style="display:none;">ğŸª± Bait <span id="elBait">0</span></div>
        <div class="pill" id="pillCan" style="display:none;">ğŸª£ Can <span id="elCanState"></span></div>
        <div class="pill" id="pillHoe" style="display:none;">ğŸª“ Hoe âœ“</div>
        <div class="pill" id="pillSeeds" style="display:none;">ğŸŒ± Seeds <span id="elSeeds">0</span></div>
      </div>
      <div class="row" style="margin-top:6px;flex-wrap:wrap;">
        <button onclick="useItem('apple')">ğŸ Eat</button>
        <button onclick="useItem('soda')">ğŸ¥¤ Drink</button>
        <button onclick="useItem('sandwich')">ğŸ¥ª Eat</button>
        <button id="btnEatFish" onclick="useItem('fish')" style="display:none;">ğŸŸ Eat</button>
        <button id="btnEatFruit" onclick="useItem('fruit')" style="display:none;">ğŸ‡ Eat</button>
      </div>
      <div style="margin-top:5px;">
        <button id="btnHoe" onclick="hoeGround()" style="display:none;width:100%;padding:6px;border-radius:7px;border:none;font-size:11px;cursor:pointer;" class="btn-brown">ğŸª“ Hoe This Ground</button>
      </div>
    </div>

    <!-- Building-specific panel -->
    <div id="buildPanel" class="card"></div>

    <!-- Multiplier game panel (Casino) -->
    <div class="card" id="mulCard" style="display:none;">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <strong>ğŸ° Multiplier Game</strong>
        <span class="pill" id="mulRound">Round 1</span>
      </div>
      <canvas id="mulGraph"></canvas>
      <div class="mulnum mg" id="mulNum">1.00x</div>
      <div id="mulStatus" style="font-size:11px;text-align:center;color:#94a3b8;margin-bottom:6px;">Waiting...</div>
      <div class="row" style="margin-bottom:6px;">
        <input type="number" id="mulBetIn" value="10" min="5" style="flex:1;"/>
        <button id="btnJoin" onclick="mulJoin()" style="background:linear-gradient(90deg,#f59e0b,#d97706);border:none;">Join</button>
        <button id="btnCash" onclick="mulCashOut()" style="background:linear-gradient(90deg,#10b981,#059669);border:none;" disabled>Cash Out</button>
      </div>
      <div style="font-size:11px;color:#64748b;margin-bottom:4px;">Players this round:</div>
      <div id="mulPList"></div>
    </div>

    <div class="card">
      <strong>Navigate (CITY)</strong>
      <div class="row" style="margin-top:7px;">
        <select id="navSel" style="flex:1;"><option value="">Choose...</option></select>
        <button id="btnGo">Go</button>
        <button id="btnClear">âœ•</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <strong>ğŸ’¬ World Chat</strong>
        <span class="pill">ğŸ‘¥ <span id="onlineCnt2">0</span></span>
      </div>
      <div id="log"></div>
      <div class="row" style="margin-top:6px;">
        <input id="chatIn" placeholder="Messageâ€¦ or @Player private msg" style="flex:1;"/>
        <button id="btnSend">Send</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:5px;">
        <strong>ğŸ“¨ Players Online</strong>
        <span style="font-size:10px;color:#64748b;">click to PM</span>
      </div>
      <div id="pmList" style="max-height:90px;overflow-y:auto;font-size:11px;"></div>
    </div>

    <div class="card" id="txHistCard">
      <div class="row" style="justify-content:space-between;margin-bottom:5px;">
        <strong>ğŸ§¾ Tx History</strong>
        <button onclick="clearTxHistory()" style="font-size:10px;padding:2px 7px;opacity:.6;">Clear</button>
      </div>
      <div id="txHistList" style="max-height:110px;overflow-y:auto;font-size:10px;"></div>
    </div>
  </aside>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
<script>
(() => {
'use strict';
/* â”€â”€ Error overlay â”€â”€ */
const errOv=document.getElementById('errOv');
function showError(e){errOv.style.display='block';errOv.textContent=(e&&(e.stack||e.message))?e.stack||e.message:String(e);}
window.addEventListener('error',e=>showError(e.error||e.message));
window.addEventListener('unhandledrejection',e=>showError(e.reason));

/* â”€â”€ Constants â”€â”€ */
const TREASURY='0xa959f26847211f71A22aDb087EBe50E0743e7D66';
const USDC_BY_CHAIN={
  11155111:'0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8', // Sepolia
  84532:'0x036CbD53842c5426634e7929541eC2318f3dCF7e',    // Base Sepolia
};
const USDC_ABI=['function balanceOf(address) view returns (uint256)','function transfer(address,uint256) returns (bool)'];
const TILE=32,CW=96,CH=60,IW=34,IH=22,IDIST=135;

/* â”€â”€ Network & wallet â”€â”€ */
let walletAddress='';
let networkConfig={name:'Unknown',chainId:0,currency:'ETH',explorer:'https://etherscan.io'};
const params=new URLSearchParams(window.location.search);
walletAddress=params.get('wallet')||'';

function usdcAddress(){return USDC_BY_CHAIN[networkConfig.chainId]||null;}
function explorerTx(hash){return `${networkConfig.explorer}/tx/${hash}`;}

async function initChain(){
  if(!window.ethereum){
    logChat('[Wallet] No Web3 provider found. Install MetaMask to enable on-chain features.',false,'#f87171');
    return;
  }
  try{
    const prov=new ethers.providers.Web3Provider(window.ethereum);
    const net=await prov.getNetwork();
    networkConfig.chainId=net.chainId;
    const names={11155111:'ETH Sepolia',84532:'Base Sepolia',656476:'EDU Chain'};
    const curs={11155111:'ETH',84532:'ETH',656476:'EDU'};
    const exps={11155111:'https://sepolia.etherscan.io',84532:'https://sepolia.basescan.org',656476:'https://edu-chain-testnet.blockscout.com'};
    networkConfig.name=names[net.chainId]||`Chain ${net.chainId}`;
    networkConfig.currency=curs[net.chainId]||'ETH';
    networkConfig.explorer=exps[net.chainId]||'https://etherscan.io';
    if(!walletAddress){const accs=await prov.listAccounts();if(accs[0])walletAddress=accs[0].toLowerCase();}
    document.getElementById('networkBadge').textContent=networkConfig.name;
    document.getElementById('wAddr').textContent=walletAddress?walletAddress.slice(0,6)+'...'+walletAddress.slice(-4):'Not connected';
    loadTxHistory();renderTxHistory();
    window.ethereum.on('chainChanged',()=>initChain());
    window.ethereum.on('accountsChanged',a=>{walletAddress=a[0]?a[0].toLowerCase():'';initChain();});
  }catch(e){console.log('[chain]',e.message);}
}

window.addEventListener('message',ev=>{
  if(ev.data&&ev.data.type==='walletUpdate'){
    walletAddress=ev.data.address||'';
    document.getElementById('wAddr').textContent=walletAddress?walletAddress.slice(0,6)+'...'+walletAddress.slice(-4):'Not connected';
    loadTxHistory();renderTxHistory();
  }
  if(ev.data&&ev.data.type==='networkConfig')Object.assign(networkConfig,ev.data.config);
});

/* â”€â”€ Treasury transaction handlers â”€â”€
   All in-game financial flows are routed through the single TREASURY wallet
   on whichever EVM network the player's wallet is connected to.
   - treasuryPay    : player  â†’ treasury  (skill enroll, purchases, upgrades, bets)
   - treasurySalary : player claims salary; sends a proof-of-work tx to treasury so
                      the treasury can authorise and process the payout on-chain.
*/
async function treasuryPay(label,gameUsdAmt){
  if(!window.ethereum||!walletAddress){
    logChat('[Treasury] Wallet not connected â€“ connect first to pay.',false,'#f87171');return null;
  }
  // Amount: proportional to game-USD, minimum 0.000010 native token
  const nativeAmt=Math.max((gameUsdAmt||0)*GAME_USD_TO_NATIVE,0.00001).toFixed(8);
  const cur=networkConfig.currency||'ETH';
  const net=networkConfig.name||'Unknown Network';
  try{
    const provider=new ethers.providers.Web3Provider(window.ethereum);
    const signer=provider.getSigner();
    logChat('[Treasury] ğŸ” Sending '+nativeAmt+' '+cur+' â†’ Treasury on '+net+'â€¦',false,'#a78bfa');
    const tx=await signer.sendTransaction({to:TREASURY,value:ethers.utils.parseEther(nativeAmt)});
    saveTxRecord(tx.hash,label,nativeAmt,cur,net,'PAY');
    logChat('[Treasury] âœ… PAY:'+label+' | '+nativeAmt+' '+cur+' | <a href="'+explorerTx(tx.hash)+'" target="_blank">'+tx.hash.slice(0,14)+'â€¦</a>',false,'#34d399');
    return tx;
  }catch(e){
    logChat('[Treasury] âŒ Payment failed ('+net+'): '+e.message.slice(0,80),false,'#f87171');
    return null;
  }
}

async function treasurySalary(jobName,gameUsdAmt){
  if(!window.ethereum||!walletAddress){
    logChat('[Treasury] Wallet not connected â€“ salary claim skipped.',false,'#f87171');return null;
  }
  // Claim fee: small tx to treasury so it can record and process the salary disbursement
  const nativeAmt=SALARY_CLAIM_FEE.toFixed(8);
  const cur=networkConfig.currency||'ETH';
  const net=networkConfig.name||'Unknown Network';
  try{
    const provider=new ethers.providers.Web3Provider(window.ethereum);
    const signer=provider.getSigner();
    logChat('[Treasury] ğŸ¦ Claiming $'+gameUsdAmt+' salary ('+jobName+') on '+net+'â€¦',false,'#fbbf24');
    const tx=await signer.sendTransaction({to:TREASURY,value:ethers.utils.parseEther(nativeAmt)});
    saveTxRecord(tx.hash,'SALARY:'+jobName,nativeAmt,cur,net,'SALARY');
    logChat('[Treasury] âœ… SALARY:'+jobName+' +$'+gameUsdAmt+' USD | <a href="'+explorerTx(tx.hash)+'" target="_blank">'+tx.hash.slice(0,14)+'â€¦</a>',false,'#fbbf24');
    return tx;
  }catch(e){
    logChat('[Treasury] âŒ Salary claim failed ('+net+'): '+e.message.slice(0,80),false,'#f87171');
    return null;
  }
}

/* Backward-compat alias â€“ remaining callers (casino, vending) route through treasuryPay */
async function onChainTx(label,ethVal=0.00001){
  return treasuryPay(label,Math.round(ethVal/GAME_USD_TO_NATIVE));
}

/* â”€â”€ Transaction History â”€â”€
   Every confirmed on-chain tx hash is saved to localStorage so players
   can always verify their payments. Gas fees are part of each tx and
   land in the treasury wallet on the active network.
*/
let txHistory=[];
function txHistKey(){return'mogaTxHistory_'+(walletAddress||'guest');}
function loadTxHistory(){
  try{const raw=localStorage.getItem(txHistKey());if(raw)txHistory=JSON.parse(raw);}catch{}
}
loadTxHistory();

function saveTxRecord(hash,label,nativeAmt,currency,network,type){
  const rec={hash,label,nativeAmt,currency,network,type,ts:Date.now()};
  txHistory.unshift(rec);
  if(txHistory.length>TX_HISTORY_MAX)txHistory.length=TX_HISTORY_MAX;
  try{localStorage.setItem(txHistKey(),JSON.stringify(txHistory));}catch{}
  renderTxHistory();
}

function renderTxHistory(){
  const el=document.getElementById('txHistList');if(!el)return;
  if(!txHistory.length){el.innerHTML='<div style="color:#64748b;padding:4px;">No transactions yet.</div>';return;}
  el.innerHTML=txHistory.slice(0,TX_HISTORY_DISPLAY).map(r=>{
    const d=new Date(r.ts);
    const time=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const icon=r.type==='SALARY'?'ğŸ’°':r.type==='PAY'?'ğŸ’¸':'ğŸ°';
    const link=r.network&&explorerTx(r.hash);
    return`<div style="border-bottom:1px solid rgba(255,255,255,.07);padding:3px 0;">
<span style="color:#94a3b8;">${time}</span> ${icon}
<span style="color:#e2e8f0;">${r.label.slice(0,22)}</span>
<span style="color:#fbbf24;">${r.nativeAmt} ${r.currency}</span>
<a href="${link}" target="_blank" style="color:#60a5fa;font-size:9px;display:block;word-break:break-all;">${r.hash.slice(0,20)}â€¦</a></div>`;
  }).join('');
}

function clearTxHistory(){
  txHistory=[];
  try{localStorage.removeItem(txHistKey());}catch{}
  renderTxHistory();
}
window.clearTxHistory=clearTxHistory;

async function sendUSDCOnChain(to,amount){
  if(!window.ethereum||!walletAddress){logChat('[Bank] Connect wallet first.',false,'#f87171');return;}
  const addr=usdcAddress();
  if(!addr){logChat('[Bank] USDC not on this network.',false,'#f87171');return;}
  if(!ethers.utils.isAddress(to)){logChat('[Bank] Invalid address.',false,'#f87171');return;}
  const a=parseFloat(amount);if(isNaN(a)||a<=0){logChat('[Bank] Invalid amount.',false,'#f87171');return;}
  try{
    const signer=new ethers.providers.Web3Provider(window.ethereum).getSigner();
    const usdc=new ethers.Contract(addr,USDC_ABI,signer);
    const amtW=ethers.utils.parseUnits(String(a),6);
    logChat('[Bank] Sending '+a+' USDCâ€¦',false,'#fbbf24');
    const tx=await usdc.transfer(to,amtW);
    logChat('[Bank] âœ… Sent '+a+' USDC! TX: '+tx.hash.slice(0,12)+'â€¦',false,'#34d399');
    await refreshUSDCBalance();
  }catch(e){logChat('[Bank] '+e.message.slice(0,60),false,'#f87171');}
}
window.sendUSDCOnChain=sendUSDCOnChain;

async function refreshUSDCBalance(){
  const el=document.getElementById('usdcBal');if(!el)return;
  if(!window.ethereum||!walletAddress||!usdcAddress()){el.textContent='N/A';return;}
  try{
    const prov=new ethers.providers.Web3Provider(window.ethereum);
    const usdc=new ethers.Contract(usdcAddress(),USDC_ABI,prov);
    const b=await usdc.balanceOf(walletAddress);
    el.textContent=parseFloat(ethers.utils.formatUnits(b,6)).toFixed(4)+' USDC';
  }catch{el.textContent='Error';}
}
window.refreshUSDCBalance=refreshUSDCBalance;

/* â”€â”€ Skills â”€â”€ */
/* All skills cost 30 game-USD. Work pays 2 game-USD per 3-real-hour shift. */
const SKILL_COST_USD=30;          // game-USD per skill
const WORK_PAY_USD=2;             // game-USD per 3-real-hour shift
const WORK_CD_MS=10800000;        // 3 real hours in ms (3 * 3600 * 1000)
const SKILL_LEARN_MS=7200000;     // 2 real hours in ms (2 * 3600 * 1000)
const ENERGY_DRAIN_SEC=3600;      // energy fully drains after this many real seconds (1 hour)
const ENERGY_DRAIN_PASSIVE=100/ENERGY_DRAIN_SEC; // â‰ˆ0.0278 energy/sec while idle
const ENERGY_DRAIN_SPRINT=1.0;    // energy/sec while sprinting
const ENERGY_LOW_THRESHOLD=20;    // show warning / block work below this level
const NPC_MAX_WANDER=480;         // max pixel distance for random NPC wander target
/* Treasury payment rate: 1 game-USD = GAME_USD_TO_NATIVE native tokens */
const GAME_USD_TO_NATIVE=0.000003; // e.g. 30 USD â†’ 0.00009 ETH
const SALARY_CLAIM_FEE=0.00001;   // fixed native-token fee for salary claim tx
const TX_HISTORY_MAX=50;          // max tx records stored in localStorage
const TX_HISTORY_DISPLAY=10;      // max records shown in the UI
const ONLINE_PLAYERS_MIN=65;      // minimum simulated players online
const ONLINE_PLAYERS_MAX=84;      // starting maximum (hard cap is 100 slots)
const PM_LIST_MAX=8;              // players shown in the private-chat panel
const SKILLS=[
  {id:'basic',   name:'Basic Labor',   icon:'ğŸ”¨',cost:SKILL_COST_USD,time:SKILL_LEARN_MS,teacher:'Ms. Ana',    job:'Laborer',  wMin:WORK_PAY_USD,wMax:WORK_PAY_USD,cd:WORK_CD_MS},
  {id:'prog',    name:'Programming',   icon:'ğŸ’»',cost:SKILL_COST_USD,time:SKILL_LEARN_MS,teacher:'Mr. Budi',   job:'Developer',wMin:WORK_PAY_USD,wMax:WORK_PAY_USD,cd:WORK_CD_MS},
  {id:'biz',     name:'Business Mgmt', icon:'ğŸ“Š',cost:SKILL_COST_USD,time:SKILL_LEARN_MS,teacher:'Mr. Candra', job:'Manager',  wMin:WORK_PAY_USD,wMax:WORK_PAY_USD,cd:WORK_CD_MS},
  {id:'med',     name:'Medicine',      icon:'ğŸ¥',cost:SKILL_COST_USD,time:SKILL_LEARN_MS,teacher:'Dr. Dewi',   job:'Doctor',   wMin:WORK_PAY_USD,wMax:WORK_PAY_USD,cd:WORK_CD_MS},
  {id:'eng',     name:'Engineering',   icon:'âš™ï¸',cost:SKILL_COST_USD,time:SKILL_LEARN_MS,teacher:'Mr. Eko',    job:'Engineer', wMin:WORK_PAY_USD,wMax:WORK_PAY_USD,cd:WORK_CD_MS},
];
const workCDs={};
const COINS_TO_USDC=1; // 1 coin = 1 USD (game economy)
/* â”€â”€ New feature constants â”€â”€ */
const WORK_SESSION_MS=30000;     // 30s in-room lock after working
const FISHING_ROD_COST=15;       // fishing rod (one-time tool)
const BAIT_COST=3;               // bait pack (Ã—5 baits per purchase)
const WATERING_CAN_COST=8;       // watering can (one-time tool)
const HOE_COST=10;               // hoe/cangkul (one-time tool)
const SEED_COST=5;               // seeds Ã—3 per purchase
const SEED_GROW_MS=120000;       // 2 min from watering to harvest
const FISH_ENERGY=25;            // energy restored by eating fish
const FRUIT_ENERGY=35;           // energy restored by eating fruit
const FISH_SELL_PRICE=5;         // coins per fish sold
const FRUIT_SELL_PRICE=4;        // coins per fruit sold
const HOE_ENERGY_COST=8;         // energy cost to hoe ground
const FISH_ENERGY_COST=5;        // energy cost per fishing attempt
const FISH_MISS_RATE=0.15;       // 15% chance of catching nothing
const NPC_FARM_MSG_MS=45000;     // ms interval for NPC farming chat messages
const NPC_FARM_MSG_CHANCE=0.5;   // probability of NPC farm message firing each interval
/* NPC farm zones (visual only â€“ other players' plots, not interactable) */
const _npcPlots=[
  {tx:34,ty:50,state:'watered',owner:'MogaCat42',readyAt:Date.now()+90000},
  {tx:35,ty:50,state:'seeded', owner:'MogaCat42',readyAt:0},
  {tx:34,ty:51,state:'hoed',   owner:'MogaCat42',readyAt:0},
  {tx:50,ty:52,state:'ready',  owner:'PlumeWolf17',readyAt:0},
  {tx:51,ty:52,state:'watered',owner:'PlumeWolf17',readyAt:Date.now()+60000},
  {tx:20,ty:52,state:'seeded', owner:'StarBear99',readyAt:0},
  {tx:21,ty:52,state:'ready',  owner:'StarBear99',readyAt:0},
  {tx:22,ty:52,state:'hoed',   owner:'StarBear99',readyAt:0},
];

/* â”€â”€ Player state â”€â”€ */
const S={
  coins:100, learnedSkills:[], learningId:null, learningEndTime:0,
  workLockId:null, workLockEnd:0,
  job:'Unemployed', energy:100, energyMax:100,
  house:1, sleeping:false,
  inv:{apple:1,soda:0,sandwich:0,fishingRod:0,bait:0,wateringCan:0,hoe:0,seeds:0,fish:0,fruit:0},
  waterFull:false,
  plots:[], // [{tx,ty,state:'hoed'|'seeded'|'watered'|'ready',plantedAt,readyAt}]
};

/* â”€â”€ World state â”€â”€ */
const WS={zone:'CITY',key:'',savedPos:{x:32*TILE,y:32*TILE},outdoor:null};

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const reqEnergy=(n,msg)=>{if(S.energy<n){logChat(msg||'[info] Low energy.',false,'#f87171');return false;}S.energy-=n;return true;};

function updateHUD(){
  document.getElementById('elCoins').textContent=S.coins;
  document.getElementById('elJob').textContent=S.job;
  document.getElementById('elHouse').textContent=S.house;
  document.getElementById('elEMax').textContent=S.energyMax;
  document.getElementById('elApple').textContent=S.inv.apple;
  document.getElementById('elSoda').textContent=S.inv.soda;
  document.getElementById('elSand').textContent=S.inv.sandwich;
  S.energy=clamp(S.energy,0,S.energyMax);
  const pct=(S.energy/S.energyMax)*100;
  document.getElementById('elETxt').textContent=`${Math.round(S.energy)}/${S.energyMax}`;
  document.getElementById('elEBar').style.width=pct+'%';
  document.getElementById('elEBar').style.background=pct>50?'rgba(34,197,94,.8)':pct>20?'rgba(251,191,36,.85)':'rgba(239,68,68,.9)';
  const lbl=WS.zone==='CITY'?'CITY':WS.key.toUpperCase();
  document.getElementById('modePill').textContent=lbl;
  document.getElementById('mmLoc').textContent=lbl;
  document.getElementById('mulCard').style.display=(WS.zone==='INTERIOR'&&WS.key==='Casino')?'block':'none';
  /* new inventory items */
  const setVis=(id,show)=>{const e=document.getElementById(id);if(e)e.style.display=show?'':'none';};
  setVis('pillFish',S.inv.fish>0);if(S.inv.fish>0)document.getElementById('elFish').textContent=S.inv.fish;
  setVis('pillFruit',S.inv.fruit>0);if(S.inv.fruit>0)document.getElementById('elFruit').textContent=S.inv.fruit;
  setVis('pillRod',S.inv.fishingRod>0);
  setVis('pillBait',S.inv.fishingRod>0);if(S.inv.fishingRod>0)document.getElementById('elBait').textContent=S.inv.bait;
  setVis('pillCan',S.inv.wateringCan>0);if(S.inv.wateringCan>0)document.getElementById('elCanState').textContent=S.waterFull?'ğŸ’§':'âˆ…';
  setVis('pillHoe',S.inv.hoe>0);
  setVis('pillSeeds',S.inv.seeds>0);if(S.inv.seeds>0)document.getElementById('elSeeds').textContent=S.inv.seeds;
  setVis('btnEatFish',S.inv.fish>0);
  setVis('btnEatFruit',S.inv.fruit>0);
  /* skill badges */
  const sb=document.getElementById('elSkillBadges');
  if(sb){
    if(S.learnedSkills.length){
      sb.innerHTML='âœ… Skills: '+S.learnedSkills.map(id=>{const sk=SKILLS.find(s=>s.id===id);return sk?sk.icon+' '+sk.name:'';}).join(' Â· ');
      sb.style.display='block';
    }else{sb.innerHTML='';sb.style.display='none';}
  }
  updateOnlineCount();
}

/* â”€â”€ World state â”€â”€ */
const NAV={key:'',pos:null};
const CLK={min:6*60,speed:10};
function fmtTime(m){const h=Math.floor(m/60)%24,mm=Math.floor(m%60);return String(h).padStart(2,'0')+':'+String(mm).padStart(2,'0');}

/* â”€â”€ Log / Chat â”€â”€ */
function logChat(text,isMe=false,color=''){
  const el=document.getElementById('log');
  const d=document.createElement('div');
  const esc=text.replace(/[<>&"']/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[c]));
  d.innerHTML=color?`<span style="color:${color}">${esc}</span>`:esc;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
  while(el.children.length>100)el.removeChild(el.firstChild);
}

/* â”€â”€ Building panel renderers â”€â”€ */
function renderBuildingPanel(){
  const panel=document.getElementById('buildPanel');
  if(WS.outdoor==='Vending'){panel.style.display='block';panel.innerHTML=renderVending();return;}
  if(WS.outdoor==='River'){panel.style.display='block';panel.innerHTML=renderRiver();return;}
  if(WS.outdoor==='Farm'){panel.style.display='block';panel.innerHTML=renderFarm();return;}
  if(WS.outdoor){panel.style.display='block';panel.innerHTML=renderVending();return;}
  if(WS.zone!=='INTERIOR'){panel.style.display='none';return;}
  panel.style.display='block';
  const r={House:renderHome,School:renderSchool,'Job Center':renderJobBoard,Bank:renderBank,Cafe:renderCafe,Market:renderMarket,Gym:renderGym,Hospital:renderHospital,Library:renderLibrary,Office:renderOffice,'Town Hall':renderTownHall};
  if(r[WS.key])panel.innerHTML=r[WS.key]();
  else panel.style.display='none';
}

function renderHome(){
  const uc=25*S.house;
  return`<strong>ğŸ  Home</strong>
<div style="font-size:11px;color:#94a3b8;margin:5px 0;">Energy: ${Math.round(S.energy)}/${S.energyMax}</div>
<div style="border:1px solid rgba(99,102,241,.35);border-radius:8px;padding:9px;margin:5px 0;background:rgba(99,102,241,.06);">
  <div style="font-size:12px;font-weight:bold;margin-bottom:6px;">ğŸ›ï¸ Bedroom â€” Click the Bed to Sleep</div>
  <button onclick="sleepAtHome()" ${S.sleeping||S.energy>=S.energyMax?'disabled':''} style="width:100%;padding:8px;border-radius:7px;border:none;background:linear-gradient(90deg,#1d4ed8,#3b82f6);color:white;font-size:12px;cursor:pointer;">
    ${S.sleeping?'ğŸ˜´ Sleepingâ€¦ (8-hour rest)':S.energy>=S.energyMax?'âœ… Fully Rested':'ğŸ˜´ Sleep in Bed (Restore Full Energy)'}
  </button>
  <div style="font-size:10px;color:#64748b;margin-top:4px;">Sleep for 8 game-hours to fully restore energy</div>
</div>
<div style="border-top:1px solid rgba(255,255,255,.1);margin-top:9px;padding-top:9px;">
  <div style="font-size:11px;color:#64748b;">House Lv ${S.house} Â· Upgrade: +5 max energy</div>
  <button onclick="upgradeHouse()" ${S.coins<uc?'disabled':''} class="btn-yellow" style="width:100%;margin-top:5px;padding:7px;border-radius:7px;font-size:11px;cursor:pointer;">
    Upgrade (${uc} USD)
  </button>
</div>`;
}

function renderSchool(){
  let h=`<strong>ğŸ« Skill Shop</strong><div style="font-size:10px;color:#94a3b8;margin:4px 0;">Pay $30 game-USD on-chain â†’ gain skill (2h) â†’ work 3h â†’ earn $2 game-USD</div>`;
  const lockRem=S.learningEndTime>Date.now()?S.learningEndTime-Date.now():0;
  if(lockRem>0)h+=`<div class="lock-notice">âš ï¸ Learning in progress â€” cannot leave! â³ ${fmtCountdown(lockRem)} remaining</div>`;
  for(const sk of SKILLS){
    const l=S.learnedSkills.includes(sk.id),a=S.coins>=sk.cost,li=S.learningId===sk.id;
    let action;
    if(l){action='<div style="font-size:10px;color:#22c55e;margin-top:3px;text-align:center;">âœ… Skill acquired</div>';}
    else if(li){action=`<div style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);border-radius:6px;padding:6px;margin-top:5px;font-size:11px;text-align:center;color:#fbbf24;">ğŸ“– Learningâ€¦ â³ ${fmtCountdown(S.learningEndTime-Date.now())}<br><span style="font-size:10px;color:#f87171;">Cannot leave building!</span></div>`;}
    else{action=`<button onclick="learnSkill('${sk.id}')" ${!a?'disabled':''} class="ibtn btn-purple" style="width:100%;margin-top:5px;">${!a?'Need $'+(sk.cost-S.coins)+' more':'Enroll ($'+sk.cost+' USD on-chain)'}</button>`;}
    h+=`<div class="sitem${l?' learned':''}">
<div style="display:flex;justify-content:space-between;"><strong style="font-size:12px;">${sk.icon} ${sk.name}</strong>
<span style="font-size:10px;color:${l?'#22c55e':a?'#fbbf24':'#ef4444'};">${l?'âœ…':'$'+sk.cost+' USD'}</span></div>
<div style="font-size:10px;color:#64748b;">ğŸ‘¨â€ğŸ« ${sk.teacher} Â· ${sk.job}: $${sk.wMin} USD/shift</div>
${action}</div>`;
  }
  return h;
}

function renderJobBoard(){
  let h=`<strong>ğŸ’¼ Job Board</strong>`;
  if(S.workLockEnd>Date.now()){const rem=Math.ceil((S.workLockEnd-Date.now())/1000);h+=`<div class="lock-notice">âš ï¸ Work session active â€” cannot leave! â³ ${rem}s remaining</div>`;}
  if(!S.learnedSkills.length)return h+`<div style="color:#94a3b8;font-size:11px;margin:10px 0;text-align:center;">No skills. Visit School first.</div>`;
  const now=Date.now();
  for(const id of S.learnedSkills){
    const sk=SKILLS.find(s=>s.id===id);if(!sk)continue;
    const cd=sk.cd||WORK_CD_MS,lw=workCDs[id]||0,oc=(now-lw)<cd,cl=oc?Math.ceil((cd-(now-lw))/1000):0;
    const clFmt=oc?(cl>3600?Math.ceil(cl/3600)+'h':cl>60?Math.ceil(cl/60)+'m':cl+'s'):'';
    h+=`<div class="irow"><div class="ileft"><div class="iname">${sk.icon} ${sk.job}</div>
<div class="idesc">Pay: $${sk.wMin} USD Â· âˆ’${ENERGY_LOW_THRESHOLD} energy Â· 3h shift${oc?' Â· â³'+clFmt:''}</div></div>
<button onclick="workJob('${id}')" ${S.energy<ENERGY_LOW_THRESHOLD||oc?'disabled':''} class="ibtn btn-blue">
  ${oc?clFmt:S.energy<ENERGY_LOW_THRESHOLD?'âš¡Low':'Work'}
</button></div>`;
  }
  return h;
}

function renderBank(){
  return`<strong>ğŸ¦ Bank</strong>
<div style="font-size:11px;color:#94a3b8;margin:5px 0;">On-chain USDC: <span id="usdcBal" style="color:#22c55e;">â€”</span>
 <button onclick="refreshUSDCBalance()" style="font-size:9px;padding:2px 5px;margin-left:4px;">â†º</button></div>
<div style="border-top:1px solid rgba(255,255,255,.1);margin-top:6px;padding-top:8px;">
<div style="font-size:11px;color:#fbbf24;margin-bottom:5px;">ğŸ’¸ Send USDC to player</div>
<input id="bkTo" placeholder="Recipient address (0xâ€¦)" style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:#0f172a;color:white;font-size:11px;margin-bottom:5px;box-sizing:border-box;"/>
<input id="bkAmt" type="number" placeholder="Amount USDC" min="0.01" step="0.01" style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:#0f172a;color:white;font-size:11px;margin-bottom:7px;box-sizing:border-box;"/>
<button onclick="sendUSDCOnChain(document.getElementById('bkTo').value,document.getElementById('bkAmt').value)" class="ibtn btn-green" style="width:100%;padding:8px;">Send USDC ğŸš€</button>
</div>
<div style="border-top:1px solid rgba(255,255,255,.1);margin-top:8px;padding-top:8px;font-size:10px;color:#64748b;">
Wallet: ${S.coins} USD in game
</div>`;
}

function renderCafe(){
  const items=[{id:'coffee',n:'Espresso â˜•',c:5,e:40},{id:'cake',n:'Cake Slice ğŸ°',c:8,e:35},{id:'meal',n:'Full Meal ğŸ±',c:12,e:55}];
  let h=`<strong>â˜• Cafe Menu</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">Restore energy</div>`;
  for(const it of items)h+=`<div class="irow"><div class="ileft"><div class="iname">${it.n}</div><div class="idesc">+${it.e} energy Â· ${it.c} coins</div></div>
<button onclick="buyFood('cafe','${it.id}',${it.c},${it.e},0)" ${S.coins<it.c?'disabled':''} class="ibtn btn-green">Buy</button></div>`;
  return h;
}

function renderMarket(){
  let h=`<strong>ğŸ›’ Market</strong>`;
  /* Food */
  h+=`<div style="font-size:10px;color:#fbbf24;font-weight:bold;margin:5px 0 3px;">ğŸ± Food</div>`;
  const food=[{id:'apple',n:'Apple ğŸ',c:3,inv:'apple'},{id:'sand',n:'Sandwich ğŸ¥ª',c:6,inv:'sandwich'},{id:'drink',n:'Energy Drink âš¡',c:5,inv:'soda'}];
  for(const it of food)h+=`<div class="irow"><div class="ileft"><div class="iname">${it.n}</div><div class="idesc">+1 inventory Â· ${it.c} coins</div></div>
<button onclick="buyFood('market','${it.id}',${it.c},0,'${it.inv}')" ${S.coins<it.c?'disabled':''} class="ibtn btn-red" style="background:linear-gradient(90deg,#be185d,#f472b6);">Buy</button></div>`;
  /* Tools & Supplies */
  h+=`<div style="font-size:10px;color:#38bdf8;font-weight:bold;margin:7px 0 3px;">ğŸ› ï¸ Tools &amp; Supplies</div>`;
  h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ£ Fishing Rod</div>
<div class="idesc">${S.inv.fishingRod?'âœ… Owned':'One-time Â· $'+FISHING_ROD_COST+' USD on-chain'}</div></div>
<button onclick="buyTool('fishingRod',${FISHING_ROD_COST})" ${S.coins<FISHING_ROD_COST||S.inv.fishingRod?'disabled':''} class="ibtn btn-blue">${S.inv.fishingRod?'Owned':'Buy'}</button></div>`;
  h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸª± Bait Ã—5</div>
<div class="idesc">Consumable Â· $${BAIT_COST} USD on-chain Â· ${S.inv.bait} in stock</div></div>
<button onclick="buyTool('bait',${BAIT_COST})" ${S.coins<BAIT_COST?'disabled':''} class="ibtn btn-blue">Buy Ã—5</button></div>`;
  h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸª£ Watering Can</div>
<div class="idesc">${S.inv.wateringCan?'âœ… Owned':'One-time Â· $'+WATERING_CAN_COST+' USD on-chain'}</div></div>
<button onclick="buyTool('wateringCan',${WATERING_CAN_COST})" ${S.coins<WATERING_CAN_COST||S.inv.wateringCan?'disabled':''} class="ibtn btn-teal">${S.inv.wateringCan?'Owned':'Buy'}</button></div>`;
  h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸª“ Hoe (Cangkul)</div>
<div class="idesc">${S.inv.hoe?'âœ… Owned':'One-time Â· $'+HOE_COST+' USD on-chain'}</div></div>
<button onclick="buyTool('hoe',${HOE_COST})" ${S.coins<HOE_COST||S.inv.hoe?'disabled':''} class="ibtn btn-brown">${S.inv.hoe?'Owned':'Buy'}</button></div>`;
  h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸŒ± Seeds Ã—3</div>
<div class="idesc">Plant on hoed ground Â· $${SEED_COST} USD on-chain Â· ${S.inv.seeds} in stock</div></div>
<button onclick="buyTool('seeds',${SEED_COST})" ${S.coins<SEED_COST?'disabled':''} class="ibtn btn-green">Buy Ã—3</button></div>`;
  /* Sell */
  if(S.inv.fish>0||S.inv.fruit>0){
    h+=`<div style="font-size:10px;color:#4ade80;font-weight:bold;margin:7px 0 3px;">ğŸ’° Sell (on-chain)</div>`;
    if(S.inv.fish>0)h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸŸ Sell Fish</div>
<div class="idesc">Ã—${S.inv.fish} available Â· +$${FISH_SELL_PRICE} USD each</div></div>
<button onclick="sellItem('fish')" class="ibtn btn-green">Sell 1</button></div>`;
    if(S.inv.fruit>0)h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ‡ Sell Fruit</div>
<div class="idesc">Ã—${S.inv.fruit} available Â· +$${FRUIT_SELL_PRICE} USD each</div></div>
<button onclick="sellItem('fruit')" class="ibtn btn-green">Sell 1</button></div>`;
  }
  return h;
}

function renderGym(){
  return`<strong>ğŸ‹ï¸ Gym</strong>
<div class="irow"><div class="ileft"><div class="iname">Workout ğŸ’ª</div><div class="idesc">+5 energy max Â· âˆ’20 energy Â· 12 coins</div></div>
<button onclick="gymTrain()" ${S.energy<20||S.coins<12?'disabled':''} class="ibtn btn-red">Train</button></div>
<div class="irow"><div class="ileft"><div class="iname">Protein Shake ğŸ¥¤</div><div class="idesc">+35 energy Â· 10 coins</div></div>
<button onclick="buyFood('gym','shake',10,35,0)" ${S.coins<10?'disabled':''} class="ibtn btn-red">Buy</button></div>`;
}

function renderHospital(){
  return`<strong>ğŸ¥ Hospital</strong>
<div class="irow"><div class="ileft"><div class="iname">Basic Care ğŸ’Š</div><div class="idesc">Full energy restore Â· 10 coins</div></div>
<button onclick="heal('basic')" ${S.coins<10?'disabled':''} class="ibtn btn-red">Treat</button></div>
<div class="irow"><div class="ileft"><div class="iname">Premium Care âš•ï¸</div><div class="idesc">Full energy + max+5 Â· 20 coins</div></div>
<button onclick="heal('premium')" ${S.coins<20?'disabled':''} class="ibtn btn-red">Premium</button></div>`;
}

function renderLibrary(){
  let h=`<strong>ğŸ“š Library</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">Fast-track (1.5Ã— cost, 1h instead of 2h)</div>`;
  const lockRem=S.learningEndTime>Date.now()?S.learningEndTime-Date.now():0;
  if(lockRem>0)h+=`<div class="lock-notice">âš ï¸ Learning in progress â€” cannot leave! â³ ${fmtCountdown(lockRem)} remaining</div>`;
  for(const sk of SKILLS){
    const l=S.learnedSkills.includes(sk.id),fc=Math.ceil(sk.cost*1.5),a=S.coins>=fc,li=S.learningId===sk.id;
    let action;
    if(l){action='';}
    else if(li){action=`<div style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);border-radius:6px;padding:6px;margin-top:4px;font-size:11px;text-align:center;color:#fbbf24;">ğŸ“– Fast-trackâ€¦ â³ ${fmtCountdown(S.learningEndTime-Date.now())}<br><span style="font-size:10px;color:#f87171;">Cannot leave building!</span></div>`;}
    else{action=`<button onclick="learnSkillFast('${sk.id}')" ${!a?'disabled':''} class="ibtn btn-indigo" style="width:100%;margin-top:4px;">Fast-track ($${fc} USD on-chain)</button>`;}
    h+=`<div class="sitem${l?' learned':''}">
<div style="display:flex;justify-content:space-between;"><span style="font-size:12px;font-weight:bold;">${sk.icon} ${sk.name}</span>
<span style="font-size:10px;color:${l?'#22c55e':'#fbbf24'};">${l?'âœ…':'$'+fc+' USD'}</span></div>
<div style="font-size:10px;color:#64748b;">${sk.job} Â· ${sk.time/3600000}h â†’ 1h fast</div>
${action}</div>`;
  }
  return h;
}

function renderOffice(){
  const now=Date.now();
  let h=`<strong>ğŸ¢ Office</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">Freelance work available â€” 3-hour shifts</div>`;
  if(S.workLockEnd>Date.now()){const rem=Math.ceil((S.workLockEnd-Date.now())/1000);h+=`<div class="lock-notice">âš ï¸ Work session active â€” cannot leave! â³ ${rem}s remaining</div>`;}
  if(!S.learnedSkills.length)return h+`<div style="color:#94a3b8;font-size:11px;margin:10px 0;text-align:center;">No skills. Visit School first.</div>`;
  for(const id of S.learnedSkills){
    const sk=SKILLS.find(s=>s.id===id);if(!sk)continue;
    const cd=sk.cd||WORK_CD_MS,lw=workCDs[id]||0,oc=(now-lw)<cd,cl=oc?Math.ceil((cd-(now-lw))/1000):0;
    const clFmt=oc?(cl>3600?Math.ceil(cl/3600)+'h':cl>60?Math.ceil(cl/60)+'m':cl+'s'):'';
    h+=`<div class="irow"><div class="ileft"><div class="iname">${sk.icon} ${sk.job} (Freelance)</div>
<div class="idesc">$${sk.wMin} USD Â· âˆ’${ENERGY_LOW_THRESHOLD} energy Â· 3h${oc?' Â· â³'+clFmt:''}</div></div>
<button onclick="workJob('${id}')" ${S.energy<ENERGY_LOW_THRESHOLD||oc?'disabled':''} class="ibtn btn-blue">
  ${oc?clFmt:S.energy<ENERGY_LOW_THRESHOLD?'âš¡Low':'Work'}
</button></div>`;
  }
  return h;
}

function renderTownHall(){
  return`<strong>ğŸ›ï¸ Town Hall</strong>
<div style="font-size:11px;color:#94a3b8;margin:5px 0;">Community hub for Moga City residents</div>
<div class="irow"><div class="ileft"><div class="iname">ğŸ“Š My Stats</div>
<div class="idesc">Skills: ${S.learnedSkills.length} Â· Job: ${S.job} Â· House Lv ${S.house}</div></div></div>
<div class="irow"><div class="ileft"><div class="iname">ğŸ’¾ Save Progress</div>
<div class="idesc">Save to ${walletAddress?walletAddress.slice(0,8)+'â€¦':'local storage'}</div></div>
<button onclick="saveProgress();logChat('[Town Hall] ğŸ’¾ Progress saved!',false,'#34d399');" class="ibtn btn-green">Save</button></div>
<div style="font-size:10px;color:#64748b;margin-top:8px;padding:6px;border-radius:6px;background:rgba(255,255,255,.03);">
  ğŸ’¡ All game progress is auto-saved every 30 seconds and on every major action. Progress persists across sessions.
</div>`;
}

/* â”€â”€ Economy actions â”€â”€ */
function learnSkill(id){
  const sk=SKILLS.find(s=>s.id===id);if(!sk)return;
  if(S.learnedSkills.includes(id))return logChat('[School] Already know '+sk.name+'.');
  if(S.coins<sk.cost)return logChat('[School] Need $'+sk.cost+' USD for '+sk.name+'.');
  S.coins-=sk.cost;S.learningId=id;S.learningEndTime=Date.now()+sk.time;updateHUD();renderBuildingPanel();
  logChat('[School] ğŸ“š Enrolling in '+sk.name+'â€¦ ($'+sk.cost+' USD â†’ Treasury)',false,'#a78bfa');
  treasuryPay('SCHOOL:'+id,sk.cost);
  saveProgress();
  setTimeout(()=>{
    S.learnedSkills.push(id);S.learningId=null;S.learningEndTime=0;S.job=sk.job;
    updateHUD();renderBuildingPanel();
    logChat('[School] âœ… Graduated: '+sk.name+'! '+sk.job+' job unlocked.',false,'#22c55e');
    saveProgress();
  },sk.time);
}
window.learnSkill=learnSkill;

function learnSkillFast(id){
  const sk=SKILLS.find(s=>s.id===id);if(!sk)return;
  if(S.learnedSkills.includes(id))return logChat('[Library] Already know '+sk.name+'.');
  const fc=Math.ceil(sk.cost*1.5);
  if(S.coins<fc)return logChat('[Library] Need $'+fc+' USD.');
  S.coins-=fc;S.learningId=id;S.learningEndTime=Date.now()+sk.time/2;updateHUD();renderBuildingPanel();
  logChat('[Library] ğŸ“š Fast-track '+sk.name+'â€¦ ($'+fc+' USD â†’ Treasury)',false,'#818cf8');
  treasuryPay('LIB:'+id,fc);
  saveProgress();
  setTimeout(()=>{
    S.learnedSkills.push(id);S.learningId=null;S.learningEndTime=0;S.job=sk.job;
    updateHUD();renderBuildingPanel();
    logChat('[Library] âœ… Graduated fast: '+sk.name+'!',false,'#22c55e');
    saveProgress();
  },sk.time/2);
}
window.learnSkillFast=learnSkillFast;

function workJob(id){
  const sk=SKILLS.find(s=>s.id===id);if(!sk)return;
  const now=Date.now(),lw=workCDs[id]||0,cd=sk.cd||WORK_CD_MS;
  if(now-lw<cd){const rem=Math.ceil((cd-(now-lw))/1000);return logChat('[Job] On cooldown: '+(rem>3600?Math.ceil(rem/3600)+'h':rem>60?Math.ceil(rem/60)+'m':rem+'s')+' left (3h shift)');}
  if(S.energy<ENERGY_LOW_THRESHOLD)return logChat('[Job] Need '+ENERGY_LOW_THRESHOLD+' energy to work a 3-hour shift.');
  S.energy=clamp(S.energy-ENERGY_LOW_THRESHOLD,0,S.energyMax);
  workCDs[id]=now;S.workLockId=id;S.workLockEnd=now+WORK_SESSION_MS;
  S.coins+=sk.wMin;
  updateHUD();renderBuildingPanel();
  logChat('[Job] ğŸ’° Started 3h shift as '+sk.job+': +$'+sk.wMin+' USD! Stay for '+Math.round(WORK_SESSION_MS/1000)+'s.',false,'#fbbf24');
  setTimeout(()=>{S.workLockId=null;S.workLockEnd=0;renderBuildingPanel();logChat('[Job] âœ… Work session done. You may leave.',false,'#22c55e');saveProgress();},WORK_SESSION_MS);
  treasurySalary(sk.job,sk.wMin);
  saveProgress();
}
window.workJob=workJob;

function buyFood(bld,id,cost,energy,inv){
  if(S.coins<cost)return logChat('['+bld+'] Need '+cost+' coins.');
  S.coins-=cost;
  if(inv){S.inv[inv]=(S.inv[inv]||0)+1;logChat('['+bld+'] Got item (+1 inventory).',false,'#a3e635');}
  else{S.energy=clamp(S.energy+energy,0,S.energyMax);logChat('['+bld+'] +'+energy+' energy.',false,'#34d399');}
  onChainTx('BUY:'+bld+':'+id+':$'+cost+'USD',0.00001);
  updateHUD();renderBuildingPanel();
  saveProgress();
}
window.buyFood=buyFood;

function useItem(type){
  const en={apple:30,soda:20,sandwich:45,fish:FISH_ENERGY,fruit:FRUIT_ENERGY};
  if(!S.inv[type]||S.inv[type]<=0)return logChat('[Inventory] No '+type+'.');
  S.inv[type]--;S.energy=clamp(S.energy+en[type],0,S.energyMax);
  updateHUD();logChat('[Inventory] Used '+type+': +'+en[type]+' energy.',false,'#34d399');
  saveProgress();
}
window.useItem=useItem;

function sleepAtHome(){
  if(S.sleeping||S.energy>=S.energyMax)return;
  S.sleeping=true;updateHUD();renderBuildingPanel();
  const ov=document.getElementById('sleepOv');ov.style.display='flex';
  // Sleep for 8 game-hours: 20 steps Ã— 500ms = 10 real seconds (simulated 8h)
  const target=S.energyMax,steps=20,gain=(target-S.energy)/steps;
  let i=0;
  const t=setInterval(()=>{
    i++;S.energy=clamp(S.energy+gain,0,S.energyMax);
    document.getElementById('sleepPct').textContent='Energy: '+Math.round((S.energy/S.energyMax)*100)+'% (restoringâ€¦)';
    if(i>=steps){clearInterval(t);S.energy=S.energyMax;S.sleeping=false;ov.style.display='none';updateHUD();renderBuildingPanel();logChat('[Home] ğŸŒ… Woke up refreshed! Full energy restored.',false,'#fbbf24');saveProgress();}
  },500);
}
window.sleepAtHome=sleepAtHome;

function upgradeHouse(){
  const c=25*S.house;if(S.coins<c)return logChat('[Home] Need $'+c+' USD.');
  S.coins-=c;S.house++;S.energyMax+=5;S.energy=clamp(S.energy+5,0,S.energyMax);
  onChainTx('HOME:UPGRADE:Lv'+S.house+':$'+c+'USD',0.00001);
  updateHUD();renderBuildingPanel();logChat('[Home] ğŸ  Upgraded to Lv '+S.house+'! +5 max energy.',false,'#fbbf24');
  saveProgress();
}
window.upgradeHouse=upgradeHouse;

function gymTrain(){
  if(S.coins<12)return logChat('[Gym] Need 12 coins.');
  if(!reqEnergy(20,'[Gym] Need 20 energy.'))return;
  S.coins-=12;S.energyMax+=5;
  onChainTx('GYM:TRAIN:$12USD',0.00001);
  updateHUD();renderBuildingPanel();
  logChat('[Gym] ğŸ’ª Trained! +5 max energy.',false,'#f87171');
  saveProgress();
}
window.gymTrain=gymTrain;

function heal(level){
  const costs={basic:10,premium:20};const c=costs[level];
  if(S.coins<c)return logChat('[Hospital] Need '+c+' coins.');
  S.coins-=c;S.energy=S.energyMax;
  if(level==='premium')S.energyMax+=5;
  onChainTx('HOSPITAL:'+level+':$'+c+'USD',0.00001);
  updateHUD();renderBuildingPanel();
  logChat('[Hospital] '+( level==='premium'?'âš•ï¸ Premium':'ğŸ’Š Basic')+' care done. Full energy!',false,'#34d399');
  saveProgress();
}
window.heal=heal;

function convertCoins(){
  logChat('[Bank] Balance: $'+S.coins+' USD in game wallet.',false,'#fbbf24');
}
window.convertCoins=convertCoins;

/* â”€â”€ 100-player pool â”€â”€ */
const PPOOL=(()=>{
  const pf=['Moga','Plume','Tiger','Neon','Crypto','Star','Moon','Fire','Ice','Gold','Sky','Deep','Wild','Cyber','Pixel','Dark','Bright','Swift','Sharp','Zen'];
  const ps=['Cat','Fox','Wolf','Bear','Eagle','Shark','Lion','Panda','Dragon','Whale','Hawk','Owl','Raven','Titan','Storm','Flash','Blade','Ghost','Pulse','Wave'];
  return Array.from({length:100},(_,i)=>{
    const n=pf[i%pf.length]+ps[Math.floor(i/pf.length)%ps.length]+(10+(i*7+13)%90);
    const st=i%3===0?'cons':i%3===1?'mod':'agg';
    const ct=st==='cons'?1.1+Math.random()*.5:st==='mod'?1.5+Math.random()*1.5:2.5+Math.random()*3;
    return{id:i,name:n,addr:'0x'+n.toLowerCase().slice(0,8)+'â€¦',strat:st,cashTarget:ct};
  });
})();
const CHAT_POOL=['won big at Casino! ğŸ°','just graduated ğŸ“','sending USDC to a friend ğŸ’¸','Developer wages are ğŸ”¥','who beat 10x? ğŸš€','sleeping at Home restores everything ğŸ˜´','Cafe coffee hits different â˜•','bought Protein Shake at Gym ğŸ’ª','Doctor job = best salary','the on-chain confirmation is satisfying','upgraded house to Lv3 ğŸ ','Market is always stocked ğŸ›’','Hospital saved me âš•ï¸','School skill costs $30 USD â€” worth it!','Bank USDC send worked perfectly','anyone near Library? ğŸ“š','GG on the multiplier round','Engineering skill unlocked big wages âš™ï¸','this game goes hard on-chain ğŸ”—','just refilled energy at vending machine ğŸ¥¤','earned $2 USD from my 8-hour work shift ğŸ’¼','energy drained fast today, time to eat! ğŸ”','cat bots are walking everywhere ğŸ±'];
let onlineIds=new Set();

function updateOnlineCount(){
  const c=onlineIds.size;
  document.getElementById('onlineCnt').textContent=c;
  const el2=document.getElementById('onlineCnt2');if(el2)el2.textContent=c;
  renderPMList(); // keep Players Online card in sync
}

function initOnlinePlayers(){
  /* Start with 65â€“84 players (pool is exactly 100 slots, indices 0-99) */
  const n=ONLINE_PLAYERS_MIN+Math.floor(Math.random()*(ONLINE_PLAYERS_MAX-ONLINE_PLAYERS_MIN+1));
  const sh=[...Array(100).keys()].sort(()=>Math.random()-.5);
  sh.slice(0,n).forEach(i=>onlineIds.add(i));
  updateOnlineCount();
  setInterval(()=>{
    const d=Math.floor(Math.random()*5)-2;
    if(d>0){
      /* Never exceed 100 (all 100 slots are already the universe) */
      const off=[...Array(100).keys()].filter(i=>!onlineIds.has(i));
      for(let k=0;k<d&&off.length&&onlineIds.size<100;k++)onlineIds.add(off[Math.floor(Math.random()*off.length)]);
    }else{const on=[...onlineIds];for(let k=0;k<-d&&on.length>50;k++)onlineIds.delete(on[Math.floor(Math.random()*on.length)]);}
    updateOnlineCount();
  },7000);
  setInterval(()=>{
    if(Math.random()<.25){
      const arr=[...onlineIds];if(!arr.length)return;
      const p=PPOOL[arr[Math.floor(Math.random()*arr.length)]];
      const m=CHAT_POOL[Math.floor(Math.random()*CHAT_POOL.length)];
      logChat('['+p.name+'] '+m,false,'#c084fc');
    }
  },5500);
}

/* â”€â”€ Multiplier Game (Crash-style) â”€â”€ */
const MG={run:false,phase:'wait',mul:1,crashAt:1,myBet:0,myIn:false,myCashed:false,myCashMul:0,round:0,bots:[],pts:[],tickInt:null,cdInt:null};
const mulC=document.getElementById('mulGraph');
const mulCtx=mulC.getContext('2d');

function genCrash(){
  const r=Math.random();
  if(r<.40)return 1+Math.random()*.8;
  if(r<.70)return 1.8+Math.random()*1.5;
  if(r<.88)return 3.3+Math.random()*3;
  if(r<.96)return 6.3+Math.random()*8;
  return 14+Math.random()*36;
}

function genBots(){
  const n=15+Math.floor(Math.random()*26);
  const arr=[...onlineIds].sort(()=>Math.random()-.5).slice(0,n);
  return arr.map(i=>{
    const p=PPOOL[i];
    return{name:p.name,bet:5+Math.floor(Math.random()*46),target:p.cashTarget,cashed:false,lost:false,cashMul:0};
  });
}

function mulRenderGraph(){
  const w=mulC.width,h=mulC.height;
  mulCtx.clearRect(0,0,w,h);mulCtx.fillStyle='#0f172a';mulCtx.fillRect(0,0,w,h);
  if(MG.pts.length<2)return;
  const maxM=Math.max(2,MG.pts[MG.pts.length-1]+.5);
  const tx=i=>(i/Math.max(MG.pts.length-1,1))*w;
  const ty=m=>h-((m-1)/(maxM-1))*(h-6)-3;
  const crash=MG.phase==='crash';
  mulCtx.beginPath();mulCtx.moveTo(tx(0),ty(MG.pts[0]));
  for(let i=1;i<MG.pts.length;i++)mulCtx.lineTo(tx(i),ty(MG.pts[i]));
  mulCtx.strokeStyle=crash?'#ef4444':'#22c55e';mulCtx.lineWidth=2;mulCtx.stroke();
  mulCtx.lineTo(tx(MG.pts.length-1),h);mulCtx.lineTo(0,h);mulCtx.closePath();
  mulCtx.fillStyle=crash?'rgba(239,68,68,.1)':'rgba(34,197,94,.1)';mulCtx.fill();
}

function mulRenderPlayers(){
  let h='';
  if(MG.myIn&&!MG.myCashed){h+=`<div class="prow"><span class="pp">â–¶ YOU</span><span>${MG.myBet}c @ ${MG.mul.toFixed(2)}x</span></div>`;}
  else if(MG.myIn&&MG.myCashed){h+=`<div class="prow"><span class="pc">âœ“ YOU</span><span>${Math.floor(MG.myBet*MG.myCashMul)}c</span></div>`;}
  for(const b of MG.bots){
    if(b.cashed)h+=`<div class="prow"><span class="pc">âœ“ ${b.name}</span><span>${Math.floor(b.bet*b.cashMul)}c @${b.cashMul.toFixed(2)}x</span></div>`;
    else if(b.lost)h+=`<div class="prow pl"><span>âœ— ${b.name}</span><span>âˆ’${b.bet}c</span></div>`;
    else h+=`<div class="prow"><span class="pp">â–¶ ${b.name}</span><span>${b.bet}c</span></div>`;
  }
  document.getElementById('mulPList').innerHTML=h;
}

function startMulRound(){
  MG.round++;MG.mul=1;MG.crashAt=genCrash();MG.pts=[1];MG.phase='run';MG.run=true;
  MG.bots=genBots();MG.myIn=false;MG.myCashed=false;MG.myCashMul=0;
  document.getElementById('mulRound').textContent='Round '+MG.round;
  document.getElementById('mulNum').textContent='1.00x';document.getElementById('mulNum').className='mulnum mg';
  document.getElementById('mulStatus').textContent='ğŸš€ Running! Cash out before crash!';
  document.getElementById('btnJoin').disabled=false;document.getElementById('btnCash').disabled=true;
  mulRenderPlayers();
  MG.tickInt=setInterval(()=>{
    if(!MG.run)return;
    MG.mul+=MG.mul*.008+.003;MG.pts.push(MG.mul);
    for(const b of MG.bots)if(!b.cashed&&!b.lost&&MG.mul>=b.target){b.cashed=true;b.cashMul=MG.mul;logChat('[Casino] '+b.name+' cashed @'+MG.mul.toFixed(2)+'x',false,'#22c55e');}
    document.getElementById('mulNum').textContent=MG.mul.toFixed(2)+'x';
    mulRenderGraph();mulRenderPlayers();
    if(MG.mul>=MG.crashAt)crashRound();
  },100);
}

function crashRound(){
  clearInterval(MG.tickInt);MG.run=false;MG.phase='crash';
  const ca=MG.mul.toFixed(2);
  document.getElementById('mulNum').textContent='ğŸ’¥ '+ca+'x';document.getElementById('mulNum').className='mulnum mr';
  document.getElementById('mulStatus').textContent='CRASHED @ '+ca+'x!';
  document.getElementById('btnCash').disabled=true;document.getElementById('btnJoin').disabled=true;
  for(const b of MG.bots)if(!b.cashed)b.lost=true;
  if(MG.myIn&&!MG.myCashed){logChat('[Casino] ğŸ’¥ CRASH @'+ca+'x! Lost '+MG.myBet+' coins.',false,'#ef4444');}
  mulRenderGraph();mulRenderPlayers();
  let cd=5;
  MG.cdInt=setInterval(()=>{
    cd--;document.getElementById('mulStatus').textContent='Next round in '+cd+'sâ€¦';
    if(cd<=0){clearInterval(MG.cdInt);startMulRound();}
  },1000);
}

function mulJoin(){
  if(!MG.run)return logChat('[Casino] Wait for next round.');
  if(MG.myIn)return logChat('[Casino] Already joined.');
  const bet=parseInt(document.getElementById('mulBetIn').value)||10;
  if(bet<5)return logChat('[Casino] Min bet 5 coins.');
  if(S.coins<bet)return logChat('[Casino] Not enough coins.');
  S.coins-=bet; // deduct upfront â€” returned proportionally on cashout
  MG.myBet=bet;MG.myIn=true;
  updateHUD();
  document.getElementById('btnJoin').disabled=true;document.getElementById('btnCash').disabled=false;
  logChat('[Casino] Joined round '+MG.round+' â€” bet: '+bet+' coins.',false,'#fbbf24');
  treasuryPay('CASINO_BET:'+bet,bet);
  mulRenderPlayers();
}
window.mulJoin=mulJoin;

function mulCashOut(){
  if(!MG.run||!MG.myIn||MG.myCashed)return;
  MG.myCashed=true;MG.myCashMul=MG.mul;
  const win=Math.floor(MG.myBet*MG.myCashMul); // includes original bet back
  S.coins+=win;updateHUD();
  document.getElementById('btnCash').disabled=true;
  document.getElementById('mulNum').className='mulnum my';
  logChat('[Casino] ğŸ’° Cashed @'+MG.myCashMul.toFixed(2)+'x! +'+win+' coins (profit: '+(win-MG.myBet)+').',false,'#fbbf24');
  mulRenderPlayers();
}
window.mulCashOut=mulCashOut;

function initMulGame(){
  clearInterval(MG.tickInt);clearInterval(MG.cdInt);MG.run=false;MG.round=0;
  document.getElementById('mulStatus').textContent='Starting in 3sâ€¦';
  document.getElementById('mulNum').textContent='â€”â€”';
  document.getElementById('btnJoin').disabled=true;document.getElementById('btnCash').disabled=true;
  let cd=3;
  MG.cdInt=setInterval(()=>{
    cd--;document.getElementById('mulStatus').textContent='Starting in '+cd+'sâ€¦';
    if(cd<=0){clearInterval(MG.cdInt);startMulRound();}
  },1000);
}

function stopMulGame(){clearInterval(MG.tickInt);clearInterval(MG.cdInt);MG.run=false;}

/* â”€â”€ NPC Walking Cat Bots â”€â”€ */
const NPC_TINTS=[0xfda4af,0x86efac,0x93c5fd,0xfde68a,0xc4b5fd,0xfbbf24,0xf87171,0x34d399,0x60a5fa,0xa78bfa,0xfb923c,0x4ade80,0xf0abfc,0x6ee7b7,0xfdba74];
const NPC_NAMES=['MogaBot','PlumeAI','CatNPC','StarBot','NeonBot','CyberCat','PixelBot','SwiftAI','ZenCat','DarkBot','BladeNPC','GhostBot','TigerBot','MoonCat','FireBot'];
let npcBots=[];

function spawnNPCBots(scene){
  npcBots=[];
  for(let i=0;i<15;i++){
    const sx=clamp((12+Math.floor(Math.random()*70))*TILE,10*TILE,(CW-10)*TILE);
    const sy=clamp((14+Math.floor(Math.random()*40))*TILE,10*TILE,(CH-10)*TILE);
    const cont=scene.add.container(sx,sy).setDepth(8);
    const img=scene.add.image(0,0,'cat').setScale(1.6).setOrigin(.5,.62).setTint(NPC_TINTS[i%NPC_TINTS.length]);
    const lbl=scene.add.text(-18,-36,NPC_NAMES[i%NPC_NAMES.length],{fontSize:'9px',color:'#94a3b8'});
    cont.add([img,lbl]);
    npcBots.push({obj:cont,tx:sx,ty:sy,speed:50+Math.random()*60,wait:Math.random()*4});
  }
}

function updateNPCBots(dtS){
  if(WS.zone!=='CITY'){npcBots.forEach(b=>b.obj.setVisible(false));return;}
  npcBots.forEach(b=>b.obj.setVisible(true));
  const roads=[{axis:'x',vals:[18,54,80]},{axis:'y',vals:[12,28,44]}];
  for(const bot of npcBots){
    if(bot.wait>0){bot.wait-=dtS;
      if(bot.wait<=0){
        // Pick new target: prefer road tiles for realism
        const r=Math.random();
        if(r<0.4){const ry=roads[1].vals[Math.floor(Math.random()*3)];bot.tx=clamp((8+Math.floor(Math.random()*75))*TILE,8*TILE,(CW-8)*TILE);bot.ty=ry*TILE;}
        else if(r<0.7){const rx=roads[0].vals[Math.floor(Math.random()*3)];bot.tx=rx*TILE;bot.ty=clamp((8+Math.floor(Math.random()*45))*TILE,8*TILE,(CH-8)*TILE);}
        else{bot.tx=clamp(bot.obj.x+(Math.random()-.5)*NPC_MAX_WANDER,8*TILE,(CW-8)*TILE);bot.ty=clamp(bot.obj.y+(Math.random()-.5)*NPC_MAX_WANDER,8*TILE,(CH-8)*TILE);}
      }
      continue;
    }
    const dx=bot.tx-bot.obj.x,dy=bot.ty-bot.obj.y,dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<6){bot.wait=1+Math.random()*3;}
    else{const mx=(dx/dist)*bot.speed*dtS,my=(dy/dist)*bot.speed*dtS;bot.obj.x+=mx;bot.obj.y+=my;}
  }
}

/* â”€â”€ Textures â”€â”€ */
function addTex(scene,key,w,h,fn){const c=document.createElement('canvas');c.width=w;c.height=h;fn(c.getContext('2d'));scene.textures.addCanvas(key,c);}
function px(ctx,x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(x,y,w,h);}

function makeTextures(scene){
  /* player */
  addTex(scene,'cat',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(7,26,18,4,'rgba(0,0,0,.22)');p(24,18,5,2,'#f59e0b');p(26,16,3,2,'#f59e0b');p(27,14,3,2,'#f59e0b');
    p(9,14,14,12,'#f59e0b');p(8,16,2,8,'#f59e0b');p(23,16,2,8,'#f59e0b');p(10,6,12,10,'#f59e0b');
    p(10,4,3,3,'#f59e0b');p(19,4,3,3,'#f59e0b');p(11,5,1,1,'#fb7185');p(20,5,1,1,'#fb7185');
    p(12,8,1,6,'#d97706');p(16,8,1,6,'#d97706');p(20,8,1,6,'#d97706');
    p(13,16,8,1,'#d97706');p(12,19,10,1,'#d97706');
    p(13,10,2,2,'#111827');p(18,10,2,2,'#111827');p(16,12,1,1,'#ef4444');
    p(11,24,3,2,'#f59e0b');p(18,24,3,2,'#f59e0b');
  });
  /* buildings */
  const bldg=(key,base,roof,win,door,sign)=>addTex(scene,key,48,48,c=>{
    const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,42,36,4,'rgba(0,0,0,.22)');p(8,16,32,26,base);p(6,14,36,4,roof);p(10,10,28,4,roof);
    for(let wy=0;wy<3;wy++)for(let wx=0;wx<3;wx++){p(12+wx*10,20+wy*7,6,4,win);p(12+wx*10,20+wy*7,6,1,'rgba(255,255,255,.18)');}
    p(22,32,8,10,door);p(28,37,1,1,'#fbbf24');p(12,6,24,4,sign);
  });
  bldg('bSchool','#a78bfa','#7c3aed','#e9d5ff','#111827','#faf5ff');
  bldg('bLib','#6366f1','#4338ca','#bfdbfe','#111827','#eef2ff');
  bldg('bJob','#38bdf8','#0284c7','#e0f2fe','#0b1220','#f0f9ff');
  bldg('bMkt','#f472b6','#be185d','#ffe4e6','#111827','#fff1f2');
  bldg('bBank','#64748b','#334155','#e2e8f0','#0f172a','#f8fafc');
  bldg('bHouse','#fbbf24','#b45309','#fef3c7','#111827','#fffbeb');
  bldg('bCafe','#34d399','#059669','#d1fae5','#0f172a','#ecfdf5');
  bldg('bGym','#f43f5e','#9f1239','#ffe4e6','#111827','#fff1f2');
  bldg('bHosp','#ef4444','#991b1b','#fee2e2','#111827','#fff5f5');
  bldg('bCasino','#fbbf24','#92400e','#fef9c3','#0f172a','#fffde7');
  /* decor */
  addTex(scene,'tree',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(8,26,16,4,'rgba(0,0,0,.15)');p(14,16,4,10,'#92400e');p(13,20,6,6,'#78350f');
    p(8,8,16,10,'#22c55e');p(10,6,12,4,'#16a34a');p(9,12,14,6,'#4ade80');
  });
  addTex(scene,'lamp',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(10,28,12,3,'rgba(0,0,0,.15)');p(15,8,2,20,'#94a3b8');p(14,26,4,2,'#64748b');
    p(16,10,8,2,'#94a3b8');p(22,10,4,3,'#475569');p(22,13,4,2,'#fbbf24');
  });
  addTex(scene,'bench',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.15)');p(8,18,3,8,'#78350f');p(21,18,3,8,'#78350f');
    p(7,16,20,3,'#a16207');p(7,14,20,2,'#b45309');p(7,10,20,3,'#92400e');
  });
  addTex(scene,'vend',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(9,26,14,3,'rgba(0,0,0,.15)');p(9,8,14,18,'#0ea5e9');p(9,8,14,3,'#0284c7');p(11,12,10,7,'#111827');p(19,20,2,4,'#334155');
  });
  addTex(scene,'vendor',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.15)');p(8,16,16,10,'#f97316');p(7,10,18,3,'#e11d48');p(13,11,4,4,'#fde68a');
  });
  /* furniture */
  addTex(scene,'fTable',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.18)');p(6,16,20,4,'#a16207');p(8,20,2,6,'#78350f');p(22,20,2,6,'#78350f');p(7,15,18,2,'#b45309');
  });
  addTex(scene,'fBed',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(5,26,22,3,'rgba(0,0,0,.18)');p(6,16,20,8,'#cbd5e1');p(6,14,20,3,'#94a3b8');p(6,24,20,2,'#64748b');p(7,15,6,2,'#e2e8f0');p(15,15,6,2,'#e2e8f0');
  });
  addTex(scene,'fTV',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(8,26,16,3,'rgba(0,0,0,.18)');p(8,10,16,10,'#0f172a');p(10,12,12,6,'#111827');p(7,20,18,3,'#334155');p(14,23,4,3,'#475569');
  });
  addTex(scene,'fShelf',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(8,26,16,3,'rgba(0,0,0,.18)');p(8,10,16,14,'#92400e');p(9,12,14,2,'#78350f');p(9,16,14,2,'#78350f');p(9,20,14,2,'#78350f');
    p(10,13,2,3,'#ef4444');p(13,13,2,3,'#22c55e');p(16,13,2,3,'#3b82f6');p(11,17,2,3,'#f59e0b');p(15,17,2,3,'#a78bfa');
  });
  addTex(scene,'fBoard',48,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(1,4,46,24,'#166534');p(2,5,44,22,'#15803d');
    p(4,9,16,2,'rgba(255,255,255,.85)');p(22,9,18,2,'rgba(255,255,255,.82)');
    p(4,13,12,2,'rgba(255,255,255,.7)');p(18,13,14,2,'rgba(255,255,255,.65)');
    p(4,17,10,2,'rgba(255,255,255,.6)');
    p(0,4,48,2,'#78350f');p(0,26,48,2,'#78350f');p(0,4,2,24,'#78350f');p(46,4,2,24,'#78350f');
    p(4,27,40,2,'#6b7280');
  });
  addTex(scene,'fComputer',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.18)');p(6,6,20,14,'#1e293b');p(8,8,16,10,'#0ea5e9');
    p(10,9,4,4,'rgba(255,255,255,.3)');p(10,11,8,1,'rgba(255,255,255,.4)');p(10,13,5,1,'rgba(255,255,255,.3)');p(10,15,10,1,'rgba(255,255,255,.35)');
    p(14,20,4,3,'#334155');p(11,23,10,2,'#475569');
  });
  addTex(scene,'fSofa',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(4,26,24,3,'rgba(0,0,0,.18)');p(4,18,24,6,'#4338ca');p(4,12,4,10,'#3730a3');p(24,12,4,10,'#3730a3');p(4,10,24,4,'#3730a3');p(14,18,2,6,'#312e81');p(6,11,20,2,'rgba(255,255,255,.15)');
  });
  addTex(scene,'fPlant',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(10,26,12,3,'rgba(0,0,0,.18)');p(12,20,8,6,'#92400e');p(13,18,6,4,'#78350f');p(14,22,4,2,'#b45309');
    p(8,8,16,12,'#16a34a');p(6,12,10,6,'#15803d');p(16,10,10,8,'#22c55e');p(10,6,12,6,'#4ade80');
  });
  addTex(scene,'fATM',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(5,26,22,3,'rgba(0,0,0,.18)');p(5,4,22,22,'#1e293b');p(5,4,22,3,'#0f172a');p(8,8,16,8,'#0284c7');
    p(10,9,4,4,'rgba(255,255,255,.25)');p(8,18,6,6,'#334155');p(9,19,1,1,'#fbbf24');p(11,19,1,1,'#fbbf24');p(13,19,1,1,'#fbbf24');p(9,21,1,1,'#22c55e');p(11,21,1,1,'#22c55e');
    p(18,20,6,2,'#374151');p(16,24,10,2,'#374151');
  });
  addTex(scene,'fSlot',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.22)');p(6,8,20,18,'#7c3aed');p(6,8,20,3,'#5b21b6');
    p(9,12,14,8,'#111827');p(10,13,4,6,'#fbbf24');p(15,13,4,6,'#ef4444');p(20,13,1,6,'#22c55e');
    p(14,22,4,2,'#f59e0b');p(13,24,6,2,'#d97706');
  });
  addTex(scene,'fRoul',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(6,26,20,3,'rgba(0,0,0,.22)');p(6,14,20,12,'#166534');p(6,14,20,2,'#14532d');
    c.fillStyle='#dc2626';c.beginPath();c.arc(16,20,6,0,Math.PI*2);c.fill();
    c.fillStyle='#0f172a';c.beginPath();c.arc(16,20,3,0,Math.PI*2);c.fill();
    p(15,8,2,6,'#a16207');
  });
  addTex(scene,'fMachine',32,32,c=>{const p=(x,y,w,h,col)=>px(c,x,y,w,h,col);
    p(5,26,22,3,'rgba(0,0,0,.18)');p(6,10,20,14,'#1f2937');p(6,10,20,2,'#374151');
    p(8,12,4,10,'#374151');p(20,12,4,10,'#374151');p(12,16,8,6,'#111827');
    p(4,16,3,8,'#64748b');p(25,16,3,8,'#64748b');p(3,18,5,2,'#475569');p(24,18,5,2,'#475569');
  });
}

/* â”€â”€ World data â”€â”€ */
const BLDGS=[
  {key:'School',     tex:'bSchool', ts:2.2, x:14*TILE,y:10*TILE,w:7*TILE,h:6*TILE},
  {key:'Library',    tex:'bLib',    ts:2.1, x:26*TILE,y:10*TILE,w:6*TILE,h:6*TILE},
  {key:'Office',     tex:'bJob',    ts:2.2, x:38*TILE,y:10*TILE,w:7*TILE,h:6*TILE},
  {key:'Town Hall',  tex:'bBank',   ts:2.1, x:50*TILE,y:10*TILE,w:6*TILE,h:6*TILE},
  {key:'Job Center', tex:'bJob',    ts:2.35,x:60*TILE,y:18*TILE,w:8*TILE,h:6*TILE},
  {key:'Market',     tex:'bMkt',    ts:2.35,x:40*TILE,y:22*TILE,w:8*TILE,h:6*TILE},
  {key:'Bank',       tex:'bBank',   ts:2.1, x:50*TILE,y:22*TILE,w:6*TILE,h:6*TILE},
  {key:'House',      tex:'bHouse',  ts:2.2, x:14*TILE,y:40*TILE,w:7*TILE,h:6*TILE},
  {key:'Cafe',       tex:'bCafe',   ts:2.35,x:60*TILE,y:40*TILE,w:8*TILE,h:6*TILE},
  {key:'Gym',        tex:'bGym',    ts:2.1, x:72*TILE,y:40*TILE,w:6*TILE,h:6*TILE},
  {key:'Hospital',   tex:'bHosp',   ts:2.2, x:26*TILE,y:40*TILE,w:7*TILE,h:6*TILE},
  {key:'Casino',     tex:'bCasino', ts:2.35,x:72*TILE,y:18*TILE,w:8*TILE,h:6*TILE},
];
const IACTS=[
  {key:'Vending',tex:'vend',ts:1.6,x:52*TILE,y:30*TILE,w:2*TILE,h:2*TILE},
  {key:'Vendor', tex:'vendor',ts:1.7,x:22*TILE,y:32*TILE,w:2*TILE,h:2*TILE},
  {key:'River',  tex:'vend', ts:1.4,x:68*TILE,y:14*TILE,w:2*TILE,h:2*TILE},
];

/* â”€â”€ City tiles â”€â”€ */
const TT={G:0,R:1,W:2,S:3,SD:4,CR:5};
const TC={0:0x14532d,1:0x475569,2:0x0ea5e9,3:0xfde68a,4:0x1f2937,5:0xe5e7eb};
const BLKT=new Set([TT.W]);
function buildTiles(){
  const t=Array.from({length:CH},()=>Array.from({length:CW},()=>TT.G));
  for(let y=0;y<26;y++){for(let x=70;x<=74;x++)t[y][x]=TT.W;for(let x=68;x<=76;x++)if(t[y][x]!==TT.W)t[y][x]=TT.S;}
  for(const y of[12,28,44])for(let x=0;x<CW;x++)t[y][x]=TT.R;
  for(const x of[18,54,80])for(let y=0;y<CH;y++)t[y][x]=TT.R;
  for(let x=8;x<=CW-8;x++){t[8][x]=TT.R;t[CH-8][x]=TT.R;}
  for(let y=8;y<=CH-8;y++){t[y][8]=TT.R;t[y][CW-8]=TT.R;}
  for(let x=10;x<=30;x++)t[36][x]=TT.R;for(let y=30;y<=48;y++)t[y][30]=TT.R;
  for(let x=58;x<=88;x++)t[36][x]=TT.R;for(let y=18;y<=36;y++)t[y][66]=TT.R;
  for(let y=0;y<CH;y++)for(let x=0;x<CW;x++)if(t[y][x]===TT.R)
    for(let oy=-1;oy<=1;oy++)for(let ox=-1;ox<=1;ox++){const ny=y+oy,nx=x+ox;if(ny>=0&&nx>=0&&ny<CH&&nx<CW&&t[ny][nx]===TT.G)t[ny][nx]=TT.SD;}
  for(const y of[12,28,44])for(const x of[18,54,80])
    for(let i=-2;i<=2;i++){const x2=x+i;if(y>=0&&y<CH&&x2>=0&&x2<CW)t[y][x2]=(i%2===0)?TT.CR:TT.R;}
  for(let x=70;x<=74;x++){t[12][x]=TT.R;t[28][x]=TT.R;}
  return t;
}
function blocked(x,y,tiles){const tx=Math.floor(x/TILE),ty=Math.floor(y/TILE);return(tx<0||ty<0||tx>=CW||ty>=CH)||BLKT.has(tiles[ty][tx]);}

/* â”€â”€ Interior tiles â”€â”€ */
const IT={FW:0,FT:1,WB:2,WP:3,RG:4,CT:5};
const IPal={0:[0x8b5a2b,0x7c4a22],1:[0x94a3b8,0x64748b],2:[0xb91c1c,0x7f1d1d],3:[0xe2e8f0,0x94a3b8],4:[0x2563eb,0x1d4ed8],5:[0x475569,0x334155]};

function makeInterior(kind){
  const w=IW,h=IH;
  const bf=(kind==='House'||kind==='Cafe'||kind==='Casino'||kind==='Gym')?IT.FW:IT.FT;
  const bw=(kind==='Hospital'||kind==='School'||kind==='Library'||kind==='Bank')?IT.WP:IT.WB;
  const g=Array.from({length:h},()=>Array.from({length:w},()=>bf));
  for(let x=0;x<w;x++){g[0][x]=bw;g[h-1][x]=bw;}for(let y=0;y<h;y++){g[y][0]=bw;g[y][w-1]=bw;}
  const ex=Math.floor(w/2);g[h-1][ex]=bf;for(let y=h-2;y>=2;y--)g[y][ex]=IT.RG;
  const pr=(x0,y0,ww,hh,tp)=>{for(let y=y0;y<y0+hh;y++)for(let x=x0;x<x0+ww;x++){if(y<=0||x<=0||y>=h-1||x>=w-1)continue;g[y][x]=tp;}};
  switch(kind){
    case 'House':
      pr(1,1,3,9,IT.CT);pr(20,1,12,3,IT.CT);pr(3,3,12,6,IT.RG);pr(3,12,15,7,IT.RG);pr(20,12,12,7,IT.CT);break;
    case 'School':
      pr(2,1,30,3,IT.CT);pr(2,5,30,2,IT.RG);pr(2,8,30,2,IT.RG);pr(2,11,30,2,IT.RG);
      pr(1,14,2,6,IT.CT);pr(31,14,2,6,IT.CT);pr(4,15,25,4,IT.RG);break;
    case 'Library':
      pr(2,1,30,2,IT.CT);for(let r=0;r<4;r++)pr(2,4+r*4,30,2,IT.CT);pr(4,6,8,2,IT.RG);pr(22,6,8,2,IT.RG);pr(8,18,18,2,IT.RG);break;
    case 'Job Center':
      pr(2,1,30,2,IT.CT);pr(2,4,8,6,IT.CT);pr(13,4,8,6,IT.CT);pr(24,4,8,6,IT.CT);pr(4,12,26,3,IT.RG);break;
    case 'Market':
      pr(2,1,30,2,IT.CT);for(let a=0;a<4;a++)pr(3+a*7,4,2,14,IT.CT);pr(2,18,30,2,IT.CT);break;
    case 'Gym':
      pr(2,1,15,6,IT.RG);pr(19,1,13,6,IT.RG);pr(3,9,28,4,IT.RG);pr(2,14,6,5,IT.CT);pr(26,14,6,5,IT.CT);break;
    case 'Hospital':
      pr(2,1,30,2,IT.CT);for(let b=0;b<3;b++){pr(2,4+b*4,13,3,IT.RG);pr(19,4+b*4,13,3,IT.RG);}pr(8,17,18,2,IT.CT);break;
    case 'Cafe':
      pr(2,1,30,3,IT.CT);pr(2,5,12,6,IT.RG);pr(20,5,12,6,IT.RG);pr(4,13,10,5,IT.RG);pr(20,13,10,5,IT.RG);break;
    case 'Bank':
      pr(2,2,30,3,IT.CT);pr(6,7,22,4,IT.RG);pr(2,12,8,6,IT.CT);pr(24,12,8,7,IT.CT);pr(12,14,10,4,IT.CT);break;
    case 'Casino':
      pr(2,1,30,3,IT.CT);pr(2,5,13,5,IT.RG);pr(19,5,13,5,IT.RG);pr(8,12,18,5,IT.RG);pr(2,18,30,2,IT.CT);break;
    case 'Office':
      pr(2,1,30,2,IT.CT);pr(2,4,13,5,IT.RG);pr(19,4,13,5,IT.RG);pr(4,10,8,5,IT.RG);pr(22,10,8,5,IT.RG);pr(14,10,6,3,IT.RG);pr(2,17,30,2,IT.CT);break;
    case 'Town Hall':
      pr(2,2,30,2,IT.CT);pr(14,4,6,3,IT.CT);pr(4,8,25,3,IT.RG);pr(2,13,8,5,IT.RG);pr(24,13,8,5,IT.RG);pr(12,14,10,3,IT.CT);pr(2,19,30,1,IT.CT);break;
  }
  return{g,exitX:ex,exitY:h-1,title:kind};
}

function drawInteriorTiles(scene,intr,cont){
  const gr=scene.add.graphics().setDepth(-3);
  for(let y=0;y<IH;y++)for(let x=0;x<IW;x++){
    const t=intr.g[y][x];const[c1,c2]=IPal[t]||[0x0f172a,0x111827];
    gr.fillStyle(c1,1);gr.fillRect(x*TILE,y*TILE,TILE,TILE);
    if(t===IT.FT){gr.fillStyle(((x+y)%2===0)?c2:c1,.55);gr.fillRect(x*TILE+2,y*TILE+2,TILE-4,TILE-4);}
    else if(t===IT.FW){gr.fillStyle(c2,.32);gr.fillRect(x*TILE+2,y*TILE+6,TILE-4,2);gr.fillRect(x*TILE+2,y*TILE+18,TILE-4,2);}
    else if(t===IT.RG){gr.fillStyle(0xffffff,.07);gr.fillRect(x*TILE+6,y*TILE+6,2,2);gr.fillRect(x*TILE+22,y*TILE+18,2,2);}
    else if(t===IT.CT){gr.fillStyle(0xffffff,.09);gr.fillRect(x*TILE+3,y*TILE+3,TILE-6,3);}
    else if(t===IT.WB){gr.fillStyle(c2,.32);gr.fillRect(x*TILE+2,y*TILE+10,TILE-4,2);}
    else if(t===IT.WP){gr.fillStyle(c2,.15);gr.fillRect(x*TILE+4,y*TILE+4,TILE-8,TILE-8);}
  }
  cont.add(gr);
  cont.add(scene.add.text((IW*TILE)/2,10,intr.title,{fontSize:'18px',color:'#e2e8f0',fontStyle:'bold',backgroundColor:'rgba(0,0,0,.38)',padding:{x:8,y:4}}).setOrigin(.5,0).setDepth(50));
  const ex=(intr.exitX+.5)*TILE,ey=(intr.exitY+.5)*TILE;
  cont.add(scene.add.text(ex,ey-8,'EXIT',{fontSize:'13px',color:'#0b1020',fontStyle:'bold',backgroundColor:'rgba(251,191,36,.9)',padding:{x:6,y:3}}).setOrigin(.5,1).setDepth(55));
}

function add(scene,cont,tx,ty,key,sc=1.1,dp=20){
  const spr=scene.add.image((tx+.5)*TILE,(ty+.5)*TILE,key).setScale(sc).setDepth(dp);cont.add(spr);
}

function addFurniture(scene,intr,cont){
  switch(intr.title){
    case 'House':
      add(scene,cont,22,1,'fTV',1.15);add(scene,cont,3,7,'fSofa',1.2);add(scene,cont,9,7,'fSofa',1.2);add(scene,cont,6,4,'fTable',1.1);
      add(scene,cont,1,4,'fShelf',1.0);add(scene,cont,5,13,'fBed',1.3);add(scene,cont,11,13,'fBed',1.3);
      add(scene,cont,21,14,'fTable',1.1);add(scene,cont,23,12,'fShelf',1.0);add(scene,cont,26,15,'fPlant',1.0);break;
    case 'School':
      add(scene,cont,10,1,'fBoard',1.8);add(scene,cont,22,1,'fBoard',1.5);
      add(scene,cont,16,3,'fTable',1.2);add(scene,cont,2,3,'fPlant',.9);add(scene,cont,31,3,'fPlant',.9);
      for(const x of[4,9,14,20,25,29]){add(scene,cont,x,6,'fTable',1.0);add(scene,cont,x,9,'fTable',1.0);add(scene,cont,x,12,'fTable',1.0);}
      add(scene,cont,1,15,'fShelf',1.1);add(scene,cont,1,17,'fShelf',1.1);add(scene,cont,32,15,'fShelf',1.1);add(scene,cont,32,17,'fShelf',1.1);
      add(scene,cont,12,17,'fTable',1.1);add(scene,cont,20,17,'fTable',1.1);break;
    case 'Library':
      add(scene,cont,10,1,'fComputer',1.1);add(scene,cont,16,2,'fTable',1.2);add(scene,cont,22,1,'fComputer',1.1);
      for(let r=0;r<4;r++)for(let x=3;x<=29;x+=3)add(scene,cont,x,5+r*4,'fShelf',1.0);
      add(scene,cont,10,18,'fTable',1.1);add(scene,cont,22,18,'fTable',1.1);add(scene,cont,3,18,'fPlant',1.0);add(scene,cont,30,18,'fPlant',1.0);break;
    case 'Job Center':
      add(scene,cont,10,1,'fComputer',1.1);add(scene,cont,16,1,'fTable',1.1);add(scene,cont,22,1,'fComputer',1.1);
      for(const x of[4,7,15,18,26,29]){add(scene,cont,x,6,'fComputer',1.0);add(scene,cont,x,7,'fTable',.9);}
      add(scene,cont,16,13,'fTable',1.3);add(scene,cont,3,15,'fPlant',1.0);add(scene,cont,30,15,'fPlant',1.0);break;
    case 'Market':
      for(const x of[5,12,19,26])add(scene,cont,x,1,'fTable',1.0);
      for(const x of[4,11,18,25])for(let y=5;y<=16;y+=3)add(scene,cont,x,y,'fShelf',1.1);
      for(const x of[5,14,23])add(scene,cont,x,18,'fTable',1.1);break;
    case 'Gym':
      for(let x=4;x<=14;x+=4)add(scene,cont,x,3,'fMachine',1.1);
      for(let x=20;x<=30;x+=4)add(scene,cont,x,3,'fMachine',1.1);
      add(scene,cont,9,5,'fTV',1.1);add(scene,cont,24,5,'fTV',1.1);
      for(let x=6;x<=28;x+=7)add(scene,cont,x,11,'fTable',1.0);
      for(let y=15;y<=18;y+=2){add(scene,cont,3,y,'fShelf',1.0);add(scene,cont,28,y,'fShelf',1.0);}
      add(scene,cont,16,11,'fPlant',.9);break;
    case 'Hospital':
      add(scene,cont,16,1,'fComputer',1.1);add(scene,cont,8,1,'fTable',1.1);add(scene,cont,24,1,'fTable',1.1);
      for(const x of[7,25])for(let y=5;y<=13;y+=4)add(scene,cont,x,y,'fBed',1.2);
      for(const x of[4,29])for(let y=5;y<=13;y+=4)add(scene,cont,x,y,'fTV',1.0);
      for(const x of[12,17,22])add(scene,cont,x,18,'fShelf',1.1);add(scene,cont,3,1,'fPlant',.9);break;
    case 'Cafe':
      add(scene,cont,8,2,'fTV',1.0);add(scene,cont,24,2,'fTV',1.0);add(scene,cont,16,2,'fTable',1.1);
      for(const x of[4,10,22,28]){add(scene,cont,x,7,'fSofa',1.1);add(scene,cont,x,10,'fTable',1.0);}
      add(scene,cont,6,14,'fSofa',1.1);add(scene,cont,26,14,'fSofa',1.1);
      add(scene,cont,6,17,'fTable',1.0);add(scene,cont,26,17,'fTable',1.0);
      add(scene,cont,2,4,'fPlant',1.0);add(scene,cont,31,4,'fPlant',1.0);add(scene,cont,16,14,'fPlant',1.0);break;
    case 'Bank':
      for(const x of[6,12,18,24]){add(scene,cont,x,3,'fComputer',1.0);add(scene,cont,x,4,'fTable',1.0);}
      for(const x of[8,16,24])add(scene,cont,x,8,'fSofa',1.1);
      add(scene,cont,3,13,'fATM',1.2);add(scene,cont,5,13,'fATM',1.2);
      for(const x of[25,28])for(const y of[15,17]){add(scene,cont,x,y,'fShelf',1.1);}
      add(scene,cont,16,15,'fTable',1.2);add(scene,cont,2,4,'fPlant',1.0);add(scene,cont,31,4,'fPlant',1.0);break;
    case 'Casino':
      for(let x=4;x<=28;x+=3)add(scene,cont,x,2,'fSlot',1.1);
      for(const x of[6,10])add(scene,cont,x,7,'fRoul',1.3);
      for(const x of[21,25])add(scene,cont,x,7,'fTable',1.3);
      add(scene,cont,14,14,'fRoul',1.5);add(scene,cont,20,14,'fTable',1.3);
      for(const x of[6,12,18,24])add(scene,cont,x,19,'fTable',1.0);
      add(scene,cont,2,4,'fTV',1.1);add(scene,cont,31,4,'fTV',1.1);add(scene,cont,16,4,'fTV',1.2);break;
    case 'Office':
      for(const x of[4,8,12,20,24,28]){add(scene,cont,x,5,'fComputer',1.0);add(scene,cont,x,6,'fTable',.9);}
      add(scene,cont,16,5,'fTV',1.1);
      for(const x of[5,11,23,29])add(scene,cont,x,11,'fTable',1.0);
      add(scene,cont,2,4,'fPlant',1.0);add(scene,cont,31,4,'fPlant',1.0);
      add(scene,cont,16,14,'fSofa',1.1);add(scene,cont,16,16,'fTable',1.1);break;
    case 'Town Hall':
      add(scene,cont,16,2,'fBoard',1.8);
      for(const x of[4,8,12,20,24,28])add(scene,cont,x,9,'fSofa',1.1);
      add(scene,cont,6,15,'fTable',1.2);add(scene,cont,26,15,'fTable',1.2);add(scene,cont,16,15,'fComputer',1.2);
      add(scene,cont,2,4,'fPlant',1.0);add(scene,cont,31,4,'fPlant',1.0);break;
  }
}

/* â”€â”€ Day/night, world render, minimap, Phaser â”€â”€ */
let nightOv=null,lampGlows=[],cityTiles=null,interior=null,worldCont=null;
let _nearPlotIdx=null,_farmGfx=null; // farm plot state
function clearWorld(scene){if(worldCont)worldCont.destroy(true);worldCont=scene.add.container(0,0);lampGlows=[];}

function updateDN(dtS){
  CLK.min=(CLK.min+CLK.speed*dtS)%(24*60);const m=CLK.min;
  const lerp=(a,b,t)=>a+(b-a)*t;
  let tod='Day',dark=.08;
  if(m>=20*60||m<5*60){tod='Night';dark=.62;}
  else if(m<6.5*60){tod='Dawn';dark=lerp(.62,.12,(m-5*60)/(1.5*60));}
  else if(m<17.5*60){tod='Day';dark=.08;}
  else{tod='Sunset';dark=lerp(.12,.62,(m-17.5*60)/(2.5*60));}
  document.getElementById('tod').textContent=tod;document.getElementById('timeTxt').textContent=fmtTime(CLK.min);
  const ga=(tod==='Night')?.22:(tod==='Sunset'||tod==='Dawn')?.14:.06;
  for(const g of lampGlows)g.setAlpha(ga);
  if(nightOv)nightOv.setAlpha(dark);
}

function decorateCity(scene,tiles,cont){
  for(let y=0;y<CH;y++)for(let x=0;x<CW;x++){
    if(tiles[y][x]!==TT.SD)continue;const px=x*TILE+TILE/2,py=y*TILE+TILE/2;
    let inLot=false;
    for(const b of BLDGS)if(px>=b.x&&px<=b.x+b.w&&py>=b.y&&py<=b.y+b.h){inLot=true;break;}
    if(!inLot)for(const i of IACTS)if(px>=i.x&&px<=i.x+i.w&&py>=i.y&&py<=i.y+i.h){inLot=true;break;}
    if(inLot)continue;
    const n=(x*83492791^y*29765723)>>>0;
    if(n%13===0)cont.add(scene.add.image(px,py,'tree').setScale(1.35).setDepth(1));
    else if(n%29===0)cont.add(scene.add.image(px,py,'bench').setScale(1.2).setDepth(1));
  }
  const placeLamp=(tx,ty)=>{
    const x=tx*TILE+TILE/2,y=ty*TILE+TILE/2;
    cont.add(scene.add.image(x,y,'lamp').setScale(1.2).setDepth(1.2));
    const g=scene.add.circle(x+6,y-8,14,0xfbbf24,.06).setDepth(1.1);cont.add(g);lampGlows.push(g);
  };
  for(const ry of[12,28,44,8,CH-8])for(let x=10;x<CW-10;x+=6)
    for(const c of[{tx:x,ty:ry-1},{tx:x,ty:ry+1}]){if(c.ty<0||c.ty>=CH)continue;if(tiles[c.ty][c.tx]!==TT.SD)continue;placeLamp(c.tx,c.ty);break;}
  for(const rx of[18,54,80,8,CW-8])for(let y=10;y<CH-10;y+=6)
    for(const c of[{tx:rx-1,ty:y},{tx:rx+1,ty:y}]){if(c.tx<0||c.tx>=CW)continue;if(tiles[c.ty][c.tx]!==TT.SD)continue;placeLamp(c.tx,c.ty);break;}
}

function drawCity(scene){
  clearWorld(scene);cityTiles=buildTiles();
  const gr=scene.add.graphics().setDepth(-3);
  for(let y=0;y<CH;y++)for(let x=0;x<CW;x++){gr.fillStyle(TC[cityTiles[y][x]],1);gr.fillRect(x*TILE,y*TILE,TILE,TILE);}
  worldCont.add(gr);decorateCity(scene,cityTiles,worldCont);
  for(const b of BLDGS){
    const cx=b.x+b.w/2,cy=b.y+b.h/2;
    worldCont.add(scene.add.image(cx,cy,b.tex).setScale(b.ts).setDepth(3));
    worldCont.add(scene.add.text(cx,b.y-8,b.key,{fontSize:'13px',color:'#e2e8f0',fontStyle:'bold',backgroundColor:'rgba(0,0,0,.35)',padding:{x:6,y:3}}).setOrigin(.5,1).setDepth(4));
  }
  for(const i of IACTS){
    const cx=i.x+i.w/2,cy=i.y+i.h/2;
    worldCont.add(scene.add.image(cx,cy,i.tex).setScale(i.ts).setDepth(3));
    worldCont.add(scene.add.text(cx,i.y-8,i.key,{fontSize:'12px',color:'#e2e8f0',backgroundColor:'rgba(0,0,0,.35)',padding:{x:5,y:2}}).setOrigin(.5,1).setDepth(4));
  }
  scene.cameras.main.setBounds(0,0,CW*TILE,CH*TILE);drawMM._k=null;
  redrawFarmPlots();
}

function drawInterior(scene,bk){
  clearWorld(scene);interior=makeInterior(bk);
  drawInteriorTiles(scene,interior,worldCont);addFurniture(scene,interior,worldCont);
  scene.cameras.main.setBounds(0,0,IW*TILE,IH*TILE);drawMM._k=null;
  if(_farmGfx)_farmGfx.setVisible(false);
}

function enterBuilding(scene,bk){
  WS.outdoor=null;WS.savedPos={x:scene.me.x,y:scene.me.y};WS.zone='INTERIOR';WS.key=bk;
  document.getElementById('mmTgt').textContent='â€”';
  drawInterior(scene,bk);
  scene.me.x=(interior.exitX+.5)*TILE;scene.me.y=(IH-3)*TILE;
  updateHUD();renderBuildingPanel();
  logChat('[â†’] Entered: '+bk+'. Tap EXIT to leave.',false,'#93c5fd');
  if(bk==='Casino')initMulGame();
  if(bk==='Bank')setTimeout(refreshUSDCBalance,500);
}
function exitCity(scene){
  if(S.learningEndTime>Date.now()){
    const rem=S.learningEndTime-Date.now();
    return logChat('[âš ï¸] Still learning! '+fmtCountdown(rem)+' left. Cannot leave building!',false,'#f87171');
  }
  if(S.workLockEnd>Date.now()){
    const rem=Math.ceil((S.workLockEnd-Date.now())/1000);
    return logChat('[âš ï¸] Work session active! '+rem+'s left. Cannot leave building!',false,'#f87171');
  }
  WS.zone='CITY';WS.key='';interior=null;stopMulGame();
  drawCity(scene);scene.me.x=WS.savedPos.x;scene.me.y=WS.savedPos.y;
  updateHUD();renderBuildingPanel();logChat('[â†] Back to CITY.',false,'#93c5fd');
}

/* minimap */
const mmCanvas=document.getElementById('mmC'),mmCtx2=mmCanvas.getContext('2d');
function w2mm(x,y){const wP=(WS.zone==='CITY'?CW:IW)*TILE,hP=(WS.zone==='CITY'?CH:IH)*TILE;return{mx:(x/wP)*mmCanvas.width,my:(y/hP)*mmCanvas.height};}
function drawMM(pos){
  const ck=WS.zone==='CITY'?'CITY':'INT:'+WS.key;
  if(drawMM._k!==ck){
    drawMM._k=ck;
    const bg=document.createElement('canvas');bg.width=mmCanvas.width;bg.height=mmCanvas.height;const ic=bg.getContext('2d');
    if(WS.zone==='CITY')for(let y=0;y<mmCanvas.height;y++)for(let x=0;x<mmCanvas.width;x++){
      const t=cityTiles[Math.floor((y/mmCanvas.height)*CH)][Math.floor((x/mmCanvas.width)*CW)];
      ic.fillStyle=t===TT.R||t===TT.CR?'#64748b':t===TT.SD?'#334155':t===TT.W?'#0284c7':t===TT.S?'#fde68a':'#1f7a3a';ic.fillRect(x,y,1,1);
    }else for(let y=0;y<mmCanvas.height;y++)for(let x=0;x<mmCanvas.width;x++){
      const t=interior.g[Math.floor((y/mmCanvas.height)*IH)][Math.floor((x/mmCanvas.width)*IW)];
      ic.fillStyle=t===IT.FW?'#8b5a2b':t===IT.FT?'#94a3b8':t===IT.WB?'#7f1d1d':t===IT.WP?'#cbd5e1':t===IT.RG?'#1d4ed8':'#475569';ic.fillRect(x,y,1,1);
    }
    drawMM._bg=bg;
  }
  mmCtx2.clearRect(0,0,mmCanvas.width,mmCanvas.height);mmCtx2.drawImage(drawMM._bg,0,0);
  if(WS.zone==='CITY'&&NAV.pos){const t=w2mm(NAV.pos.x,NAV.pos.y);mmCtx2.fillStyle='#ef4444';mmCtx2.fillRect((t.mx-2)|0,(t.my-2)|0,5,5);}
  const p=w2mm(pos.x,pos.y);mmCtx2.fillStyle='#22c55e';mmCtx2.beginPath();mmCtx2.arc(p.mx,p.my,3,0,Math.PI*2);mmCtx2.fill();
}

function nearPOI(px,py){let best=null,bd=Infinity;
  for(const b of BLDGS){const d=Math.hypot(px-b.x-b.w/2,py-b.y-b.h/2);if(d<bd){bd=d;best=b;}}
  for(const i of IACTS){const d=Math.hypot(px-i.x-i.w/2,py-i.y-i.h/2);if(d<bd){bd=d;best=i;}}
  return{poi:best,d:bd};
}

function doIAct(action){
  switch(action){
    case 'vending':
      WS.outdoor='Vending';
      renderBuildingPanel();
      logChat('[Vending] ğŸ« Choose your energy item! ($1 USD each)',false,'#fbbf24');
      break;
    case 'river':
      WS.outdoor='River';
      renderBuildingPanel();
      logChat('[River] ğŸï¸ River bank â€” fill watering can or go fishing!',false,'#38bdf8');
      break;
    case 'vendor':if(S.coins<4)return logChat('[Vendor] Need 4 USD.');S.coins-=4;if(Math.random()<.55)S.inv.soda++;else S.inv.sandwich++;updateHUD();logChat('[Vendor] Got random item!');break;
    default:logChat('[info] Tap to enter '+action+' building.');
  }
}

function renderVending(){
  const items=[
    {id:'drink',  n:'Energy Drink âš¡', c:1, e:50},
    {id:'burger', n:'Burger ğŸ”',       c:1, e:40},
    {id:'coffee', n:'Coffee â˜•',        c:1, e:30},
    {id:'water',  n:'Water ğŸ’§',         c:1, e:25},
  ];
  let h=`<strong>ğŸ¥¤ Vending Machine</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">$1 USD per item Â· Instant energy refill</div>`;
  for(const it of items)h+=`<div class="irow"><div class="ileft"><div class="iname">${it.n}</div><div class="idesc">+${it.e} energy Â· $${it.c} USD</div></div>
<button onclick="buyVending('${it.id}',${it.c},${it.e})" ${S.coins<it.c?'disabled':''} class="ibtn btn-blue">Buy</button></div>`;
  h+=`<button onclick="closeVending()" style="width:100%;margin-top:8px;padding:6px;border-radius:6px;background:rgba(100,116,139,.3);color:#94a3b8;border:1px solid rgba(255,255,255,.1);font-size:11px;cursor:pointer;">Close âœ•</button>`;
  return h;
}

function buyVending(id,cost,energy){
  if(S.coins<cost)return logChat('[Vending] Need $'+cost+' USD.');
  S.coins-=cost;S.energy=clamp(S.energy+energy,0,S.energyMax);
  updateHUD();renderBuildingPanel();
  logChat('[Vending] '+( id==='drink'?'âš¡':id==='burger'?'ğŸ”':id==='coffee'?'â˜•':'ğŸ’§')+' +'+energy+' energy! (-$'+cost+' USD)',false,'#34d399');
  treasuryPay('VEND:'+id,cost);
  saveProgress();
}
window.buyVending=buyVending;

function closeVending(){WS.outdoor=null;renderBuildingPanel();}
window.closeVending=closeVending;

/* â”€â”€ Tap/Click Interact â”€â”€
   Called from the Phaser pointerdown event AND from the sidebar Interact button.
   sceneRef is optional â€“ the function reads the global `interior` / WS state.
*/
let _phaserScene=null; // set in create()
function triggerInteract(sceneRef){
  const scene=sceneRef||_phaserScene;if(!scene)return;
  if(WS.zone==='CITY'){
    const{poi,d}=nearPOI(scene.me.x,scene.me.y);
    /* Check player's own farm plots */
    let plotIdx=null,plotDist=Infinity;
    for(let i=0;i<S.plots.length;i++){
      const p=S.plots[i];
      const d2=Math.hypot(scene.me.x-(p.tx+.5)*TILE,scene.me.y-(p.ty+.5)*TILE);
      if(d2<IDIST&&d2<plotDist){plotDist=d2;plotIdx=i;}
    }
    /* Check NPC plots */
    for(const np of _npcPlots){
      const d2=Math.hypot(scene.me.x-(np.tx+.5)*TILE,scene.me.y-(np.ty+.5)*TILE);
      if(d2<IDIST&&d2<plotDist){
        logChat('[Farm] ğŸ”’ This plot belongs to '+np.owner+' â€” cannot interact.',false,'#f87171');
        return;
      }
    }
    /* Priority: building/IACT > own plot > nothing */
    if(poi&&d<IDIST){
      if(BLDGS.find(b=>b.key===poi.key))enterBuilding(scene,poi.key);
      else doIAct(poi.key.toLowerCase());
    }else if(plotIdx!==null){
      _nearPlotIdx=plotIdx;WS.outdoor='Farm';renderBuildingPanel();
      logChat('[Farm] ğŸŒ± Your farm plot. Check status & manage.',false,'#4ade80');
    }else{
      if(WS.outdoor){WS.outdoor=null;renderBuildingPanel();}
      else logChat('[info] Nothing nearby. Walk closer to a building then tap.',false,'#94a3b8');
    }
  }else{
    const ex=(interior.exitX+.5)*TILE,ey=(interior.exitY+.5)*TILE;
    if(Math.hypot(scene.me.x-ex,scene.me.y-ey)<120)exitCity(scene);
    else renderBuildingPanel();
  }
}
window.triggerInteract=triggerInteract;

/* â”€â”€ Private Chat (PM) â”€â”€
   Shows up to 8 online players; clicking a name prefills the chat input
   with "@Name: " so the message is shown as a private message in the log.
*/
function renderPMList(){
  const el=document.getElementById('pmList');if(!el)return;
  const ids=[...onlineIds].slice(0,PM_LIST_MAX);
  if(!ids.length){el.innerHTML='<div style="color:#64748b;padding:2px;">No players online.</div>';return;}
  el.innerHTML=ids.map(i=>{
    const p=PPOOL[i];
    return`<span onclick="openPM('${p.name}')" style="display:inline-block;margin:2px 3px;padding:2px 7px;border-radius:999px;border:1px solid rgba(99,102,241,.4);background:rgba(99,102,241,.1);color:#a5b4fc;cursor:pointer;font-size:11px;">ğŸ‘¤ ${p.name}</span>`;
  }).join('')+'<div style="font-size:9px;color:#475569;margin-top:4px;">+ '+(onlineIds.size-Math.min(8,onlineIds.size))+' more online</div>';
}
function openPM(name){
  const inp=document.getElementById('chatIn');if(!inp)return;
  inp.value='@'+name+': ';inp.focus();
}
window.openPM=openPM;
function getSaveKey(){return'mogaWorld_'+(walletAddress||'guest');}

/* â”€â”€ Helpers â”€â”€ */
function fmtCountdown(ms){
  const s=Math.max(0,Math.ceil(ms/1000));
  return s>3600?Math.ceil(s/3600)+'h '+Math.floor((s%3600)/60)+'m':s>60?Math.ceil(s/60)+'m '+(s%60)+'s':s+'s';
}

/* â”€â”€ Farm plot graphics â”€â”€ */
function redrawFarmPlots(){
  if(!_phaserScene)return;
  if(!_farmGfx||!_farmGfx.active){_farmGfx=_phaserScene.add.graphics().setDepth(2);}
  _farmGfx.clear();
  if(WS.zone!=='CITY'){_farmGfx.setVisible(false);return;}
  _farmGfx.setVisible(true);
  const cols={hoed:0x78350f,seeded:0xfbbf24,watered:0x38bdf8,ready:0x4ade80};
  /* Player's own plots */
  for(const p of S.plots){
    _farmGfx.fillStyle(cols[p.state]||0x78350f,0.8);
    _farmGfx.fillRect(p.tx*TILE,p.ty*TILE,TILE,TILE);
    _farmGfx.lineStyle(1,0xffffff,0.35);
    _farmGfx.strokeRect(p.tx*TILE,p.ty*TILE,TILE,TILE);
  }
  /* NPC plots â€“ dimmer, different tint to show other players' areas */
  for(const np of _npcPlots){
    _farmGfx.fillStyle(cols[np.state]||0x78350f,0.35);
    _farmGfx.fillRect(np.tx*TILE,np.ty*TILE,TILE,TILE);
    _farmGfx.lineStyle(1,0x94a3b8,0.5);
    _farmGfx.strokeRect(np.tx*TILE,np.ty*TILE,TILE,TILE);
  }
}

/* â”€â”€ River panel â”€â”€ */
function renderRiver(){
  let h=`<strong>ğŸï¸ River</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">Fill watering can Â· Go fishing</div>`;
  /* Watering can */
  if(S.inv.wateringCan){
    const full=S.waterFull;
    h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ’§ Fill Watering Can</div>
<div class="idesc">${full?'ğŸŸ¦ Already full':'ğŸ”² Empty â€” fill from river'}</div></div>
<button onclick="fillWateringCan()" ${full?'disabled':''} class="ibtn btn-blue">Fill</button></div>`;
  }else{
    h+=`<div style="font-size:10px;color:#64748b;margin:5px 0;">ğŸª£ Need a Watering Can (buy at Market).</div>`;
  }
  /* Fishing */
  if(S.inv.fishingRod){
    h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ£ Go Fishing</div>
<div class="idesc">âˆ’${FISH_ENERGY_COST} energy Â· 1 bait Â· ${S.inv.bait} bait remaining</div></div>
<button onclick="goFish()" ${S.energy<FISH_ENERGY_COST||!S.inv.bait?'disabled':''} class="ibtn btn-teal">Fish</button></div>`;
    if(!S.inv.bait)h+=`<div style="font-size:10px;color:#f87171;margin:3px 0;">ğŸª± No bait! Buy at Market.</div>`;
  }else{
    h+=`<div style="font-size:10px;color:#64748b;margin:5px 0;">ğŸ£ Need a Fishing Rod + Bait (buy at Market).</div>`;
  }
  h+=`<button onclick="closeOutdoor()" style="width:100%;margin-top:8px;padding:6px;border-radius:6px;background:rgba(100,116,139,.3);color:#94a3b8;border:1px solid rgba(255,255,255,.1);font-size:11px;">Close âœ•</button>`;
  return h;
}

/* â”€â”€ Farm panel â”€â”€ */
function renderFarm(){
  let h=`<strong>ğŸŒ± Your Farm Plot</strong><div style="font-size:10px;color:#94a3b8;margin:3px 0;">Plant Â· Water Â· Harvest Â· Land resets after harvest</div>`;
  if(_nearPlotIdx===null||!S.plots[_nearPlotIdx]){
    h+=`<div style="font-size:11px;color:#64748b;margin:8px 0;">No plot data â€” walk near a plot and tap again.</div>`;
    h+=`<button onclick="closeOutdoor()" style="width:100%;margin-top:6px;padding:6px;border-radius:6px;background:rgba(100,116,139,.3);color:#94a3b8;border:1px solid rgba(255,255,255,.1);font-size:11px;">Close âœ•</button>`;
    return h;
  }
  const p=S.plots[_nearPlotIdx],now=Date.now();
  const stateInfo={
    hoed:{label:'ğŸŸ« Hoed â€” ready for seeds',color:'#b45309'},
    seeded:{label:'ğŸŒ± Seeds planted â€” needs water',color:'#4ade80'},
    watered:{label:'ğŸ’§ Growingâ€¦',color:'#38bdf8'},
    ready:{label:'ğŸ‡ Ready to harvest!',color:'#a78bfa'},
  }[p.state]||{label:p.state,color:'#94a3b8'};
  h+=`<div style="font-size:11px;margin:5px 0;padding:7px;border:1px solid rgba(255,255,255,.1);border-radius:7px;background:rgba(255,255,255,.03);color:${stateInfo.color};">${stateInfo.label}`;
  if(p.state==='watered'&&p.readyAt>now)h+=`<br><span style="font-size:10px;color:#38bdf8;">â³ Ready in: ${fmtCountdown(p.readyAt-now)}</span>`;
  h+=`</div>`;
  if(p.state==='hoed')h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸŒ± Plant Seeds</div>
<div class="idesc">${S.inv.seeds} seeds in inventory</div></div>
<button onclick="plantSeed(${_nearPlotIdx})" ${!S.inv.seeds?'disabled':''} class="ibtn btn-green">Plant</button></div>`;
  if(p.state==='seeded')h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ’§ Water Plant</div>
<div class="idesc">Can: ${S.inv.wateringCan?(S.waterFull?'ğŸ’§ Full':'ğŸ”² Empty â€” fill at River'):'Need watering can'}</div></div>
<button onclick="waterSeed(${_nearPlotIdx})" ${!S.inv.wateringCan||!S.waterFull?'disabled':''} class="ibtn btn-blue">Water</button></div>`;
  if(p.state==='ready')h+=`<div class="irow"><div class="ileft"><div class="iname">ğŸ‡ Harvest Fruit</div>
<div class="idesc">+1 fruit Â· Land resets after harvest</div></div>
<button onclick="harvestFruit(${_nearPlotIdx})" class="ibtn btn-green">Harvest ğŸ‡</button></div>`;
  h+=`<button onclick="closeOutdoor()" style="width:100%;margin-top:8px;padding:6px;border-radius:6px;background:rgba(100,116,139,.3);color:#94a3b8;border:1px solid rgba(255,255,255,.1);font-size:11px;">Close âœ•</button>`;
  return h;
}

/* â”€â”€ Fishing â”€â”€ */
function goFish(){
  if(!S.inv.fishingRod)return logChat('[River] Need a ğŸ£ Fishing Rod. Buy at Market.');
  if(!S.inv.bait)return logChat('[River] Need ğŸª± Bait. Buy at Market.');
  if(!reqEnergy(FISH_ENERGY_COST,'[River] Too tired to fish. Need '+FISH_ENERGY_COST+' energy.'))return;
  S.inv.bait--;
  const catches=['ğŸŸ Tilapia','ğŸ  Clownfish','ğŸ¡ Pufferfish','ğŸ¦ Shrimp','ğŸ¦‘ Squid','ğŸ¦ Lobster','ğŸ™ Octopus'];
  const fail=Math.random()<FISH_MISS_RATE;
  if(fail){logChat('[River] ğŸ£ Nothing bitingâ€¦ bait used.',false,'#64748b');}
  else{S.inv.fish++;logChat('[River] ğŸ£ Caught: '+catches[Math.floor(Math.random()*catches.length)]+'! (+1 fish)',false,'#34d399');}
  updateHUD();renderBuildingPanel();saveProgress();
}
window.goFish=goFish;

/* â”€â”€ Watering can â”€â”€ */
function fillWateringCan(){
  if(!S.inv.wateringCan)return logChat('[River] Need a ğŸª£ Watering Can. Buy at Market.');
  if(S.waterFull)return logChat('[River] Watering can already full!');
  S.waterFull=true;renderBuildingPanel();
  logChat('[River] ğŸ’§ Watering can filled!',false,'#38bdf8');
  saveProgress();
}
window.fillWateringCan=fillWateringCan;

/* â”€â”€ Hoe ground â”€â”€ */
function hoeGround(){
  if(!_phaserScene||WS.zone!=='CITY')return logChat('[Farm] Must be in CITY to hoe ground.');
  if(!S.inv.hoe)return logChat('[Farm] Need a ğŸª“ Hoe (Cangkul). Buy at Market.');
  if(!reqEnergy(HOE_ENERGY_COST,'[Farm] Need '+HOE_ENERGY_COST+' energy to hoe.'))return;
  const tx=Math.floor(_phaserScene.me.x/TILE),ty=Math.floor(_phaserScene.me.y/TILE);
  if(!cityTiles||cityTiles[ty]?.[tx]!==TT.G)return logChat('[Farm] Must stand on grass (not road/water) to hoe.',false,'#f87171');
  if(S.plots.find(p=>p.tx===tx&&p.ty===ty))return logChat('[Farm] Already a plot here!',false,'#f87171');
  if(_npcPlots.find(p=>p.tx===tx&&p.ty===ty))return logChat('[Farm] ğŸ”’ This area belongs to another player.',false,'#f87171');
  S.plots.push({tx,ty,state:'hoed',plantedAt:0,readyAt:0});
  updateHUD();redrawFarmPlots();
  logChat('[Farm] ğŸª“ Hoed the ground! Now plant seeds here.',false,'#b45309');
  saveProgress();
}
window.hoeGround=hoeGround;

/* â”€â”€ Farming â”€â”€ */
function plantSeed(idx){
  const p=S.plots[idx];if(!p||p.state!=='hoed')return logChat('[Farm] Plot not ready for planting.');
  if(!S.inv.seeds)return logChat('[Farm] No seeds. Buy at Market.');
  S.inv.seeds--;p.state='seeded';p.plantedAt=Date.now();
  updateHUD();renderBuildingPanel();redrawFarmPlots();
  logChat('[Farm] ğŸŒ± Seeds planted! Water them to start growing.',false,'#4ade80');
  saveProgress();
}
window.plantSeed=plantSeed;

function waterSeed(idx){
  const p=S.plots[idx];if(!p||p.state!=='seeded')return logChat('[Farm] Nothing to water here.');
  if(!S.inv.wateringCan)return logChat('[Farm] Need a ğŸª£ Watering Can.');
  if(!S.waterFull)return logChat('[Farm] Watering can empty! Fill at ğŸï¸ River.',false,'#f87171');
  p.state='watered';p.readyAt=Date.now()+SEED_GROW_MS;S.waterFull=false;
  updateHUD();renderBuildingPanel();redrawFarmPlots();
  logChat('[Farm] ğŸ’§ Watered! Fruit ready in ~'+Math.ceil(SEED_GROW_MS/60000)+'m.',false,'#38bdf8');
  saveProgress();
}
window.waterSeed=waterSeed;

function harvestFruit(idx){
  const p=S.plots[idx];if(!p||p.state!=='ready')return logChat('[Farm] Not ready yet.');
  S.inv.fruit++;
  S.plots.splice(idx,1); // remove plot â†’ land resets
  _nearPlotIdx=null;WS.outdoor=null;
  updateHUD();renderBuildingPanel();redrawFarmPlots();
  logChat('[Farm] ğŸ‡ Harvested! +1 fruit. Land returned to normal.',false,'#a78bfa');
  saveProgress();
}
window.harvestFruit=harvestFruit;

/* â”€â”€ Market: buy tools & supplies (all on-chain) â”€â”€ */
function buyTool(type,cost){
  if(S.coins<cost)return logChat('[Market] Need $'+cost+' USD.');
  const unique=['fishingRod','wateringCan','hoe'];
  if(unique.includes(type)&&S.inv[type]>0)return logChat('[Market] Already own that item.');
  S.coins-=cost;
  if(type==='seeds')S.inv.seeds+=3;
  else if(type==='bait')S.inv.bait+=5;
  else S.inv[type]++;
  const names={fishingRod:'ğŸ£ Fishing Rod',bait:'ğŸª± Bait Ã—5',wateringCan:'ğŸª£ Watering Can',hoe:'ğŸª“ Hoe (Cangkul)',seeds:'ğŸŒ± Seeds Ã—3'};
  onChainTx('BUY:market:'+type+':$'+cost+'USD',0.00001);
  updateHUD();renderBuildingPanel();
  logChat('[Market] ğŸ›’ Bought: '+(names[type]||type)+'! (on-chain tx sent)',false,'#34d399');
  saveProgress();
}
window.buyTool=buyTool;

/* â”€â”€ Market: sell fish / fruit (on-chain) â”€â”€ */
function sellItem(type){
  if(!S.inv[type]||S.inv[type]<=0)return logChat('[Market] No '+type+' to sell.');
  const prices={fish:FISH_SELL_PRICE,fruit:FRUIT_SELL_PRICE};
  const price=prices[type];if(!price)return;
  S.inv[type]--;S.coins+=price;
  onChainTx('SELL:market:'+type+':+$'+price+'USD',0.00001);
  updateHUD();renderBuildingPanel();
  logChat('[Market] ğŸ’° Sold 1 '+type+': +$'+price+' USD! (on-chain tx sent)',false,'#fbbf24');
  saveProgress();
}
window.sellItem=sellItem;

function closeOutdoor(){WS.outdoor=null;renderBuildingPanel();}
window.closeOutdoor=closeOutdoor;

function saveProgress(){
  try{
    const data={
      coins:S.coins,learnedSkills:S.learnedSkills,learningId:S.learningId,learningEndTime:S.learningEndTime,
      job:S.job,energy:S.energy,energyMax:S.energyMax,house:S.house,
      inv:{...S.inv},workCDs:{...workCDs},
      waterFull:S.waterFull,plots:S.plots.map(p=>({...p})),
      savedAt:Date.now(),
    };
    localStorage.setItem(getSaveKey(),JSON.stringify(data));
  }catch(e){console.log('[Save] Error:',e.message);}
}
window.saveProgress=saveProgress;

function loadProgress(){
  try{
    const raw=localStorage.getItem(getSaveKey());if(!raw)return;
    const d=JSON.parse(raw);
    S.coins=typeof d.coins==='number'?d.coins:100;
    S.learnedSkills=Array.isArray(d.learnedSkills)?d.learnedSkills:[];
    S.learningId=d.learningId||null;
    S.learningEndTime=typeof d.learningEndTime==='number'?d.learningEndTime:0;
    S.job=d.job||'Unemployed';
    S.energy=typeof d.energy==='number'?d.energy:100;
    S.energyMax=typeof d.energyMax==='number'?d.energyMax:100;
    S.house=typeof d.house==='number'?d.house:1;
    S.inv=d.inv?{
      apple:d.inv.apple||0,soda:d.inv.soda||0,sandwich:d.inv.sandwich||0,
      fishingRod:d.inv.fishingRod||0,bait:d.inv.bait||0,wateringCan:d.inv.wateringCan||0,
      hoe:d.inv.hoe||0,seeds:d.inv.seeds||0,fish:d.inv.fish||0,fruit:d.inv.fruit||0,
    }:{apple:1,soda:0,sandwich:0,fishingRod:0,bait:0,wateringCan:0,hoe:0,seeds:0,fish:0,fruit:0};
    if(d.workCDs&&typeof d.workCDs==='object')Object.assign(workCDs,d.workCDs);
    S.waterFull=d.waterFull||false;
    S.plots=Array.isArray(d.plots)?d.plots.filter(p=>p&&p.state):[];
    /* Restore in-progress learning timeout */
    if(S.learningEndTime>Date.now()&&S.learningId){
      const remMs=S.learningEndTime-Date.now(),lid=S.learningId;
      setTimeout(()=>{
        const sk=SKILLS.find(s=>s.id===lid);if(!sk)return;
        if(!S.learnedSkills.includes(lid))S.learnedSkills.push(lid);
        S.learningId=null;S.learningEndTime=0;S.job=sk.job;
        updateHUD();renderBuildingPanel();
        logChat('[School] âœ… Graduated: '+sk.name+'!',false,'#22c55e');
        saveProgress();
      },remMs);
    }else{S.learningId=null;S.learningEndTime=0;}
    const ago=d.savedAt?Math.round((Date.now()-d.savedAt)/1000):0;
    logChat('[Save] âœ… Progress loaded! (saved '+(ago<60?ago+'s':Math.round(ago/60)+'m')+' ago)',false,'#34d399');
  }catch(e){console.log('[Save] Load failed:',e.message);}
}

/* nav */
function populateNav(){
  const sel=document.getElementById('navSel');
  BLDGS.forEach(b=>{const o=document.createElement('option');o.value=b.key;o.textContent=b.key;sel.appendChild(o);});
  IACTS.forEach(i=>{const o=document.createElement('option');o.value=i.key;o.textContent=i.key;sel.appendChild(o);});
}
document.getElementById('btnGo').onclick=()=>{
  if(WS.zone!=='CITY')return logChat('[nav] Only in CITY.');
  const k=document.getElementById('navSel').value;if(!k)return;
  const all=[...BLDGS.map(b=>({key:b.key,x:b.x+b.w/2,y:b.y+b.h/2})),...IACTS.map(i=>({key:i.key,x:i.x+i.w/2,y:i.y+i.h/2}))];
  const f=all.find(t=>t.key===k);if(!f)return;
  NAV.key=k;NAV.pos={x:f.x,y:f.y};document.getElementById('mmTgt').textContent=k;logChat('[nav] Target: '+k);
};
document.getElementById('btnClear').onclick=()=>{document.getElementById('navSel').value='';NAV.key='';NAV.pos=null;document.getElementById('mmTgt').textContent='â€”';};

/* chat input */
document.getElementById('btnSend').onclick=()=>{
  const inp=document.getElementById('chatIn');const t=inp.value.trim();if(!t)return;inp.value='';
  const l=t.toLowerCase();
  if(l==='buy soda'){if(S.coins<1)logChat('[Vending] Need $1 USD.');else{S.coins-=1;S.inv.soda++;updateHUD();logChat('[Vending] Soda +1 (+20 energy when used)');}}
  else if(l==='buy sandwich'){if(S.coins<1)logChat('[Vending] Need $1 USD.');else{S.coins-=1;S.inv.sandwich++;updateHUD();logChat('[Vending] Sandwich +1 (+45 energy when used)');}}
  else if(t.startsWith('@')){
    /* Private message: @PlayerName: message */
    const me=walletAddress?walletAddress.slice(0,6)+'â€¦':'YOU';
    logChat('[PM] '+me+' â†’ '+t,true,'#f0abfc');
  }else{
    const me=walletAddress?walletAddress.slice(0,6)+'â€¦':'YOU';
    logChat('['+me+'] '+t,true,'#93c5fd');
  }
};
document.getElementById('chatIn').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('btnSend').click();});

/* Phaser */
const phaserCfg={
  type:Phaser.AUTO,parent:'game',
  width:Math.max(400,window.innerWidth-320),height:Math.max(300,window.innerHeight),
  backgroundColor:'#0b1020',pixelArt:true,
  scene:{
    preload(){document.getElementById('loading').textContent='Loadingâ€¦';makeTextures(this);},
    create(){
      document.getElementById('loading').style.display='none';
      this.me=this.add.container(32*TILE,32*TILE).setDepth(10);
      const meLabel=walletAddress?walletAddress.slice(0,6)+'â€¦':'YOU';
      this.me.add([this.add.image(0,0,'cat').setScale(2.0).setOrigin(.5,.62),
                   this.add.text(-24,-52,meLabel,{fontSize:'12px',color:'#a5f3fc',fontStyle:'bold'})]);
      this.cameras.main.startFollow(this.me,true,.12,.12);this.cameras.main.setZoom(1.3);
      this.cursors=this.input.keyboard.createCursorKeys();
      this.keys=this.input.keyboard.addKeys('W,A,S,D,SHIFT');
      _phaserScene=this;
      /* Tap / click anywhere on the game canvas to interact with nearest POI */
      this.input.on('pointerdown',()=>triggerInteract(this));
      drawCity(this);populateNav();updateHUD();
      nightOv=this.add.rectangle(0,0,this.scale.width,this.scale.height,0x020617,1).setOrigin(0,0).setScrollFactor(0).setDepth(999);nightOv.setAlpha(.08);
      this.scale.on('resize',sz=>{if(nightOv){nightOv.width=sz.width;nightOv.height=sz.height;}});
      initChain();initOnlinePlayers();
      loadProgress();updateHUD();
      spawnNPCBots(this);
      logChat('[system] ğŸ® Welcome to Moga World! Skills cost $30 USD Â· Work earns $2 USD/3h shift',false,'#fbbf24');
      logChat('[system] ğŸ« Visit School to learn skills Â· ğŸ¥¤ Vending machine: $1 USD/item Â· ğŸ›ï¸ Bed restores energy',false,'#a78bfa');
      logChat('[system] Tap/click near a building to enter Â· Enter Casino for 100-player game ğŸ°',false,'#34d399');
      logChat('[system] ğŸ£ Buy Fishing Rod + Bait at Market Â· ğŸª“ Buy Hoe to farm grass tiles Â· ğŸï¸ River to fill can & fish',false,'#4ade80');
      this.time.addEvent({delay:200,loop:true,callback:()=>{
        const btn=document.getElementById('btnInteract');
        if(WS.zone==='CITY'){
          const{poi,d}=nearPOI(this.me.x,this.me.y);
          /* Hoe button visibility: player on grass, not on a plot, owns hoe */
          const tx=Math.floor(this.me.x/TILE),ty=Math.floor(this.me.y/TILE);
          const onGrass=cityTiles&&ty>=0&&ty<CH&&tx>=0&&tx<CW&&cityTiles[ty]&&cityTiles[ty][tx]===TT.G;
          const noPlot=!S.plots.find(p=>p.tx===tx&&p.ty===ty)&&!_npcPlots.find(p=>p.tx===tx&&p.ty===ty);
          const btnHoe=document.getElementById('btnHoe');
          if(btnHoe)btnHoe.style.display=(S.inv.hoe>0&&onGrass&&noPlot&&WS.zone==='CITY')?'block':'none';
          /* Nearest label (building, IACT, or own farm plot) */
          let plotIdx=null,plotDist=Infinity;
          for(let i=0;i<S.plots.length;i++){
            const p=S.plots[i];
            const d2=Math.hypot(this.me.x-(p.tx+.5)*TILE,this.me.y-(p.ty+.5)*TILE);
            if(d2<IDIST&&d2<plotDist){plotDist=d2;plotIdx=i;}
          }
          const nearBldg=poi&&d<IDIST;
          const nearLabel=nearBldg?poi.key:plotIdx!==null?'Farm Plot':'â€”';
          document.getElementById('elNear').textContent=nearLabel+(nearLabel!=='â€”'?' (tap)':'');
          if(btn){btn.style.display=(nearBldg||plotIdx!==null)?'block':'none';btn.textContent='ğŸ‘† Enter '+(nearLabel!=='â€”'?nearLabel:'');}
        }else{
          const ex=(interior.exitX+.5)*TILE,ey=(interior.exitY+.5)*TILE;
          const dd=Math.hypot(this.me.x-ex,this.me.y-ey);
          document.getElementById('elNear').textContent=dd<120?'EXIT (tap)':WS.key+' (tap)';
          if(btn){btn.style.display='block';btn.textContent=dd<120?'ğŸ‘† Exit Building':'ğŸ‘† Open Panel';}
          const btnHoe=document.getElementById('btnHoe');if(btnHoe)btnHoe.style.display='none';
        }
      }});
      /* 1-second refresh: panel countdowns + farm growth check */
      this.time.addEvent({delay:1000,loop:true,callback:()=>{
        /* Refresh building panel only when live countdowns / outdoor panels are active */
        const needsRefresh=(WS.zone==='INTERIOR'&&(S.learningEndTime>Date.now()||S.workLockEnd>Date.now()))||
                           (WS.zone==='CITY'&&WS.outdoor)||(WS.zone==='INTERIOR');
        if(needsRefresh)renderBuildingPanel();
        /* Check if any watered plots are ready */
        let changed=false;
        for(const p of S.plots){
          if(p.state==='watered'&&p.readyAt>0&&Date.now()>=p.readyAt){
            p.state='ready';changed=true;
            logChat('[Farm] ğŸ‡ A fruit is ready to harvest! Visit your plot.',false,'#4ade80');
          }
        }
        if(changed){redrawFarmPlots();saveProgress();}
      }});
      /* NPC farm activity messages */
      this.time.addEvent({delay:NPC_FARM_MSG_MS,loop:true,callback:()=>{
        if(Math.random()<NPC_FARM_MSG_CHANCE){
          const np=_npcPlots[Math.floor(Math.random()*_npcPlots.length)];
          const msgs=['just watered crops ğŸ’§','harvested fruit ğŸ‡','planted new seeds ğŸŒ±','caught 2 fish at the river ğŸ£'];
          logChat('['+np.owner+'] '+msgs[Math.floor(Math.random()*msgs.length)],false,'#86efac');
        }
      }});
      /* auto-save every 30 seconds */
      this.time.addEvent({delay:30000,loop:true,callback:()=>saveProgress()});
      /* low-energy warning every 5 seconds */
      this.time.addEvent({delay:5000,loop:true,callback:()=>{if(S.energy<ENERGY_LOW_THRESHOLD&&!S.sleeping)logChat('[âš ï¸] Low energy! Visit vending machine or sleep at home.',false,'#f87171');}});
    },
    update(_,dt){
      const dtS=dt/1000;updateDN(dtS);
      updateNPCBots(dtS);
      if(S.sleeping)return;
      const spr=this.keys.SHIFT.isDown&&S.energy>0,spd=spr?380:240;
      let vx=0,vy=0;
      if(this.cursors.up.isDown||this.keys.W.isDown)vy-=1;
      if(this.cursors.down.isDown||this.keys.S.isDown)vy+=1;
      if(this.cursors.left.isDown||this.keys.A.isDown)vx-=1;
      if(this.cursors.right.isDown||this.keys.D.isDown)vx+=1;
      if(vx&&vy){vx*=.7071;vy*=.7071;}
      const mv=(vx||vy),nx=this.me.x+vx*spd*dtS,ny=this.me.y+vy*spd*dtS;
      if(WS.zone==='CITY'){
        const cx=clamp(nx,20,CW*TILE-20),cy=clamp(ny,20,CH*TILE-20);
        if(!blocked(cx,cy,cityTiles)){this.me.x=cx;this.me.y=cy;}
        else{if(!blocked(cx,this.me.y,cityTiles))this.me.x=cx;if(!blocked(this.me.x,cy,cityTiles))this.me.y=cy;}
      }else{this.me.x=clamp(nx,20,IW*TILE-20);this.me.y=clamp(ny,20,IH*TILE-20);}
      /* Passive energy drain: depletes over 1 real hour (3600 real seconds).
         Rate: 100/3600 â‰ˆ 0.028 per real second. Sprint adds extra drain. */
      const drainRate=spr&&mv?ENERGY_DRAIN_SPRINT:ENERGY_DRAIN_PASSIVE;
      S.energy=clamp(S.energy-drainRate*dtS,0,S.energyMax);
      updateHUD();drawMM({x:this.me.x,y:this.me.y});
    }
  }
};
const game=new Phaser.Game(phaserCfg);
window.addEventListener('resize',()=>{game.scale.resize(Math.max(400,window.innerWidth-320),Math.max(300,window.innerHeight));});
updateHUD();
renderTxHistory();
})();
</script>
</body>
</html>
