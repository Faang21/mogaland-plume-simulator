<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moga World</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#0b1020; font-family:Arial,sans-serif; color:#e8e8e8; overflow:hidden; }
    #wrap { display:flex; height:100%; }
    #game { flex:1; position:relative; background:#0b1020; }

    #ui {
      width:340px; border-left:1px solid rgba(255,255,255,.15);
      padding:12px; box-sizing:border-box; background:rgba(0,0,0,.45);
      overflow-y:auto; display:flex; flex-direction:column; gap:10px;
    }
    .card { border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:12px; background:rgba(255,255,255,.06); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, input, select {
      border-radius:10px; border:1px solid rgba(255,255,255,.22); background:rgba(255,255,255,.08);
      color:#fff; padding:8px 12px; font-size:13px;
    }
    button { cursor:pointer; }
    button:hover { background:rgba(255,255,255,.18); }
    button:disabled { opacity:.4; cursor:not-allowed; }
    #log { height:120px; overflow:auto; font-size:12px; line-height:1.4; padding:8px; background:rgba(0,0,0,.35); border-radius:10px; border:1px solid rgba(255,255,255,.15); }
    #log div { margin:2px 0; }
    .muted { opacity:.7; font-size:12px; }
    .stat { display:grid; grid-template-columns:1fr auto; gap:4px; font-size:13px; }
    .pill { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.05); }
    kbd { padding:1px 5px; border-radius:5px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); font-size:11px; }
    .bar { height:10px; border-radius:999px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); overflow:hidden; margin:3px 0; }
    .bar > div { height:100%; width:100%; background:rgba(34,197,94,.8); transition:width 0.2s; }

    #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:20px; color:#fbbf24; z-index:100; text-align:center; }
    #errOverlay { position:absolute; left:8px; bottom:8px; z-index:200; background:rgba(0,0,0,.7); border:1px solid rgba(255,255,255,.18); border-radius:10px; padding:8px 10px; max-width:600px; display:none; white-space:pre-wrap; font-size:11px; color:#fecaca; }

    #minimap { position:absolute; right:8px; top:8px; width:180px; height:200px; background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.18); border-radius:12px; z-index:50; padding:8px; box-sizing:border-box; user-select:none; pointer-events:none; }
    #minimap .title { font-size:11px; opacity:.9; display:flex; justify-content:space-between; margin-bottom:6px; }
    #minimap canvas { width:100%; height:calc(100% - 36px); border-radius:8px; background:rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.10); image-rendering:pixelated; }
    #clock { margin-top:6px; font-size:11px; opacity:.85; display:flex; justify-content:space-between; }

    /* Wallet info bar */
    #walletBar { background:linear-gradient(90deg,rgba(16,185,129,.15),rgba(96,165,250,.15)); border:1px solid rgba(16,185,129,.3); border-radius:10px; padding:8px 12px; font-size:12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    #walletBar .addr { font-family:monospace; color:#34d399; }

    /* Multiplier game */
    #mulPanel { display:none; }
    #mulPanel.active { display:block; }
    #mulGraph { width:100%; height:80px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#0f172a; }
    .mul-num { font-size:32px; font-weight:bold; text-align:center; padding:8px 0; }
    .mul-green { color:#22c55e; }
    .mul-red { color:#ef4444; }
    .mul-yellow { color:#fbbf24; }
    #mulPlayers { max-height:90px; overflow-y:auto; font-size:11px; }
    #mulPlayers .p-row { display:flex; justify-content:space-between; padding:2px 4px; border-bottom:1px solid rgba(255,255,255,.06); }
    .p-cashed { color:#22c55e; }
    .p-playing { color:#fbbf24; }
    .p-lost { color:#ef4444; opacity:.6; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="game">
    <div id="loading">Loading Moga World...</div>
    <div id="errOverlay"></div>
    <div id="minimap">
      <div class="title">
        <span id="mmLoc">CITY</span>
        <span id="mmTarget" style="opacity:.8;">Target: -</span>
      </div>
      <canvas id="mmCanvas" width="128" height="128"></canvas>
      <div id="clock"><span id="tod">Day</span><span id="timeTxt">06:00</span></div>
    </div>
  </div>

  <aside id="ui">
    <!-- Wallet bar -->
    <div id="walletBar">
      <span>ğŸ”— Wallet</span>
      <span class="addr" id="walletAddr">Not connected</span>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>Moga World</strong>
        <span class="pill" id="modePill">CITY</span>
      </div>
      <small class="muted" style="display:block;margin-top:5px;">
        Move: <kbd>WASD</kbd>/<kbd>â†‘â†“â†â†’</kbd> Â· Sprint: <kbd>Shift</kbd> Â· Interact: <kbd>E</kbd>
      </small>
    </div>

    <div class="card stat">
      <div>Coins</div><div id="coins">0</div>
      <div>Education</div><div id="edu">None</div>
      <div>Job</div><div id="job">Locked</div>
      <div>House Lv</div><div id="house">1</div>
      <div>Stamina Max</div><div id="stMax">100</div>
      <div>Nearest</div><div id="near" class="muted">-</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;"><strong>Stamina</strong><span id="stTxt">100/100</span></div>
      <div class="bar"><div id="stBar"></div></div>
    </div>

    <div class="card">
      <strong>Inventory</strong>
      <div class="row" style="margin-top:8px;">
        <div class="pill">Apple: <span id="apple">1</span></div>
        <div class="pill">Soda: <span id="soda">0</span></div>
        <div class="pill">Sand: <span id="sandwich">0</span></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="eatApple">ğŸ</button>
        <button id="drinkSoda">ğŸ¥¤</button>
        <button id="eatSandwich">ğŸ¥ª</button>
      </div>
    </div>

    <div class="card">
      <strong>Navigate (CITY)</strong>
      <div class="row" style="margin-top:8px;">
        <select id="navTarget" style="flex:1;"><option value="">Choose target...</option></select>
        <button id="setTarget">Go</button>
        <button id="clearTarget">âœ•</button>
      </div>
    </div>

    <!-- Multiplier Game Panel (shows when inside Casino) -->
    <div class="card" id="mulPanel">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <strong>ğŸ° Multiplier Game</strong>
        <span class="pill" id="mulRound">Round 1</span>
      </div>
      <canvas id="mulGraph"></canvas>
      <div class="mul-num" id="mulNum">1.00x</div>

      <div id="mulState" style="font-size:12px;text-align:center;margin-bottom:8px;color:#94a3b8;">
        Waiting for next round...
      </div>

      <div class="row" style="margin-bottom:8px;">
        <input type="number" id="mulBet" placeholder="Bet (coins)" min="5" value="10" style="flex:1;"/>
        <button id="mulJoin" style="background:linear-gradient(90deg,#f59e0b,#d97706);border:none;">Join</button>
        <button id="mulCash" style="background:linear-gradient(90deg,#10b981,#059669);border:none;" disabled>Cash Out</button>
      </div>

      <div style="font-size:12px;color:#94a3b8;margin-bottom:6px;">Players this round:</div>
      <div id="mulPlayers"></div>
    </div>

    <div class="card">
      <strong>Chat</strong>
      <div id="log"></div>
      <div class="row" style="margin-top:8px;">
        <input id="chat" placeholder="Message..." style="flex:1;"/>
        <button id="send">Send</button>
      </div>
      <small class="muted">cmd: <code>buy soda</code>, <code>buy sandwich</code></small>
    </div>
  </aside>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
<script>
(() => {
  /* â”€â”€ Error overlay â”€â”€ */
  const errOverlay = document.getElementById('errOverlay');
  function showError(e) { errOverlay.style.display='block'; errOverlay.textContent=(e&&(e.stack||e.message))?(e.stack||e.message):String(e); }
  window.addEventListener('error', e=>showError(e.error||e.message));
  window.addEventListener('unhandledrejection', e=>showError(e.reason));

  /* â”€â”€ Wallet from URL / parent â”€â”€ */
  const params = new URLSearchParams(window.location.search);
  let walletAddress = params.get('wallet') || '';
  const elWalletAddr = document.getElementById('walletAddr');
  function setWalletDisplay() {
    if (walletAddress) {
      elWalletAddr.textContent = walletAddress.slice(0,6)+'...'+walletAddress.slice(-4);
    } else {
      elWalletAddr.textContent = 'Not connected';
    }
  }
  setWalletDisplay();
  // Also accept wallet updates from parent iframe
  window.addEventListener('message', (ev) => {
    if (ev.data && ev.data.type === 'walletUpdate') {
      walletAddress = ev.data.address || '';
      setWalletDisplay();
    }
  });

  /* â”€â”€ Helpers â”€â”€ */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const logLine=(t)=>{ const el=document.getElementById('log'); const d=document.createElement('div'); d.textContent=t; el.appendChild(d); el.scrollTop=el.scrollHeight; };

  const TILE=32, CITY_W=96, CITY_H=60, INT_W=34, INT_H=22, INTERACT_DIST=135;

  const elCoins=document.getElementById('coins'), elEdu=document.getElementById('edu'),
        elJob=document.getElementById('job'), elHouse=document.getElementById('house'),
        elNear=document.getElementById('near'), elApple=document.getElementById('apple'),
        elSoda=document.getElementById('soda'), elSandwich=document.getElementById('sandwich'),
        elStTxt=document.getElementById('stTxt'), elStBar=document.getElementById('stBar'),
        elStMax=document.getElementById('stMax'), loading=document.getElementById('loading'),
        modePill=document.getElementById('modePill');

  const mmCanvas=document.getElementById('mmCanvas'), mmCtx=mmCanvas.getContext('2d'),
        mmTargetTxt=document.getElementById('mmTarget'), mmLocTxt=document.getElementById('mmLoc'),
        navTargetSel=document.getElementById('navTarget');
  const elTod=document.getElementById('tod'), elTimeTxt=document.getElementById('timeTxt');

  const myState={
    coins:100, edu:'None', job:'Locked', house:1,
    stamina:100, staminaMax:100,
    inv:{apple:1,soda:0,sandwich:0},
    lastWorkAt:0, lastSchoolAt:0
  };
  const worldState={zone:'CITY', interiorKey:'', savedCityPos:{x:32*TILE,y:32*TILE}};
  const nav={targetKey:'', targetPos:null};
  const clock={minutes:6*60, speed:10};
  function formatTime(mins){const h=Math.floor(mins/60)%24,m=Math.floor(mins%60);return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');}

  function updateHUD(){
    elCoins.textContent=myState.coins;
    elEdu.textContent=myState.edu;
    elJob.textContent=myState.job;
    elHouse.textContent=myState.house;
    elApple.textContent=myState.inv.apple;
    elSoda.textContent=myState.inv.soda;
    elSandwich.textContent=myState.inv.sandwich;
    elStMax.textContent=myState.staminaMax;
    myState.stamina=clamp(myState.stamina,0,myState.staminaMax);
    const pct=(myState.stamina/myState.staminaMax)*100;
    elStTxt.textContent=`${Math.round(myState.stamina)}/${myState.staminaMax}`;
    elStBar.style.width=`${pct}%`;
    elStBar.style.background=myState.stamina>50?'rgba(34,197,94,.8)':myState.stamina>20?'rgba(251,191,36,.85)':'rgba(239,68,68,.9)';
    const label=worldState.zone==='CITY'?'CITY':worldState.interiorKey.toUpperCase();
    modePill.textContent=label; mmLocTxt.textContent=label;
    // Show multiplier panel only in Casino
    const mulPanel=document.getElementById('mulPanel');
    if(worldState.zone==='INTERIOR'&&worldState.interiorKey==='Casino'){
      mulPanel.classList.add('active');
    } else {
      mulPanel.classList.remove('active');
    }
  }

  /* â”€â”€ Textures â”€â”€ */
  function addCanvasTexture(scene,key,w,h,drawFn){
    const c=document.createElement('canvas');c.width=w;c.height=h;
    const ctx=c.getContext('2d');ctx.clearRect(0,0,w,h);drawFn(ctx);
    scene.textures.addCanvas(key,c);
  }
  function makeOrangeCatTexture(scene){
    addCanvasTexture(scene,'orangeCat',32,32,(ctx)=>{
      const px=(x,y,w,h,col)=>{ctx.fillStyle=col;ctx.fillRect(x,y,w,h);};
      px(7,26,18,4,'rgba(0,0,0,0.25)');
      px(24,18,5,2,'#f59e0b');px(26,16,3,2,'#f59e0b');px(27,14,3,2,'#f59e0b');px(28,12,3,2,'#f59e0b');
      px(9,14,14,12,'#f59e0b');px(8,16,2,8,'#f59e0b');px(23,16,2,8,'#f59e0b');
      px(10,6,12,10,'#f59e0b');px(10,4,3,3,'#f59e0b');px(19,4,3,3,'#f59e0b');
      px(11,5,1,1,'#fb7185');px(20,5,1,1,'#fb7185');
      px(12,8,1,6,'#d97706');px(16,8,1,6,'#d97706');px(20,8,1,6,'#d97706');
      px(13,16,8,1,'#d97706');px(12,19,10,1,'#d97706');
      px(13,10,2,2,'#111827');px(18,10,2,2,'#111827');px(16,12,1,1,'#ef4444');
      px(11,24,3,2,'#f59e0b');px(18,24,3,2,'#f59e0b');
    });
  }
  function makeBuildingTexture(scene,key,opts){
    addCanvasTexture(scene,key,48,48,(ctx)=>{
      const px=(x,y,w,h,col)=>{ctx.fillStyle=col;ctx.fillRect(x,y,w,h);};
      px(6,42,36,4,'rgba(0,0,0,0.25)');px(8,16,32,26,opts.base);
      px(6,14,36,4,opts.roof);px(10,10,28,4,opts.roof);
      for(let wy=0;wy<3;wy++)for(let wx=0;wx<3;wx++){
        px(12+wx*10,20+wy*7,6,4,opts.win);px(12+wx*10,20+wy*7,6,1,'rgba(255,255,255,0.18)');
      }
      px(22,32,8,10,opts.door);px(28,37,1,1,'#fbbf24');px(12,6,24,4,opts.sign);
    });
  }
  function makeDecorAndFurnitureTextures(scene){
    const tex=(key,draw)=>addCanvasTexture(scene,key,32,32,draw);
    tex('tree',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(8,26,16,4,'rgba(0,0,0,0.18)');px(14,16,4,10,'#92400e');px(13,20,6,6,'#78350f');
      px(8,8,16,10,'#22c55e');px(10,6,12,4,'#16a34a');px(9,12,14,6,'#4ade80');
    });
    tex('streetLight',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(10,28,12,3,'rgba(0,0,0,0.18)');px(15,8,2,20,'#94a3b8');px(14,26,4,2,'#64748b');
      px(16,10,8,2,'#94a3b8');px(22,10,4,3,'#475569');px(22,13,4,2,'#fbbf24');
    });
    tex('rock',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(9,24,14,4,'rgba(0,0,0,0.18)');px(8,14,16,12,'#9ca3af');px(10,12,12,4,'#6b7280');
    });
    tex('bench',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(6,26,20,3,'rgba(0,0,0,0.18)');px(8,18,3,8,'#78350f');px(21,18,3,8,'#78350f');
      px(7,16,20,3,'#a16207');px(7,14,20,2,'#b45309');px(7,10,20,3,'#92400e');
    });
    tex('vending',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(9,26,14,3,'rgba(0,0,0,0.18)');px(9,8,14,18,'#0ea5e9');px(9,8,14,3,'#0284c7');
      px(11,12,10,7,'#111827');px(19,20,2,4,'#334155');
    });
    tex('vendor',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(6,26,20,3,'rgba(0,0,0,0.18)');px(8,16,16,10,'#f97316');px(7,10,18,3,'#e11d48');
    });
    tex('f_table',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(6,26,20,3,'rgba(0,0,0,0.18)');px(6,16,20,4,'#a16207');
      px(8,20,2,6,'#78350f');px(22,20,2,6,'#78350f');px(7,15,18,2,'#b45309');
    });
    tex('f_bed',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(5,26,22,3,'rgba(0,0,0,0.18)');px(6,16,20,8,'#cbd5e1');
      px(6,14,20,3,'#94a3b8');px(6,24,20,2,'#64748b');px(7,15,6,2,'#e2e8f0');px(15,15,6,2,'#e2e8f0');
    });
    tex('f_tv',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(8,26,16,3,'rgba(0,0,0,0.18)');px(8,10,16,10,'#0f172a');
      px(10,12,12,6,'#111827');px(7,20,18,3,'#334155');px(14,23,4,3,'#475569');
    });
    tex('f_shelf',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(8,26,16,3,'rgba(0,0,0,0.18)');px(8,10,16,14,'#92400e');
      px(9,12,14,2,'#78350f');px(9,16,14,2,'#78350f');px(9,20,14,2,'#78350f');
      px(10,13,2,3,'#ef4444');px(13,13,2,3,'#22c55e');px(16,13,2,3,'#3b82f6');
    });
    // Casino slot machine
    tex('f_slot',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(6,26,20,3,'rgba(0,0,0,0.25)');px(6,8,20,18,'#7c3aed');px(6,8,20,3,'#5b21b6');
      px(9,12,14,8,'#111827');px(10,13,4,6,'#fbbf24');px(15,13,4,6,'#ef4444');px(20,13,1,6,'#22c55e');
      px(14,22,4,2,'#f59e0b');px(13,24,6,2,'#d97706');
    });
    tex('f_roulette',(ctx)=>{const px=(x,y,w,h,c)=>{ctx.fillStyle=c;ctx.fillRect(x,y,w,h);};
      px(6,26,20,3,'rgba(0,0,0,0.25)');px(6,14,20,12,'#166534');px(6,14,20,2,'#14532d');
      ctx.fillStyle='#dc2626';ctx.beginPath();ctx.arc(16,20,6,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#0f172a';ctx.beginPath();ctx.arc(16,20,3,0,Math.PI*2);ctx.fill();
      px(15,8,2,6,'#a16207');
    });
  }

  /* â”€â”€ Buildings â”€â”€ */
  const CITY_BUILDINGS=[
    {key:'School',action:'school',tex:'b_school',texScale:2.2,x:14*TILE,y:10*TILE,w:7*TILE,h:6*TILE,
      texOpts:{base:'#a78bfa',roof:'#7c3aed',door:'#111827',win:'#e9d5ff',sign:'#faf5ff'}},
    {key:'Library',action:'library',tex:'b_library',texScale:2.1,x:26*TILE,y:10*TILE,w:6*TILE,h:6*TILE,
      texOpts:{base:'#6366f1',roof:'#4338ca',door:'#111827',win:'#bfdbfe',sign:'#eef2ff'}},
    {key:'Job Center',action:'work',tex:'b_job',texScale:2.35,x:60*TILE,y:18*TILE,w:8*TILE,h:6*TILE,
      texOpts:{base:'#38bdf8',roof:'#0284c7',door:'#0b1220',win:'#e0f2fe',sign:'#f0f9ff'}},
    {key:'Market',action:'buyApple',tex:'b_market',texScale:2.35,x:40*TILE,y:22*TILE,w:8*TILE,h:6*TILE,
      texOpts:{base:'#f472b6',roof:'#be185d',door:'#111827',win:'#ffe4e6',sign:'#fff1f2'}},
    {key:'Bank',action:'bank',tex:'b_bank',texScale:2.1,x:50*TILE,y:22*TILE,w:6*TILE,h:6*TILE,
      texOpts:{base:'#64748b',roof:'#334155',door:'#0f172a',win:'#e2e8f0',sign:'#f8fafc'}},
    {key:'House',action:'house',tex:'b_house',texScale:2.2,x:14*TILE,y:40*TILE,w:7*TILE,h:6*TILE,
      texOpts:{base:'#fbbf24',roof:'#b45309',door:'#111827',win:'#fef3c7',sign:'#fffbeb'}},
    {key:'Cafe',action:'cafe',tex:'b_cafe',texScale:2.35,x:60*TILE,y:40*TILE,w:8*TILE,h:6*TILE,
      texOpts:{base:'#34d399',roof:'#059669',door:'#0f172a',win:'#d1fae5',sign:'#ecfdf5'}},
    {key:'Gym',action:'gym',tex:'b_gym',texScale:2.1,x:72*TILE,y:40*TILE,w:6*TILE,h:6*TILE,
      texOpts:{base:'#f43f5e',roof:'#9f1239',door:'#111827',win:'#ffe4e6',sign:'#fff1f2'}},
    {key:'Hospital',action:'hospital',tex:'b_hosp',texScale:2.2,x:26*TILE,y:40*TILE,w:7*TILE,h:6*TILE,
      texOpts:{base:'#ef4444',roof:'#991b1b',door:'#111827',win:'#fee2e2',sign:'#fff5f5'}},
    {key:'Casino',action:'casino',tex:'b_casino',texScale:2.35,x:72*TILE,y:18*TILE,w:8*TILE,h:6*TILE,
      texOpts:{base:'#fbbf24',roof:'#b45309',door:'#0f172a',win:'#fef9c3',sign:'#fffde7'}},
  ];
  const CITY_INTERACTABLES=[
    {key:'Vending',action:'vending',tex:'vending',texScale:1.6,x:52*TILE,y:30*TILE,w:2*TILE,h:2*TILE},
    {key:'Street Vendor',action:'vendor',tex:'vendor',texScale:1.7,x:22*TILE,y:32*TILE,w:2*TILE,h:2*TILE},
  ];

  /* â”€â”€ City tiles â”€â”€ */
  const TT={GRASS:0,ROAD:1,WATER:2,SAND:3,SIDE:4,CROSS:5};
  const tileColors={0:0x14532d,1:0x475569,2:0x0ea5e9,3:0xfde68a,4:0x1f2937,5:0xe5e7eb};
  const BLOCKED_TILES=new Set([TT.WATER]);

  function buildCityTiles(){
    const tiles=Array.from({length:CITY_H},()=>Array.from({length:CITY_W},()=>TT.GRASS));
    for(let y=0;y<26;y++){for(let x=70;x<=74;x++)tiles[y][x]=TT.WATER;for(let x=68;x<=76;x++)if(tiles[y][x]!==TT.WATER)tiles[y][x]=TT.SAND;}
    const roadH=[12,28,44],roadV=[18,54,80];
    for(const y of roadH)for(let x=0;x<CITY_W;x++)tiles[y][x]=TT.ROAD;
    for(const x of roadV)for(let y=0;y<CITY_H;y++)tiles[y][x]=TT.ROAD;
    for(let x=8;x<=CITY_W-8;x++){tiles[8][x]=TT.ROAD;tiles[CITY_H-8][x]=TT.ROAD;}
    for(let y=8;y<=CITY_H-8;y++){tiles[y][8]=TT.ROAD;tiles[y][CITY_W-8]=TT.ROAD;}
    for(let x=10;x<=30;x++)tiles[36][x]=TT.ROAD;
    for(let y=30;y<=48;y++)tiles[y][30]=TT.ROAD;
    for(let x=58;x<=88;x++)tiles[36][x]=TT.ROAD;
    for(let y=18;y<=36;y++)tiles[y][66]=TT.ROAD;
    for(let y=0;y<CITY_H;y++)for(let x=0;x<CITY_W;x++)if(tiles[y][x]===TT.ROAD){
      for(let oy=-1;oy<=1;oy++)for(let ox=-1;ox<=1;ox++){const ny=y+oy,nx=x+ox;if(ny<0||nx<0||ny>=CITY_H||nx>=CITY_W)continue;if(tiles[ny][nx]===TT.GRASS)tiles[ny][nx]=TT.SIDE;}
    }
    for(const y of roadH)for(const x of roadV){
      for(let i=-2;i<=2;i++){const x2=x+i;if(y>=0&&y<CITY_H&&x2>=0&&x2<CITY_W)tiles[y][x2]=(i%2===0)?TT.CROSS:TT.ROAD;}
    }
    for(let x=70;x<=74;x++){tiles[12][x]=TT.ROAD;tiles[28][x]=TT.ROAD;}
    return tiles;
  }

  function isBlockedAtWorldXY(x,y,tiles){
    const tx=Math.floor(x/TILE),ty=Math.floor(y/TILE);
    if(tx<0||ty<0||tx>=CITY_W||ty>=CITY_H)return true;
    return BLOCKED_TILES.has(tiles[ty][tx]);
  }

  /* â”€â”€ Interior â”€â”€ */
  const IT={FLOOR_WOOD:0,FLOOR_TILE:1,WALL_BRICK:2,WALL_PLASTER:3,RUG:4,COUNTER:5};
  const interiorPal={
    [IT.FLOOR_WOOD]:[0x8b5a2b,0x7c4a22],[IT.FLOOR_TILE]:[0x94a3b8,0x64748b],
    [IT.WALL_BRICK]:[0xb91c1c,0x7f1d1d],[IT.WALL_PLASTER]:[0xe2e8f0,0x94a3b8],
    [IT.RUG]:[0x2563eb,0x1d4ed8],[IT.COUNTER]:[0x475569,0x334155]
  };

  function makeInterior(kind){
    const w=INT_W,h=INT_H;
    const baseFloor=(kind==='House'||kind==='Cafe'||kind==='Casino')?IT.FLOOR_WOOD:IT.FLOOR_TILE;
    const baseWall=(kind==='Hospital')?IT.WALL_PLASTER:IT.WALL_BRICK;
    const grid=Array.from({length:h},()=>Array.from({length:w},()=>baseFloor));
    for(let x=0;x<w;x++){grid[0][x]=baseWall;grid[h-1][x]=baseWall;}
    for(let y=0;y<h;y++){grid[y][0]=baseWall;grid[y][w-1]=baseWall;}
    const exitX=Math.floor(w/2);
    grid[h-1][exitX]=baseFloor;
    for(let y=h-2;y>=2;y--)grid[y][exitX]=IT.RUG;
    const placeRect=(x0,y0,ww,hh,t)=>{for(let y=y0;y<y0+hh;y++)for(let x=x0;x<x0+ww;x++){if(y<=0||x<=0||y>=h-1||x>=w-1)continue;grid[y][x]=t;}};

    if(kind==='House'){placeRect(3,3,10,6,IT.RUG);placeRect(16,3,14,4,IT.COUNTER);placeRect(4,12,8,5,IT.COUNTER);}
    else if(kind==='School'){placeRect(4,4,26,2,IT.COUNTER);for(let r=0;r<3;r++)placeRect(6,8+r*3,22,1,IT.RUG);}
    else if(kind==='Cafe'){placeRect(4,4,26,2,IT.COUNTER);placeRect(6,8,6,2,IT.RUG);placeRect(16,8,6,2,IT.RUG);}
    else if(kind==='Market'){for(let a=0;a<4;a++)placeRect(5+a*7,5,3,12,IT.COUNTER);placeRect(6,18,22,2,IT.RUG);}
    else if(kind==='Gym'){placeRect(5,5,8,3,IT.COUNTER);placeRect(18,5,10,3,IT.COUNTER);placeRect(8,11,18,2,IT.RUG);}
    else if(kind==='Hospital'){placeRect(5,5,10,2,IT.COUNTER);placeRect(5,9,10,2,IT.COUNTER);placeRect(18,5,10,2,IT.COUNTER);placeRect(18,9,10,2,IT.COUNTER);}
    else if(kind==='Library'){for(let a=0;a<3;a++)placeRect(4,4+a*5,26,2,IT.COUNTER);placeRect(10,16,14,2,IT.RUG);}
    else if(kind==='Bank'){placeRect(4,4,26,2,IT.COUNTER);placeRect(4,8,26,2,IT.COUNTER);placeRect(10,13,14,3,IT.RUG);}
    else if(kind==='Job Center'){placeRect(4,4,26,2,IT.COUNTER);placeRect(6,10,8,2,IT.RUG);placeRect(18,10,8,2,IT.RUG);}
    else if(kind==='Casino'){
      // Casino: dark floor with rug sections for game tables
      placeRect(4,4,8,3,IT.RUG);placeRect(14,4,8,3,IT.RUG);placeRect(24,4,6,3,IT.RUG);
      placeRect(4,10,8,3,IT.RUG);placeRect(14,10,8,3,IT.RUG);placeRect(24,10,6,3,IT.RUG);
      placeRect(6,16,22,2,IT.COUNTER);
    }
    return{grid,exitX,exitY:h-1,title:kind};
  }

  function drawInteriorTiles(scene,interior,container){
    const g=scene.add.graphics().setDepth(-3);
    for(let y=0;y<INT_H;y++)for(let x=0;x<INT_W;x++){
      const t=interior.grid[y][x];const[c1,c2]=interiorPal[t]||[0x0f172a,0x111827];
      g.fillStyle(c1,1);g.fillRect(x*TILE,y*TILE,TILE,TILE);
      if(t===IT.FLOOR_TILE){g.fillStyle(((x+y)%2===0)?c2:c1,0.6);g.fillRect(x*TILE+2,y*TILE+2,TILE-4,TILE-4);}
      else if(t===IT.FLOOR_WOOD){g.fillStyle(c2,0.35);g.fillRect(x*TILE+2,y*TILE+6,TILE-4,2);g.fillRect(x*TILE+2,y*TILE+18,TILE-4,2);}
      else if(t===IT.RUG){g.fillStyle(0xffffff,0.08);g.fillRect(x*TILE+6,y*TILE+6,2,2);g.fillRect(x*TILE+22,y*TILE+18,2,2);}
      else if(t===IT.COUNTER){g.fillStyle(0xffffff,0.10);g.fillRect(x*TILE+3,y*TILE+3,TILE-6,3);}
      else if(t===IT.WALL_BRICK){g.fillStyle(c2,0.35);g.fillRect(x*TILE+2,y*TILE+10,TILE-4,2);g.fillRect(x*TILE+6,y*TILE+20,TILE-12,2);}
    }
    container.add(g);
    container.add(scene.add.text((INT_W*TILE)/2,10,interior.title,{fontSize:'18px',color:'#e2e8f0',fontStyle:'bold',backgroundColor:'rgba(0,0,0,0.35)',padding:{x:8,y:4}}).setOrigin(0.5,0).setDepth(50));
    const exitX=(interior.exitX+0.5)*TILE,exitY=(interior.exitY+0.5)*TILE;
    container.add(scene.add.text(exitX,exitY-8,'EXIT',{fontSize:'14px',color:'#0b1020',fontStyle:'bold',backgroundColor:'rgba(251,191,36,0.9)',padding:{x:6,y:3}}).setOrigin(0.5,1).setDepth(55));
  }

  function addInteriorFurniture(scene,interior,container){
    const add=(tx,ty,key,scale=1.1,depth=20)=>{
      const spr=scene.add.image((tx+0.5)*TILE,(ty+0.5)*TILE,key).setScale(scale).setDepth(depth);
      container.add(spr);return spr;
    };
    if(interior.title==='Casino'){
      // Slot machines and roulette tables
      add(5,4,'f_slot',1.2);add(8,4,'f_slot',1.2);add(11,4,'f_slot',1.2);
      add(15,4,'f_roulette',1.3);add(18,4,'f_roulette',1.3);
      add(25,4,'f_slot',1.2);add(28,4,'f_slot',1.2);
      add(5,10,'f_roulette',1.3);add(9,10,'f_roulette',1.3);
      add(15,10,'f_slot',1.2);add(19,10,'f_slot',1.2);add(23,10,'f_slot',1.2);
      add(25,10,'f_roulette',1.3);add(28,10,'f_roulette',1.3);
      add(14,17,'f_tv',1.2);add(18,17,'f_tv',1.2);
      return;
    }
    add(3,3,'f_shelf',1.1);add(7,6,'f_table',1.1);
    switch(interior.title){
      case 'House':add(5,14,'f_bed',1.25);add(18,6,'f_tv',1.15);add(26,6,'f_shelf',1.1);break;
      case 'Cafe':add(10,9,'f_table',1.1);add(20,9,'f_table',1.1);add(6,4,'f_tv',1.05);break;
      case 'School':add(16,5,'f_table',1.15);add(28,4,'f_shelf',1.05);break;
      case 'Library':add(8,6,'f_shelf',1.2);add(12,6,'f_shelf',1.2);add(16,6,'f_shelf',1.2);add(20,6,'f_shelf',1.2);add(14,16,'f_table',1.15);break;
      case 'Hospital':add(6,6,'f_bed',1.15);add(6,10,'f_bed',1.15);add(22,6,'f_bed',1.15);add(22,10,'f_bed',1.15);break;
      case 'Bank':add(10,14,'f_table',1.15);add(22,14,'f_table',1.15);break;
      case 'Job Center':add(10,10,'f_table',1.15);add(22,10,'f_table',1.15);break;
      case 'Market':add(6,6,'f_shelf',1.2);add(13,6,'f_shelf',1.2);add(20,6,'f_shelf',1.2);add(16,18,'f_table',1.1);break;
      case 'Gym':add(10,6,'f_table',1.05);add(22,6,'f_table',1.05);add(16,12,'f_tv',1.05);break;
    }
  }

  /* â”€â”€ Actions â”€â”€ */
  const requireStamina=(cost,msg)=>{if(myState.stamina<cost){logLine(msg||'[info] Low stamina.');return false;}myState.stamina-=cost;return true;};
  function doAction(action){
    const t=Date.now();
    switch(action){
      case 'school':
        if(t-myState.lastSchoolAt<5000)return logLine('[School] Cooldown 5s.');
        if(myState.edu==='Graduated')return logLine('[School] Already graduated.');
        if(!requireStamina(12,'[School] Low stamina.'))return;
        myState.lastSchoolAt=t;myState.edu='Studying...';updateHUD();logLine('[School] Started studying...');
        setTimeout(()=>{myState.edu='Graduated';myState.job='Available';updateHUD();logLine('[School] Graduated! Job unlocked.');},1500);return;
      case 'library':
        if(myState.edu==='Graduated')return logLine('[Library] Already graduated.');
        if(!requireStamina(8,'[Library] Low stamina.'))return;
        myState.edu='Graduated';myState.job='Available';updateHUD();logLine('[Library] Graduated via fast-track!');return;
      case 'work':
        if(myState.job!=='Available')return logLine('[Job Center] Locked. Graduate first.');
        if(t-myState.lastWorkAt<3000)return logLine('[Job Center] Cooldown 3s.');
        if(!requireStamina(16,'[Job Center] Low stamina.'))return;
        myState.lastWorkAt=t;const earned=10+Math.floor(Math.random()*11);myState.coins+=earned;
        updateHUD();logLine(`[Job Center] Work done! +${earned} coins.`);return;
      case 'house':{const cost=25*myState.house;if(myState.coins<cost)return logLine(`[House] Need ${cost} coins.`);myState.coins-=cost;myState.house+=1;myState.staminaMax+=5;myState.stamina=clamp(myState.stamina+10,0,myState.staminaMax);updateHUD();logLine(`[House] Upgraded to Lv${myState.house}.`);return;}
      case 'cafe':if(myState.coins<5)return logLine('[Cafe] Need 5 coins.');myState.coins-=5;myState.stamina=clamp(myState.stamina+40,0,myState.staminaMax);updateHUD();logLine('[Cafe] Stamina restored.');return;
      case 'gym':if(myState.coins<12)return logLine('[Gym] Need 12 coins.');if(!requireStamina(18,'[Gym] Low stamina.'))return;myState.coins-=12;myState.staminaMax+=8;myState.stamina=clamp(myState.stamina+5,0,myState.staminaMax);updateHUD();logLine('[Gym] StaminaMax +8.');return;
      case 'hospital':if(myState.coins<15)return logLine('[Hospital] Need 15 coins.');myState.coins-=15;myState.stamina=myState.staminaMax;updateHUD();logLine('[Hospital] Full heal.');return;
      case 'buyApple':if(myState.coins<3)return logLine('[Market] Need 3 coins.');myState.coins-=3;myState.inv.apple+=1;updateHUD();logLine('[Market] Apple +1.');return;
      case 'eatApple':if(myState.inv.apple<=0)return logLine('[Inventory] No apples.');myState.inv.apple-=1;myState.stamina=clamp(myState.stamina+28,0,myState.staminaMax);updateHUD();logLine('[Inventory] Ate apple.');return;
      case 'drinkSoda':if(myState.inv.soda<=0)return logLine('[Inventory] No soda.');myState.inv.soda-=1;myState.stamina=clamp(myState.stamina+20,0,myState.staminaMax);updateHUD();logLine('[Inventory] Drank soda.');return;
      case 'eatSandwich':if(myState.inv.sandwich<=0)return logLine('[Inventory] No sandwich.');myState.inv.sandwich-=1;myState.stamina=clamp(myState.stamina+35,0,myState.staminaMax);updateHUD();logLine('[Inventory] Ate sandwich.');return;
      case 'vending':logLine('[Vending] Type: buy soda / buy sandwich');return;
      case 'vendor':if(myState.coins<4)return logLine('[Vendor] Need 4 coins.');myState.coins-=4;if(Math.random()<0.55)myState.inv.soda+=1;else myState.inv.sandwich+=1;updateHUD();logLine('[Vendor] Got random item.');return;
      case 'bank':logLine('[Bank] USDC integration coming soon.');return;
      case 'casino':logLine('[Casino] Welcome! Check the Multiplier Game in the panel â†’');return;
    }
  }

  function nearestCityPOI(px,py){
    let best=null,bestD=Infinity;
    for(const b of CITY_BUILDINGS){const cx=b.x+b.w/2,cy=b.y+b.h/2,d=Math.hypot(px-cx,py-cy);if(d<bestD){bestD=d;best=b;}}
    for(const i of CITY_INTERACTABLES){const cx=i.x+i.w/2,cy=i.y+i.h/2,d=Math.hypot(px-cx,py-cy);if(d<bestD){bestD=d;best=i;}}
    return{poi:best,d:bestD};
  }

  /* â”€â”€ Day/Night â”€â”€ */
  let nightOverlay=null,lampGlows=[];
  function updateDayNight(dtS){
    clock.minutes=(clock.minutes+clock.speed*dtS)%(24*60);
    const m=clock.minutes;
    const lerp=(a,b,t)=>a+(b-a)*t;
    let tod='Day',darkness=0.08;
    if(m>=20*60||m<5*60){tod='Night';darkness=0.62;}
    else if(m>=5*60&&m<6.5*60){tod='Dawn';darkness=lerp(0.62,0.12,(m-5*60)/(1.5*60));}
    else if(m>=6.5*60&&m<17.5*60){tod='Day';darkness=0.08;}
    else{tod='Sunset';darkness=lerp(0.12,0.62,(m-17.5*60)/(2.5*60));}
    elTod.textContent=tod;elTimeTxt.textContent=formatTime(m);
    const glowAlpha=(tod==='Night')?0.22:(tod==='Sunset'||tod==='Dawn')?0.14:0.06;
    for(const g of lampGlows)g.setAlpha(glowAlpha);
    if(nightOverlay)nightOverlay.setAlpha(darkness);
  }

  /* â”€â”€ World render â”€â”€ */
  let cityTiles=null,interior=null,worldContainer=null;
  function clearWorld(scene){if(worldContainer)worldContainer.destroy(true);worldContainer=scene.add.container(0,0);lampGlows=[];}

  function decorateCity(scene,tiles,container){
    for(let y=0;y<CITY_H;y++)for(let x=0;x<CITY_W;x++){
      if(tiles[y][x]!==TT.SIDE)continue;
      const px=x*TILE+TILE/2,py=y*TILE+TILE/2;
      let inLot=false;
      for(const b of CITY_BUILDINGS)if(px>=b.x&&px<=b.x+b.w&&py>=b.y&&py<=b.y+b.h){inLot=true;break;}
      if(!inLot)for(const i of CITY_INTERACTABLES)if(px>=i.x&&px<=i.x+i.w&&py>=i.y&&py<=i.y+i.h){inLot=true;break;}
      if(inLot)continue;
      const n=(x*83492791^y*29765723)>>>0;
      if(n%13===0)container.add(scene.add.image(px,py,'tree').setScale(1.35).setDepth(1));
      else if(n%17===0)container.add(scene.add.image(px,py,'rock').setScale(1.2).setDepth(1));
      else if(n%29===0)container.add(scene.add.image(px,py,'bench').setScale(1.2).setDepth(1));
    }
    const mainRoadY=[12,28,44,8,CITY_H-8],mainRoadX=[18,54,80,8,CITY_W-8];
    const placeLamp=(tx,ty)=>{
      const x=tx*TILE+TILE/2,y=ty*TILE+TILE/2;
      container.add(scene.add.image(x,y,'streetLight').setScale(1.25).setDepth(1.2));
      const glow=scene.add.circle(x+6,y-8,14,0xfbbf24,0.06).setDepth(1.1);
      container.add(glow);lampGlows.push(glow);
    };
    for(const ry of mainRoadY)for(let x=10;x<CITY_W-10;x+=6){
      for(const c of [{tx:x,ty:ry-1},{tx:x,ty:ry+1}]){if(c.ty<0||c.ty>=CITY_H)continue;if(tiles[c.ty][c.tx]!==TT.SIDE)continue;placeLamp(c.tx,c.ty);break;}
    }
    for(const rx of mainRoadX)for(let y=10;y<CITY_H-10;y+=6){
      for(const c of [{tx:rx-1,ty:y},{tx:rx+1,ty:y}]){if(c.tx<0||c.tx>=CITY_W)continue;if(tiles[c.ty][c.tx]!==TT.SIDE)continue;placeLamp(c.tx,c.ty);break;}
    }
  }

  function drawCity(scene){
    clearWorld(scene);cityTiles=buildCityTiles();
    const g=scene.add.graphics().setDepth(-3);
    for(let y=0;y<CITY_H;y++)for(let x=0;x<CITY_W;x++){g.fillStyle(tileColors[cityTiles[y][x]],1);g.fillRect(x*TILE,y*TILE,TILE,TILE);}
    worldContainer.add(g);
    decorateCity(scene,cityTiles,worldContainer);
    for(const b of CITY_BUILDINGS){
      const cx=b.x+b.w/2,cy=b.y+b.h/2;
      worldContainer.add(scene.add.image(cx,cy,b.tex).setScale(b.texScale).setDepth(3));
      worldContainer.add(scene.add.text(cx,b.y-8,b.key,{fontSize:'13px',color:'#e2e8f0',fontStyle:'bold',backgroundColor:'rgba(0,0,0,0.35)',padding:{x:6,y:3}}).setOrigin(0.5,1).setDepth(4));
    }
    for(const i of CITY_INTERACTABLES){
      const cx=i.x+i.w/2,cy=i.y+i.h/2;
      worldContainer.add(scene.add.image(cx,cy,i.tex).setScale(i.texScale).setDepth(3));
      worldContainer.add(scene.add.text(cx,i.y-8,i.key,{fontSize:'12px',color:'#e2e8f0',backgroundColor:'rgba(0,0,0,0.35)',padding:{x:6,y:3}}).setOrigin(0.5,1).setDepth(4));
    }
    scene.cameras.main.setBounds(0,0,CITY_W*TILE,CITY_H*TILE);
    drawMinimap._key=null;
  }

  function drawInterior(scene,buildingKey){
    clearWorld(scene);interior=makeInterior(buildingKey);
    drawInteriorTiles(scene,interior,worldContainer);
    addInteriorFurniture(scene,interior,worldContainer);
    scene.cameras.main.setBounds(0,0,INT_W*TILE,INT_H*TILE);
    drawMinimap._key=null;
  }

  function enterBuilding(scene,buildingKey){
    worldState.savedCityPos={x:scene.me.x,y:scene.me.y};
    worldState.zone='INTERIOR';worldState.interiorKey=buildingKey;
    mmTargetTxt.textContent='Target: -';
    drawInterior(scene,buildingKey);
    scene.me.x=(interior.exitX+0.5)*TILE;
    scene.me.y=(INT_H-3)*TILE;
    updateHUD();logLine(`[system] Entered: ${buildingKey}. Press E at EXIT to leave.`);
    if(buildingKey==='Casino')initMultiplierGame();
  }

  function exitToCity(scene){
    worldState.zone='CITY';worldState.interiorKey='';interior=null;
    stopMultiplierGame();
    drawCity(scene);
    scene.me.x=worldState.savedCityPos.x;scene.me.y=worldState.savedCityPos.y;
    updateHUD();logLine('[system] Back to CITY.');
  }

  /* â”€â”€ Minimap â”€â”€ */
  function worldToMinimap(x,y){
    const wPx=(worldState.zone==='CITY'?CITY_W:INT_W)*TILE;
    const hPx=(worldState.zone==='CITY'?CITY_H:INT_H)*TILE;
    return{mx:(x/wPx)*mmCanvas.width,my:(y/hPx)*mmCanvas.height};
  }
  function drawMinimap(playerPos){
    const cacheKey=worldState.zone==='CITY'?'CITY':'INT:'+worldState.interiorKey;
    if(drawMinimap._key!==cacheKey){
      drawMinimap._key=cacheKey;
      const bg=document.createElement('canvas');bg.width=mmCanvas.width;bg.height=mmCanvas.height;
      const ictx=bg.getContext('2d');
      if(worldState.zone==='CITY'){
        for(let y=0;y<mmCanvas.height;y++)for(let x=0;x<mmCanvas.width;x++){
          const tx=Math.floor((x/mmCanvas.width)*CITY_W),ty=Math.floor((y/mmCanvas.height)*CITY_H);
          const t=cityTiles[ty][tx];
          let col='#1f7a3a';
          if(t===TT.ROAD||t===TT.CROSS)col='#64748b';else if(t===TT.SIDE)col='#334155';else if(t===TT.WATER)col='#0284c7';else if(t===TT.SAND)col='#fde68a';
          ictx.fillStyle=col;ictx.fillRect(x,y,1,1);
        }
      } else {
        for(let y=0;y<mmCanvas.height;y++)for(let x=0;x<mmCanvas.width;x++){
          const tx=Math.floor((x/mmCanvas.width)*INT_W),ty=Math.floor((y/mmCanvas.height)*INT_H);
          const t=interior.grid[ty][tx];
          let col='#1f2937';
          if(t===IT.FLOOR_WOOD)col='#8b5a2b';else if(t===IT.FLOOR_TILE)col='#94a3b8';else if(t===IT.WALL_BRICK)col='#7f1d1d';else if(t===IT.RUG)col='#1d4ed8';else if(t===IT.COUNTER)col='#475569';
          ictx.fillStyle=col;ictx.fillRect(x,y,1,1);
        }
      }
      drawMinimap._bg=bg;
    }
    mmCtx.clearRect(0,0,mmCanvas.width,mmCanvas.height);
    mmCtx.drawImage(drawMinimap._bg,0,0);
    if(worldState.zone==='CITY'&&nav.targetPos){
      const t=worldToMinimap(nav.targetPos.x,nav.targetPos.y);
      mmCtx.fillStyle='#ef4444';mmCtx.fillRect((t.mx-2)|0,(t.my-2)|0,5,5);
    }
    const p=worldToMinimap(playerPos.x,playerPos.y);
    mmCtx.fillStyle='#22c55e';mmCtx.beginPath();mmCtx.arc(p.mx,p.my,3,0,Math.PI*2);mmCtx.fill();
  }

  /* â”€â”€ Nav dropdown â”€â”€ */
  function populateNavDropdown(){
    CITY_BUILDINGS.forEach(b=>{const opt=document.createElement('option');opt.value=b.key;opt.textContent=b.key;navTargetSel.appendChild(opt);});
    CITY_INTERACTABLES.forEach(i=>{const opt=document.createElement('option');opt.value=i.key;opt.textContent=i.key;navTargetSel.appendChild(opt);});
  }
  function setTargetByKey(key){
    if(!key){nav.targetKey='';nav.targetPos=null;mmTargetTxt.textContent='Target: -';return;}
    const all=[];
    CITY_BUILDINGS.forEach(b=>all.push({key:b.key,x:b.x+b.w/2,y:b.y+b.h/2}));
    CITY_INTERACTABLES.forEach(i=>all.push({key:i.key,x:i.x+i.w/2,y:i.y+i.h/2}));
    const found=all.find(t=>t.key===key);if(!found)return;
    nav.targetKey=key;nav.targetPos={x:found.x,y:found.y};
    mmTargetTxt.textContent='Target: '+key;logLine('[nav] Target: '+key);
  }
  document.getElementById('setTarget').onclick=()=>{if(worldState.zone!=='CITY')return logLine('[nav] Target only in CITY.');setTargetByKey(navTargetSel.value);};
  document.getElementById('clearTarget').onclick=()=>{navTargetSel.value='';setTargetByKey('');};

  /* â”€â”€ Chat â”€â”€ */
  document.getElementById('send').onclick=()=>{
    const input=document.getElementById('chat');const text=input.value.trim();if(!text)return;
    const lower=text.toLowerCase();
    if(lower==='buy soda'){if(myState.coins<4)logLine('[Vending] Need 4 coins.');else{myState.coins-=4;myState.inv.soda+=1;updateHUD();logLine('[Vending] Soda +1 (-4)');}}
    else if(lower==='buy sandwich'){if(myState.coins<7)logLine('[Vending] Need 7 coins.');else{myState.coins-=7;myState.inv.sandwich+=1;updateHUD();logLine('[Vending] Sandwich +1 (-7)');}}
    else{logLine('[YOU] '+text);}
    input.value='';
  };
  document.getElementById('chat').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('send').click();});
  document.getElementById('eatApple').onclick=()=>doAction('eatApple');
  document.getElementById('drinkSoda').onclick=()=>doAction('drinkSoda');
  document.getElementById('eatSandwich').onclick=()=>doAction('eatSandwich');

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MULTIPLIER GAME (Crash-style, multi-player)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const MUL_NAMES=['TigerCat','PlumeFan','MogaWhale','CryptoFox','NeonRider','StarBull','DeepSea','GoldMask','SkyPanda','NightOwl','MoonWolf','IceBear','FireFly','DarkHorse','LuckyDragon'];
  const MUL_MAX_BOTS=8;

  let mulState={
    running:false, countdown:0, multiplier:1.0, crashAt:1.0,
    myBet:0, myJoined:false, myCashedOut:false, myWon:false,
    round:0, bots:[], graphPoints:[], phase:'waiting',
    tickInterval:null, countdownInterval:null, botInterval:null
  };

  const mulCanv=document.getElementById('mulGraph');
  const mulCtx2=mulCanv.getContext('2d');
  const elMulNum=document.getElementById('mulNum');
  const elMulState=document.getElementById('mulState');
  const elMulRound=document.getElementById('mulRound');
  const elMulPlayers=document.getElementById('mulPlayers');
  const btnJoin=document.getElementById('mulJoin');
  const btnCash=document.getElementById('mulCash');
  const inBet=document.getElementById('mulBet');

  function generateCrashAt(){
    // House edge ~5%. 1/r gives expected crash, bias toward <3x
    const r=Math.random();
    if(r<0.4)return 1.0+Math.random()*0.8;  // 40% crash under 1.8x
    if(r<0.7)return 1.8+Math.random()*1.5;  // 30% crash 1.8â€“3.3x
    if(r<0.88)return 3.3+Math.random()*3;   // 18% crash 3.3â€“6.3x
    if(r<0.96)return 6.3+Math.random()*8;   // 8% crash 6.3â€“14x
    return 14+Math.random()*36;              // 4% big crash
  }

  function generateBots(){
    const count=3+Math.floor(Math.random()*(MUL_MAX_BOTS-2));
    const bots=[];
    for(let i=0;i<count;i++){
      const name=MUL_NAMES[Math.floor(Math.random()*MUL_NAMES.length)];
      const bet=5+Math.floor(Math.random()*46);
      const targetMul=1.1+Math.random()*4; // bots aim for 1.1â€“5.1x
      bots.push({name,bet,targetMul,cashedOut:false,lost:false,cashMul:0});
    }
    return bots;
  }

  function renderMulPlayers(){
    let html='';
    if(mulState.myJoined&&!mulState.myCashedOut&&!mulState.myWon&&mulState.running){
      const me=walletAddress?walletAddress.slice(0,6)+'...'+walletAddress.slice(-4):'You';
      html+=`<div class="p-row"><span class="p-playing">â–¶ ${me}</span><span>${mulState.myBet}c @ ${mulState.multiplier.toFixed(2)}x</span></div>`;
    } else if(mulState.myJoined&&(mulState.myCashedOut||mulState.myWon)){
      const me=walletAddress?walletAddress.slice(0,6)+'...'+walletAddress.slice(-4):'You';
      const mul=mulState.myCashedOut?mulState.cashMul:(mulState.running?mulState.multiplier:mulState.multiplier);
      html+=`<div class="p-row"><span class="p-cashed">âœ“ ${me}</span><span>${Math.floor(mulState.myBet*mul)}c</span></div>`;
    }
    for(const b of mulState.bots){
      if(b.cashedOut){html+=`<div class="p-row"><span class="p-cashed">âœ“ ${b.name}</span><span>${Math.floor(b.bet*b.cashMul)}c @ ${b.cashMul.toFixed(2)}x</span></div>`;}
      else if(b.lost){html+=`<div class="p-row p-lost"><span>âœ— ${b.name}</span><span>-${b.bet}c</span></div>`;}
      else{html+=`<div class="p-row"><span class="p-playing">â–¶ ${b.name}</span><span>${b.bet}c</span></div>`;}
    }
    elMulPlayers.innerHTML=html;
  }

  function renderMulGraph(){
    const w=mulCanv.width,h=mulCanv.height;
    mulCtx2.clearRect(0,0,w,h);
    mulCtx2.fillStyle='#0f172a';mulCtx2.fillRect(0,0,w,h);
    if(mulState.graphPoints.length<2)return;
    // Scale: x = time (0â€“maxIdx), y = multiplier (1 at bottom, maxMul at top)
    const pts=mulState.graphPoints;
    const maxMul=Math.max(2,pts[pts.length-1]+0.5);
    const toX=(i)=>(i/Math.max(pts.length-1,1))*w;
    const toY=(m)=>h-((m-1)/(maxMul-1))*(h-8)-4;
    const crashed=mulState.phase==='crashed';
    mulCtx2.beginPath();mulCtx2.moveTo(toX(0),toY(pts[0]));
    for(let i=1;i<pts.length;i++)mulCtx2.lineTo(toX(i),toY(pts[i]));
    mulCtx2.strokeStyle=crashed?'#ef4444':'#22c55e';mulCtx2.lineWidth=2;mulCtx2.stroke();
    // Fill under curve
    mulCtx2.lineTo(toX(pts.length-1),h);mulCtx2.lineTo(0,h);mulCtx2.closePath();
    mulCtx2.fillStyle=crashed?'rgba(239,68,68,0.12)':'rgba(34,197,94,0.12)';mulCtx2.fill();
  }

  let mulTickMs=100; // tick every 100ms
  function startMultiplierRound(){
    mulState.round++;mulState.multiplier=1.0;mulState.crashAt=generateCrashAt();
    mulState.graphPoints=[1.0];mulState.phase='running';mulState.running=true;
    mulState.bots=generateBots();mulState.myJoined=false;mulState.myCashedOut=false;mulState.myWon=false;
    elMulRound.textContent=`Round ${mulState.round}`;
    elMulState.textContent='ğŸš€ Running... Cash out before crash!';
    elMulNum.className='mul-num mul-green';
    btnJoin.disabled=false;btnCash.disabled=true;
    logLine(`[Casino] Round ${mulState.round} started! Crash target: ${mulState.crashAt.toFixed(2)}x`);
    renderMulPlayers();

    mulState.tickInterval=setInterval(()=>{
      if(!mulState.running)return;
      // Grow multiplier (exponential-like)
      mulState.multiplier+=mulState.multiplier*0.008+0.003;
      mulState.graphPoints.push(mulState.multiplier);

      // Bot auto-cashout
      for(const b of mulState.bots){
        if(!b.cashedOut&&!b.lost&&mulState.multiplier>=b.targetMul){
          b.cashedOut=true;b.cashMul=mulState.multiplier;
          logLine(`[Casino] ${b.name} cashed out @ ${b.cashMul.toFixed(2)}x (+${Math.floor(b.bet*b.cashMul)})`);
        }
      }

      elMulNum.textContent=mulState.multiplier.toFixed(2)+'x';
      renderMulGraph();renderMulPlayers();

      if(mulState.multiplier>=mulState.crashAt){
        crashRound();
      }
    },mulTickMs);
  }

  function crashRound(){
    clearInterval(mulState.tickInterval);
    mulState.running=false;mulState.phase='crashed';
    const crashedAt=mulState.multiplier.toFixed(2);
    elMulNum.textContent=`ğŸ’¥ ${crashedAt}x`;elMulNum.className='mul-num mul-red';
    elMulState.textContent=`CRASHED @ ${crashedAt}x!`;
    btnCash.disabled=true;btnJoin.disabled=true;

    // Mark all remaining bots as lost
    for(const b of mulState.bots)if(!b.cashedOut)b.lost=true;

    // Player result
    if(mulState.myJoined&&!mulState.myCashedOut){
      myState.coins-=mulState.myBet;
      updateHUD();logLine(`[Casino] ğŸ’¥ CRASH @ ${crashedAt}x! Lost ${mulState.myBet} coins.`);
    }
    renderMulGraph();renderMulPlayers();
    logLine(`[Casino] Next round in 5s...`);

    // Schedule next round
    let cd=5;
    mulState.countdownInterval=setInterval(()=>{
      cd--;
      elMulState.textContent=`Next round in ${cd}s...`;
      if(cd<=0){
        clearInterval(mulState.countdownInterval);
        startMultiplierRound();
      }
    },1000);
  }

  function mulJoin(){
    if(!mulState.running){return logLine('[Casino] Wait for next round.');}
    if(mulState.myJoined){return logLine('[Casino] Already joined.');}
    const bet=parseInt(inBet.value)||10;
    if(bet<5)return logLine('[Casino] Min bet is 5 coins.');
    if(myState.coins<bet)return logLine('[Casino] Not enough coins.');
    mulState.myBet=bet;mulState.myJoined=true;
    btnJoin.disabled=true;btnCash.disabled=false;
    logLine(`[Casino] Joined round ${mulState.round} with ${bet} coins bet.`);
    renderMulPlayers();
  }

  function mulCashOut(){
    if(!mulState.running||!mulState.myJoined||mulState.myCashedOut)return;
    mulState.myCashedOut=true;mulState.cashMul=mulState.multiplier;
    const winnings=Math.floor(mulState.myBet*mulState.cashMul);
    const profit=winnings-mulState.myBet;
    myState.coins+=winnings;
    updateHUD();
    elMulNum.className='mul-num mul-yellow';
    logLine(`[Casino] Cashed out @ ${mulState.cashMul.toFixed(2)}x! +${winnings} coins (profit: ${profit}).`);
    btnCash.disabled=true;renderMulPlayers();
  }

  function stopMultiplierGame(){
    clearInterval(mulState.tickInterval);clearInterval(mulState.countdownInterval);clearInterval(mulState.botInterval);
    mulState.running=false;mulState.phase='stopped';
  }

  function initMultiplierGame(){
    stopMultiplierGame();
    mulState.round=0;
    // Brief intro countdown
    elMulState.textContent='Starting in 3s...';
    elMulNum.textContent='--';
    btnJoin.disabled=true;btnCash.disabled=true;
    let cd=3;
    mulState.countdownInterval=setInterval(()=>{
      cd--;elMulState.textContent=`Starting in ${cd}s...`;
      if(cd<=0){clearInterval(mulState.countdownInterval);startMultiplierRound();}
    },1000);
  }

  btnJoin.onclick=mulJoin;
  btnCash.onclick=mulCashOut;

  /* â”€â”€ Phaser â”€â”€ */
  const config={
    type:Phaser.AUTO, parent:'game',
    width:Math.max(400,window.innerWidth-340), height:Math.max(300,window.innerHeight),
    backgroundColor:'#0b1020', pixelArt:true,
    scene:{
      preload(){
        loading.textContent='Loading assets...';
        makeOrangeCatTexture(this);makeDecorAndFurnitureTextures(this);
        for(const b of CITY_BUILDINGS)makeBuildingTexture(this,b.tex,b.texOpts);
      },
      create(){
        loading.style.display='none';
        this.me=this.add.container(32*TILE,32*TILE).setDepth(10);
        this.me.add([this.add.image(0,0,'orangeCat').setScale(2.0).setOrigin(0.5,0.62),
                     this.add.text(-26,-54,'YOU',{fontSize:'13px',color:'#a5f3fc',fontStyle:'bold'})]);
        this.cameras.main.startFollow(this.me,true,0.12,0.12);
        this.cameras.main.setZoom(1.3);
        this.cursors=this.input.keyboard.createCursorKeys();
        this.keys=this.input.keyboard.addKeys('W,A,S,D,SHIFT,E');
        drawCity(this);populateNavDropdown();updateHUD();
        logLine('[system] Welcome to Moga World! ğŸ® Enter Casino for Multiplier Game.');
        nightOverlay=this.add.rectangle(0,0,this.scale.width,this.scale.height,0x020617,1).setOrigin(0,0).setScrollFactor(0).setDepth(999);
        nightOverlay.setAlpha(0.08);
        this.scale.on('resize',(sz)=>{if(nightOverlay){nightOverlay.width=sz.width;nightOverlay.height=sz.height;}});
        this.time.addEvent({delay:200,loop:true,callback:()=>{
          if(worldState.zone==='CITY'){
            const{poi,d}=nearestCityPOI(this.me.x,this.me.y);
            elNear.textContent=(poi&&d<INTERACT_DIST)?`${poi.key} (E)`:'-';
          } else {
            const ex=(interior.exitX+0.5)*TILE,ey=(interior.exitY+0.5)*TILE;
            const dd=Math.hypot(this.me.x-ex,this.me.y-ey);
            elNear.textContent=dd<120?'EXIT (E)':`${worldState.interiorKey} (E)`;
          }
        }});
      },
      update(_,dt){
        const dtS=dt/1000;updateDayNight(dtS);
        const sprinting=this.keys.SHIFT.isDown&&myState.stamina>0;
        const speed=sprinting?380:240;
        let vx=0,vy=0;
        if(this.cursors.up.isDown||this.keys.W.isDown)vy-=1;
        if(this.cursors.down.isDown||this.keys.S.isDown)vy+=1;
        if(this.cursors.left.isDown||this.keys.A.isDown)vx-=1;
        if(this.cursors.right.isDown||this.keys.D.isDown)vx+=1;
        if(vx!==0&&vy!==0){const inv=0.7071;vx*=inv;vy*=inv;}
        const moving=(vx!==0||vy!==0);
        const nx=this.me.x+vx*speed*dtS,ny=this.me.y+vy*speed*dtS;
        if(worldState.zone==='CITY'){
          const cx=clamp(nx,20,CITY_W*TILE-20),cy=clamp(ny,20,CITY_H*TILE-20);
          if(!isBlockedAtWorldXY(cx,cy,cityTiles)){this.me.x=cx;this.me.y=cy;}
          else{if(!isBlockedAtWorldXY(cx,this.me.y,cityTiles))this.me.x=cx;if(!isBlockedAtWorldXY(this.me.x,cy,cityTiles))this.me.y=cy;}
        } else {
          this.me.x=clamp(nx,20,INT_W*TILE-20);this.me.y=clamp(ny,20,INT_H*TILE-20);
        }
        if(sprinting&&moving)myState.stamina-=22*dtS;else myState.stamina+=11*dtS;
        if(Phaser.Input.Keyboard.JustDown(this.keys.E)){
          if(worldState.zone==='CITY'){
            const{poi,d}=nearestCityPOI(this.me.x,this.me.y);
            if(!poi||d>=INTERACT_DIST){logLine('[info] Nothing nearby.');}
            else{const isBuilding=!!CITY_BUILDINGS.find(b=>b.key===poi.key);if(isBuilding)enterBuilding(this,poi.key);else doAction(poi.action);}
          } else {
            const ex=(interior.exitX+0.5)*TILE,ey=(interior.exitY+0.5)*TILE;
            const dd=Math.hypot(this.me.x-ex,this.me.y-ey);
            if(dd<120)exitToCity(this);else{const b=CITY_BUILDINGS.find(b=>b.key===worldState.interiorKey);if(b)doAction(b.action);}
          }
        }
        updateHUD();drawMinimap({x:this.me.x,y:this.me.y});
      }
    }
  };

  const game=new Phaser.Game(config);
  window.addEventListener('resize',()=>{
    const w=Math.max(400,window.innerWidth-340),h=Math.max(300,window.innerHeight);
    game.scale.resize(w,h);
  });
  updateHUD();
})();
</script>
</body>
</html>
